var na=Object.defineProperty;var ni=(o,e,t)=>e in o?na(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var m=(o,e)=>na(o,"name",{value:e,configurable:!0});var O=(o,e,t)=>(ni(o,typeof e!="symbol"?e+"":e,t),t);function ra(){Hooks.on("getImagePopoutHeaderButtons",(o,e)=>{e.unshift({class:"posttochat",icon:"fas fa-comment",onclick:async()=>ri(o)})})}m(ra,"initImagePopoutTochat");async function ri(o){let e=o.object,t=await renderTemplate("systems/dsk/templates/chat/imagetochat.html",{image:e});ChatMessage.create(h.chatDataSetup(t))}m(ri,"postImage");function oa(o){let e=o.currentTarget.dataset;h.showArtwork(e,!1)}m(oa,"showPopout");var A={};A.statusEffects=[{img:"icons/svg/skull.svg",id:"dead",name:"dsk.CONDITION.defeated",label:"dsk.CONDITION.defeated",description:"dsk.CONDITIONDESCRIPTION.defeated",flags:{dsk:{value:null}}},{id:"inpain",name:"dsk.CONDITION.inpain",img:"icons/svg/blood.svg",description:"dsk.CONDITIONDESCRIPTION.inpain",changes:[{key:"system.status.inpain",mode:2,value:1}],flags:{dsk:{value:1,max:8}}},{id:"encumbered",name:"dsk.CONDITION.encumbered",img:"icons/svg/anchor.svg",description:"dsk.CONDITIONDESCRIPTION.encumbered",changes:[{key:"system.status.encumbered",mode:2,value:1}],flags:{dsk:{value:1,max:8}}},{id:"stunned",name:"dsk.CONDITION.stunned",img:"icons/svg/daze.svg",description:"dsk.CONDITIONDESCRIPTION.stunned",changes:[{key:"system.status.stunned",mode:2,value:1}],flags:{dsk:{value:1,max:8}}},{id:"feared",name:"dsk.CONDITION.feared",img:"icons/svg/terror.svg",description:"dsk.CONDITIONDESCRIPTION.feared",changes:[{key:"system.status.feared",mode:2,value:1}],flags:{dsk:{value:1,max:8}}},{id:"selfconfidence",name:"dsk.CONDITION.selfconfidence",img:"icons/svg/up.svg",description:"dsk.CONDITIONDESCRIPTION.selfconfidence",changes:[{key:"system.status.selfconfidence",mode:2,value:1}],flags:{dsk:{value:1,max:8}}},{id:"prone",name:"dsk.CONDITION.prone",img:"icons/svg/falling.svg",description:"dsk.CONDITIONDESCRIPTION.prone",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500},{key:"system.meleeStats.attack",mode:2,value:-4},{key:"system.rangeStats.attack",mode:2,value:-4},{key:"system.meleeStats.parry",mode:2,value:-2}],flags:{dsk:{value:null}}},{id:"rooted",name:"dsk.CONDITION.rooted",img:"icons/svg/net.svg",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500}],description:"dsk.CONDITIONDESCRIPTION.rooted",flags:{dsk:{value:null}}},{id:"unconscious",name:"dsk.CONDITION.unconscious",img:"icons/svg/unconscious.svg",description:"dsk.CONDITIONDESCRIPTION.unconscious",flags:{dsk:{value:null}}},{id:"blind",name:"dsk.CONDITION.blind",img:"icons/svg/blind.svg",description:"dsk.CONDITIONDESCRIPTION.blind",changes:[{key:"system.meleeStats.attack",mode:2,value:-8},{key:"system.rangeStats.attack",mode:2,value:-100},{key:"system.meleeStats.parry",mode:2,value:-100}],flags:{dsk:{value:null}}},{id:"constricted",name:"dsk.CONDITION.constricted",img:"icons/svg/cave.svg",description:"dsk.CONDITIONDESCRIPTION.constricted",flags:{dsk:{value:null}}},{id:"fixated",name:"dsk.CONDITION.fixated",img:"icons/svg/padlock.svg",description:"dsk.CONDITIONDESCRIPTION.fixated",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500},{key:"system.meleeStats.parry",mode:2,value:-2}],flags:{dsk:{value:null}}},{id:"hallucinating",name:"dsk.CONDITION.hallucinating",img:"icons/svg/padlock.svg",description:"dsk.CONDITIONDESCRIPTION.hallucinating",flags:{dsk:{value:null}}},{id:"incapacitated",name:"dsk.CONDITION.incapacitated",img:"icons/svg/sleep.svg",description:"dsk.CONDITIONDESCRIPTION.incapacitated",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500}],flags:{dsk:{value:null}}},{id:"panic",name:"dsk.CONDITION.panic",img:"icons/svg/terror.svg",description:"dsk.CONDITIONDESCRIPTION.panic",flags:{dsk:{value:null}}},{id:"bloodrush",name:"dsk.CONDITION.rage",img:"icons/svg/bones.svg",description:"dsk.CONDITIONDESCRIPTION.rage",changes:[{key:"system.meleeStats.attack",mode:2,value:4},{key:"system.meleeStats.parry",mode:2,value:-100},{key:"system.rangeStats.attack",mode:2,value:-100}],flags:{dsk:{value:null}}},{id:"mute",name:"dsk.CONDITION.mute",img:"icons/svg/silenced.svg",description:"dsk.CONDITIONDESCRIPTION.mute",flags:{dsk:{value:null}}},{id:"deaf",name:"dsk.CONDITION.deaf",img:"icons/svg/deaf.svg",description:"dsk.CONDITIONDESCRIPTION.deaf",changes:[{key:"system.skillModifiers.step",mode:0,value:"Sinnessch\xE4rfe -4;Perception -4"}],flags:{dsk:{value:null}}},{id:"surprised",name:"dsk.CONDITION.surprised",img:"icons/svg/hazard.svg",description:"dsk.CONDITIONDESCRIPTION.surprised",changes:[{key:"system.meleeStats.parry",mode:2,value:-100}],flags:{dsk:{value:null}}},{id:"invisible",name:"dsk.CONDITION.invisible",img:"icons/svg/circle.svg",description:"dsk.CONDITIONDESCRIPTION.invisible",flags:{dsk:{value:null}}},{id:"poisoned",name:"dsk.CONDITION.poisoned",img:"icons/svg/poison.svg",description:"dsk.CONDITIONDESCRIPTION.poisoned",flags:{dsk:{value:null}}}];A.StFs={A:"A",B:"B",C:"C",D:"D",E:"E"};A.journalFontSizes=[8,10,12,14,16,18,20,24,28,32];A.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /ah [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk sinnessch\xE4rfe"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq bet\xF6ren"},{name:"twoD20Check",command:"/ch",example:"/ch"}];A.meleeRangeVision=()=>({"+0":"dsk.meleeVisionDisruption.0","-1":"dsk.meleeVisionDisruption.1","-2":"dsk.meleeVisionDisruption.2","-3":"dsk.meleeVisionDisruption.3","-5000":"dsk.meleeVisionDisruption.4"});A.addvantageRules={};A.removevantageRules={};A.vantagesNeedingAdaption={};A.addAbilityRules={};A.removeAbilityRules={};A.AbilitiesNeedingAdaption={};A.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[5,5,5,5,5,5,5,5,5,5,5,5,5,10,15,20,25,30,35,40,45,50,55,60,65,70],Eig:[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,40,60,80,100,120,140,160,180,200,220,240]};A.specialAbilityCategories={general:"dsk.SPECIALABILITYCATEGORIES.general",Combat:"dsk.SPECIALABILITYCATEGORIES.combat",ahnen:"dsk.SPECIALABILITYCATEGORIES.ahnen",language:"dsk.SPECIALABILITYCATEGORIES.language"};A.shieldSizes={short:"dsk.SIZE.small",medium:"dsk.SIZE.average",long:"dsk.SIZE.big"};A.combatSkillSubCategories={0:"dsk.COMBATSKILLCATEGORY.0",1:"dsk.COMBATSKILLCATEGORY.1",2:"dsk.COMBATSKILLCATEGORY.2",3:"dsk.COMBATSKILLCATEGORY.3",4:"dsk.COMBATSKILLCATEGORY.4"};A.gearModifyableCalculatedAttributes=["schips","ini","gs","AeP","LeP","sk","zk"];A.rangeWeaponModifiers={short:"dsk.RangeMod.short",medium:"dsk.RangeMod.medium",long:"dsk.RangeMod.long",rangesense:"dsk.RangeMod.rangesense",extreme:"dsk.RangeMod.extreme"};A.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}};A.regnerationCampLocations={0:"dsk.regnerationCampLocations.normal","-1":"dsk.regnerationCampLocations.bad",1:"dsk.regnerationCampLocations.good"};A.regenerationInterruptOptions={0:"dsk.regenerationInterruptOptions.none","-1":"dsk.regenerationInterruptOptions.small","-2":"dsk.regenerationInterruptOptions.big"};A.equipmentCategories=["meleeweapon","rangeweapon","equipment","ammunition","armor","poison"];A.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8};A.aimOptions={0:"dsk.aimOptions.0",2:"dsk.aimOptions.1",4:"dsk.aimOptions.2"};A.rangeVision={0:"dsk.VisionDisruption.step0","-2":"dsk.VisionDisruption.step1","-4":"dsk.VisionDisruption.step2","-6":"dsk.VisionDisruption.step3","-5000":"dsk.VisionDisruption.step4"};A.targetMomevementOptions={0:"dsk.rangeMovementOptions.SLOW","-2":"dsk.rangeMovementOptions.FAST",2:"dsk.rangeMovementOptions.STATIONARY"};A.shooterMovementOptions={0:"dsk.rangeMovementOptions.SHOOTERSTATIONARY","-2":"dsk.rangeMovementOptions.SHOOTERMOVING","-4":"dsk.rangeMovementOptions.SHOOTERRUNNING"};A.mountedRangeOptions={0:"dsk.mountedRangeOptions.STATIONARY","-4":"dsk.mountedRangeOptions.SCHRITT","-8":"dsk.mountedRangeOptions.GALOPP"};A.rangeSizeCategories={tiny:"dsk.RANGESIZE.tiny",small:"dsk.RANGESIZE.small",average:"dsk.RANGESIZE.average",big:"dsk.RANGESIZE.big",giant:"dsk.RANGESIZE.giant"},A.meleeSizeCategories={tiny:"dsk.MELEESIZE.tiny",small:"dsk.MELEESIZE.small",average:"dsk.MELEESIZE.average",big:"dsk.MELEESIZE.big",giant:"dsk.MELEESIZE.giant"};A.narrowSpaceModifiers={weaponshort:{attack:2,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:0,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-2,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:0,parry:2,label:"dsk.NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:0,parry:0,label:"dsk.NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-2,parry:-2,label:"dsk.NarrowSpaceModifiers.shield.long"}};A.meleeSizeModifier={tiny:-4,small:0,average:0,big:0,giant:0};A.sizeCategories={tiny:"dsk.SIZE.tiny",small:"dsk.SIZE.small",average:"dsk.SIZE.average",big:"dsk.SIZE.big",giant:"dsk.SIZE.giant"};A.equipmentTypes={misc:"dsk.Equipment.misc",clothes:"dsk.Equipment.clothes",tools:"dsk.Equipment.tools",light:"dsk.Equipment.light",healing:"dsk.Equipment.healing",bags:"dsk.Equipment.bags",wealth:"dsk.Equipment.wealth",writing:"dsk.Equipment.writing",alchemy:"dsk.Equipment.alchemy",service:"dsk.Equipment.service",luxus:"dsk.Equipment.luxus",blessed:"dsk.Equipment.blessed",food:"dsk.Equipment.food",animals:"dsk.Equipment.animals"};A.systemTables=[{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}},{name:"Ahnen",attrs:"",roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}}];A.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4};A.effectTextStyle=CONFIG.canvasTextStyle.clone();A.effectTextStyle.fontSize="30";A.effectTextStyle.fontFamily="GentiumBasic";A.ammunitiongroups={"-":"-",arrow:"dsk.ammunition.arrow",bolt:"dsk.ammunition.bolt",bullet:"dsk.ammunition.bullet",stone:"dsk.ammunition.stone",dart:"dsk.ammunition.dart",mag:"dsk.ammunition.mag",infinite:"dsk.ammunition.infinite"};A.traitCategories={meleeAttack:"dsk.closeCombatAttacks",rangeAttack:"dsk.rangeCombatAttacks",armor:"TYPES.Item.armor",force:"dsk.force",specialty:"dsk.specialty"};A.meleeRanges={short:"dsk.Range.short",medium:"dsk.Range.medium",long:"dsk.Range.long"};A.magicResistanceModifiers={"-":"-",sk:"dsk.soulpower",zk:"dsk.toughness"};A.weapontypes={melee:"TYPES.Item.meleeweapon",range:"TYPES.Item.rangeweapon"};A.characteristics={mu:"dsk.characteristics.mu.name",kl:"dsk.characteristics.kl.name",in:"dsk.characteristics.in.name",ch:"dsk.characteristics.ch.name",ff:"dsk.characteristics.ff.name",ge:"dsk.characteristics.ge.name",ko:"dsk.characteristics.ko.name",kk:"dsk.characteristics.kk.name"};A.skillBurdens={yes:"dsk.yes",no:"dsk.no",maybe:"dsk.maybe"};A.skillDifficultyLabels={eeasy:"dsk.Skill-eeasy",veasy:"dsk.Skill-veasy",easy:"dsk.Skill-easy",challenging:"dsk.Skill-challenging",difficult:"dsk.Skill-difficult",hard:"dsk.Skill-hard",vhard:"dsk.Skill-vhard"};A.skillDifficultyModifiers={eeasy:16,veasy:8,easy:4,challenging:0,difficult:-4,hard:-8,vhard:-16};A.skillGroups={body:"dsk.SKILL.body",social:"dsk.SKILL.social",knowledge:"dsk.SKILL.knowledge",trade:"dsk.SKILL.trade"};CONFIG.time.roundTime=2;CONFIG.time.turnTime=0;var w=A;var{mergeObject:oi}=foundry.utils;async function li(){if(!game.settings.get("dsk","defaultConfigFinished")){console.log("Configuring default token settings");let o=game.settings.get("core","defaultToken");o.displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,o.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,o.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,o.bar1={attribute:"status.wounds"},await game.settings.set("core","defaultToken",o),await game.settings.set("core","leftClickRelease",!0),await game.settings.set("dsk","defaultConfigFinished",!0)}}m(li,"setupDefaulTokenConfig");async function ci(o,e){await lt(),await game.settings.set("dsk","migrationVersion",e)}m(ci,"migrateDSK");async function lt(){let e=await(await fetch("systems/dsk/lazy/updatenotes.json")).json();new bt(e).render(!0)}m(lt,"showPatchViewer");function js(){Hooks.once("ready",async function(){if(!game.user.isGM)return;await li();let o=await game.settings.get("dsk","migrationVersion"),e=27;o<e&&ci(o,e)})}m(js,"migrateWorld");var bt=class extends Application{constructor(e,t){super(t),this.json=e}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],oi(e,{classes:e.classes.concat(["dsk","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsk/templates/system/patchviewer.html",e.resizable=!0,e}async getData(){let e=this.json.notes[this.json.notes.length-1],t=this.json.default.replace(/VERSION/g,e.version),s=`<h1>CHANGELOG</h1><p>${t}. </br><b>Important updates</b>: ${e.text}</p><p>For details or proposals visit our github page at <a href="https://github.com/Plushtoast/dsk-foundryVT" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>`;await ChatMessage.create(h.chatDataSetup(s,"roll"));let a=game.i18n.lang,i=await renderTemplate(`systems/dsk/lazy/patchhtml/changelog_${a}_${e.version}.html`),n=await renderTemplate(`systems/dsk/lazy/patchhtml/news_${a}_${e.version}.html`),r=[this.json.notes[this.json.notes.length-2]].filter(f=>f!=null),l=r.length>0,c=l?await Promise.all(r.map(async f=>await renderTemplate(`systems/dsk/lazy/patchhtml/changelog_${a}_${f.version}.html`))):[],u=l?await Promise.all(r.map(async f=>await renderTemplate(`systems/dsk/lazy/patchhtml/news_${a}_${f.version}.html`))):[],d=await renderTemplate(`systems/dsk/lazy/patchhtml/modules_${a}.html`);return{patchName:t,changelog:i,news:n,prevVersions:r,prevChangeLogs:c,prevNews:u,modules:d}}};m(bt,"PatchViewer");var{duplicate:di}=foundry.utils,qs=class{static simpleAdoption(e,t,s,a){if(a[s].activeEffect){let i=di(a[s].activeEffect);i.value=`${t.name} ${i.value}`;let n={changes:[i],duration:{},img:"icons/svg/aura.svg",label:`${s} (${t.name})`,transfer:!0,flags:{dsk:{value:null,editable:!0,description:`${s} (${t.name})`,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(n)}}static reverseAdoptionCalculation(e,t,s){let a=[w.vantagesNeedingAdaption,w.AbilitiesNeedingAdaption];for(let i of a)if(i[t.name]){let n=e.items.find(r=>i[t.name].items.includes(r.type)&&r.name==t.special);n&&(s.system.ap=s.system.ap.split("/")[n.system.StF.charCodeAt(0)-65],qs.simpleAdoption(s,n,t.name,i));break}return s}static hasItem(e,t,s){return e.items.find(a=>s.includes(a.type)&&a.name==t)!=null}static itemStep(e,t,s){let a=e.items.find(i=>s.includes(i.type)&&i.name==t);return a?Number(a.system.level):0}static itemAsModifier(e,t,s,a,i=!1,n=!1){let r=[],l=i?new RegExp(`^${h.escapeRegex(`${t} (`)}`):new RegExp(`^${h.escapeRegex(t)}$`),c=e.items.find(u=>a.includes(u.type)&&l.test(u.name));return c&&r.push({name:c.name,value:Number(c.system.level)*s,selected:n,source:c.name}),r}},j=qs;m(j,"ItemRulesDSK"),O(j,"children",{});var{duplicate:la}=foundry.utils,z=class extends j{static setupFunctions(){}static async abilityAdded(e,t){w.addAbilityRules[t.name]&&w.addAbilityRules[t.name](e,t)}static async abilityRemoved(e,t){w.removeAbilityRules[t.name]&&w.removeAbilityRules[t.name](e,t);let s=t.system.ap*t.system.level;if(/;/.test(t.system.ap)){let a=t.system.ap.split(";").map(i=>Number(i.trim()));s=0;for(let i=0;i<t.system.level;i++)s+=a[i]}await e._updateAPs(-1*s)}static async _specialabilityReturnFunction(e,t,s,a){if(t==null)return;if(t=la(t),a!=null){if(/,/.test(t.system.ap)){let n=`${t.name.replace(" ()","")} (${a.name}`;t.system.ap=t.system.ap.split(",")[e.items.filter(r=>r.type==t.type&&r.name.includes(n)).length].trim()}z.simpleAdoption(t,a,t.name,w.AbilitiesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${a.name}${a.customEntry?", "+a.customEntry:""})`,a.data&&a.system.StF&&/\//.test(t.system.ap)&&(t.system.ap=t.system.ap.split("/")[a.system.StF.charCodeAt(0)-65].trim())}let i=e.items.find(n=>n.type==s&&n.name==t.name);if(i){let n=la(i),r=/;/.test(n.system.ap)?n.system.ap.split(";").map(l=>Number(l.trim()))[n.system.level]:n.system.ap;n.system.level+1<=n.system.max&&await e.checkEnoughXP(r)&&(n.system.level+=1,await e._updateAPs(r,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[n]),await z.abilityAdded(e,n))}else{let n=t.system.ap.split(";").map(r=>r.trim())[0];await e.checkEnoughXP(n)&&(await z.abilityAdded(e,t),await e._updateAPs(n,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}}static async needsAdoption(e,t,s){let a=w.AbilitiesNeedingAdaption[t.name];if(a){let i,n;if(a.items=="text")i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-string-dialog.html",{original:t}),n=m(function(r){let l={name:r.find('[name="entryselection"]').val()};z._specialabilityReturnFunction(e,t,s,l)},"callback");else if(a.items=="array"){let r=a.elems.map(l=>({name:l}));i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:r,original:t,area:a.area}),n=m(function(l){let c=r.find(u=>u.name==l.find('[name="entryselection"]').val());z._specialabilityReturnFunction(e,t,s,c)},"callback")}else{let r=e.items.filter(l=>a.items.includes(l.type)).sort((l,c)=>l.name.localeCompare(c.name));i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:r,original:t,area:a.area}),n=m(function(l){let c=r.find(u=>u.name==l.find('[name="entryselection"]').val());c.customEntry=l.find('[name="custom"]').val(),z._specialabilityReturnFunction(e,t,s,c)},"callback")}await new Dialog({title:game.i18n.localize("dsk.DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:n},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}else z._specialabilityReturnFunction(e,t,s,null)}static hasAbility(e,t){return super.hasItem(e,t,["specialability"])}static abilityStep(e,t){return super.itemStep(e,t,["specialability"])}static abilityAsModifier(e,t,s=1,a=!1){return super.itemAsModifier(e,t,s,["specialability"],a)}};m(z,"SpecialabilityRulesDSK");j.children.SpecialabilityRulesDSK=z;var{getProperty:ca,mergeObject:da,setProperty:mi}=foundry.utils,R=class{static _getFunctionData(e){return{data:e.currentTarget.dataset,actor:h.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}static multipleDefenseValue(e,t){let s=-2;return ca(t,"system.combatskill")==game.i18n.localize("dsk.LocalizedIDs.wrestle")&&z.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.masterfulDodge"))?s=-2:z.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.mightyMasterfulParry"))?s=-1:z.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.masterfulParry"))&&(s=-2),Math.min(0,s)}static isYieldedTwohanded(e){let t=this.regex2h.test(e.name),s=e.system.worn.wrongGrip;return t&&!s||!t&&s}static obfuscateDropData(e,t){if(t)for(let s of t)da(e,{system:{obfuscation:{[s]:!0}}})}static _buildDuration(e){let t={duration:{startTime:game.time.worldTime,rounds:e,seconds:e*5}};return game.combat&&da(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}static increment(e,t,s,a=void 0){let i=e.ctrlKey?10:1,n=e.button==2?-1:1,r=ca(t,s)+i*n;a!=null&&(r=Math.max(a,r)),mi(t,s,r)}};m(R,"RuleChaos"),O(R,"regex2h",/\(2H/);var{duplicate:fi}=foundry.utils,H=class{static chatListeners(e){e.on("click",".openJournalBrowser",()=>game.dsk.apps.journalBrowser.render(!0));let t=$('<a class="button showHelp" data-tooltip="dsk.HELP.showHelp"><i class="fas fa-question"></i></a>');t.click(()=>{H.getHelp()}),$(e.find(".control-buttons")).prepend(t),e.on("click",".showPatchViewer",()=>lt()),e.on("click",".functionswitch",s=>R[s.currentTarget.dataset.function](s)),e.on("click",".panToToken",s=>H.panToToken(s)),e.on("click",".popoutImage",s=>oa(s))}static async panToToken(e){let t=await fromUuid(e.currentTarget.dataset.uuid);!t||(canvas.animatePan({x:t.x,y:t.y}),t.isOwner&&t.object.control({releaseOthers:!0}))}static postStatus(e){let t=CONFIG.statusEffects.find(a=>a.id==e),s=`<h2><a class="chat-condition chatButton" data-id="${e}"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="${t.img}"/>${game.i18n.localize(t.name)}</h2></a><p>${game.i18n.localize(t.description)}</p>`;ChatMessage.create(h.chatDataSetup(s,"roll"))}static getHelp(){let e=w.helpContent.map(t=>`<h2>${game.i18n.localize(`dsk.HELP.${t.name}`)}</h2>
            <p><b>${game.i18n.localize("dsk.HELP.command")}</b>: ${t.command}</p>
            <p><b>${game.i18n.localize("dsk.HELP.example")}</b>: ${t.example}</p>
            <p><b>${game.i18n.localize("dsk.description")}</b>: ${game.i18n.localize(`dsk.HELP.descr${t.name}`)}`).join("")+`<br>
            <p>${game.i18n.localize("dsk.HELP.default")}</p>`;ChatMessage.create(h.chatDataSetup(e,"roll"))}static showConditions(){let t=fi(CONFIG.statusEffects).map(s=>(s.name=game.i18n.localize(s.name),s)).sort((s,a)=>s.name.localeCompare(a.name)).map(s=>`<a class="chat-condition chatButton" data-id="${s.id}"><img src="${s.img}"/>${s.name}</a>`).join(" ");ChatMessage.create(h.chatDataSetup(t,"roll"))}static async check3D20(e,t,s={}){let a=12;e?(e=e.get(0),t=await h.skillByName(e.textContent),e.dataset.attrs&&(a=e.dataset.attrs.split("|"))):t&&(t=await h.skillByName(t)),t&&(t=t.toObject()),t||(t={name:"2d20",type:"skill",system:{level:0,characteristic1:"mu",characteristic2:"kl",encumbers:"no"}});let i=await h.emptyActor(a);i.setupSkill(t,s,"emptyActor").then(n=>{i.basicTest(n)})}static async showTables(){let e=await renderTemplate("systems/dsk/templates/tables/systemtables.html",{tables:w.systemTables});ChatMessage.create(h.chatDataSetup(e,"roll"))}};m(H,"DSKChatListeners");var{duplicate:wt,getProperty:ma}=foundry.utils,x=class{static bindButtons(e){e.find(".chat-condition").each(function(t,s){s.setAttribute("draggable",!0),s.addEventListener("dragstart",a=>{let i={data:{type:"condition",payload:{id:$(a.currentTarget).attr("data-id")}}};a.dataTransfer.setData("text/plain",JSON.stringify(i))})}),e.on("click",".chat-condition",t=>H.postStatus($(t.currentTarget).attr("data-id")))}static createCustomEffect(e,t="",s){s=s||game.i18n.localize("dsk.CONDITION.custom"),t==""&&(t=s),e.addCondition({label:s,img:"icons/svg/aura.svg",origin:e.uuid,flags:{dsk:{value:null,description:t}}})}static async addCondition(e,t,s=1,a=!1,i=!0){if(!e.isOwner)return"Not owned";if(e.compendium)return"Can not add in compendium";if(a&&s<1)return this.removeCondition(e,t,s,i,a);if(typeof t=="string"&&(t=wt(CONFIG.statusEffects.find(r=>r.id==t))),!t)return"No Effect Found";let n=this.hasCondition(e,t.id);return n&&n.flags.dsk.value==null?n:n?await x.updateEffect(e,n,s,a,i,t):await x.createEffect(e,t,s,i)}static async createEffect(e,t,s,a){let i=this.immuneToEffect(e,t);if(i)return i;t.name=game.i18n.localize(t.name),a?(t.flags.dsk.auto=Math.min(t.flags.dsk.max,s),t.flags.dsk.manual=0):(t.flags.dsk.manual=Math.min(t.flags.dsk.max,s),t.flags.dsk.auto=0),t.flags.dsk.value=Math.min(4,t.flags.dsk.manual+t.flags.dsk.auto),t.id&&(t.statuses=[t.id]),t.id=="dead"&&(t["flags.core.overlay"]=!0);let n=await e.createEmbeddedDocuments("ActiveEffect",[wt(t)]);return delete t.id,n}static async removeCondition(e,t,s=1,a=!0,i=!1){if(!e.isOwner)return"Not owned";if(typeof t=="string"&&(t=wt(CONFIG.statusEffects.find(r=>r.id==t))),!t)return"No Effect Found";let n=this.hasCondition(e,t.id);if(n&&n.flags.dsk.value==null)return e.token&&(e=e.token.actor),await e.deleteEmbeddedDocuments("ActiveEffect",[n.id]);if(n)return await x.removeEffect(e,n,s,i,a)}static async removeEffect(e,t,s,a,i){let n=i?a?s:Math.max(0,t.flags.dsk.auto-s):t.flags.dsk.auto,r=i?t.flags.dsk.manual:a?s:t.flags.dsk.manual-s,l={flags:{dsk:{auto:n,manual:r,value:Math.max(0,Math.min(t.flags.dsk.max,r+n))}}};return l.flags.dsk.auto<1&&l.flags.dsk.manual==0?await e.deleteEmbeddedDocuments("ActiveEffect",[t.id]):await t.update(l)}static async updateEffect(e,t,s,a,i,n=void 0){let r=this.immuneToEffect(e,t,!0);if(r)return r;let l,c,u;return i?(c=Math.min(t.flags.dsk.max,a?s:t.flags.dsk.auto+s),l=c-t.flags.dsk.auto,u={flags:{dsk:{auto:c,manual:t.flags.dsk.manual}}}):(c=a?s:t.flags.dsk.manual+s,l=c-t.flags.dsk.manual,u={flags:{dsk:{manual:c,auto:t.flags.dsk.auto}}}),l==0||(u.flags.dsk.value=Math.max(0,Math.min(t.flags.dsk.max,u.flags.dsk.manual+u.flags.dsk.auto)),n.duration&&(u.duration=n.duration,u.duration.startTime=game.time.worldTime),await t.update(u)),t}static immuneToEffect(e,t,s=!0){if((ma(e,"system.immunities")||[]).includes(t.id)){let i=game.i18n.format("dsk.DSKError.immuneTo",{name:e.name,condition:game.i18n.localize(`dsk.CONDITION.${t.id}`)});return ui.notifications&&!s&&ui.notifications.warn(i),i}return!1}static resistantToEffect(e,t){let s=[...t.statuses][0];return s?(ma(e,"system.resistances.effects")||[]).reduce((i,n)=>(n.target==s&&(i+=Number(n.value)),i),0):0}static hasCondition(e,t){return e!=null&&t&&e.effects?e.effects.find(s=>s.statuses.has(t)):!1}static prepareActiveEffects(e,t){let s=wt(CONFIG.statusEffects),a=[];t.conditions=[],t.transferedConditions=[];let i;e.documentName=="Item"?i=e.effects:(i=Array.from(e.allApplicableEffects()),game.user.isGM||(i=i.filter(r=>!r.getFlag("dsk","hidePlayers"))));for(let r of i){let l=r.toObject();l.boolean=r.getFlag("dsk","value")==null;let c=[...r.statuses][0];c&&(l.value=r.getFlag("dsk","value"),l.editable=r.getFlag("dsk","editable"),l.descriptor=c,l.manual=r.getFlag("dsk","manual"),a.push(c)),e.documentName=="Item"||r.parent?.documentName!="Item"&&!r.notApplicable?t.conditions.push(l):r.notApplicable||(l.uuid=r.uuid,t.transferedConditions.push(l))}t.manualConditions=s.filter(r=>!a.includes(r.id));let n=[];for(let r of Object.keys(e.system?.status||{}))if(e.system.status[r]){let l=w.statusEffects.find(c=>c.id==r);n.push({img:l.img,id:r,name:game.i18n.localize(l.name),value:e.system.status[r]})}t.cumulativeConditions=n}static calculateRollModifier(e,t,s,a={}){return s.type=="regenerate"?0:-1*(t.system.status[e]||0)}static ModifierIsSelected(e,t={},s){return t.mode!="damage"}static getRollModifiers(e,t,s={}){let a=game.i18n.localize("dsk.status")+"/"+game.i18n.localize("dsk.condition"),i=[];for(let n of Object.keys(e.system.status))if(e.system.status[n]){let r=game.dsk.config.statusEffectClasses[n]||x;i.push({name:game.i18n.localize(`dsk.CONDITION.${n}`),value:r.calculateRollModifier(n,e,t,s),selected:r.ModifierIsSelected(t,s,e),source:a})}return i}};m(x,"DSKStatusEffects");var vt=class extends x{static ModifierIsSelected(e,t={},s){let a=e.type=="skill"&&e.system.encumbers=="yes",i=!["skill","ahnengabe","rangeweapon"].includes(e.type)&&t.mode!="damage";return a||i}static calculateRollModifier(e,t,s,a={}){return s.type=="regenerate"||s.type=="skill"&&s.system.encumbers=="no"?0:super.calculateRollModifier(e,t,s,a)}};m(vt,"EncumberedEffect");var Tt=class extends x{static ModifierIsSelected(e,t={},s){return s.effects.find(a=>Array.from(a.statuses).includes("bloodrush"))==null}};m(Tt,"PainEffect");var St=class extends x{static calculateRollModifier(e,t,s,a={}){return s.type=="regenerate"?0:t.system.status.selfconfidence||0}};m(St,"SelfconfidenceEffect");w.statusEffectClasses={encumbered:vt,inpain:Tt,selfconfidence:St};var{duplicate:ua}=foundry.utils,E=class extends j{static setupFunctions(){}static async vantageAdded(e,t){game.dsk.config.addvantageRules[t.name]&&game.dsk.config.addvantageRules[t.name](e,t)}static async vantageRemoved(e,t){game.dsk.config.removevantageRules[t.name]&&game.dsk.config.removevantageRules[t.name](e,t)}static async _vantageReturnFunction(e,t,s,a){if(t==null)return;if(t=ua(t),/,/.test(t.system.ap)){let n=t.name.replace(" ()","");t.system.ap=t.system.ap.split(",")[e.items.filter(r=>r.type==t.type&&r.name.includes(n)).length].trim()}a!=null&&(E.simpleAdoption(t,a,t.name,w.vantagesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${a.name})`,a.data&&(t.system.ap=t.system.ap.split("/")[a.system.StF.charCodeAt(0)-65].trim()));let i=e.items.find(n=>n.type==s&&n.name==t.name);if(i){let n=ua(i),r=/;/.test(n.system.ap)?n.system.ap.split(";").map(l=>Number(l.trim()))[n.system.level]:n.system.ap;n.system.level+1<=n.system.max&&await e.checkEnoughXP(r)&&(n.system.level+=1,await e._updateAPs(r,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[n]),await E.vantageAdded(e,n))}else await e.checkEnoughXP(t.system.ap.split(";").map(n=>n.trim())[0])&&(await E.vantageAdded(e,t),await e._updateAPs(t.system.ap.split(";").map(n=>n.trim())[0],{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}static async needsAdoption(e,t,s){if(w.vantagesNeedingAdaption[t.name]){let a,i;if(w.vantagesNeedingAdaption[t.name].items=="text")a=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-string-dialog.html",{original:t}),i=m(function(n){let r={name:n.find('[name="entryselection"]').val()};E._vantageReturnFunction(e,t,s,r)},"callback");else{let n=e.items.filter(r=>w.vantagesNeedingAdaption[t.name].items.includes(r.type));a=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:n,original:t}),i=m(function(r){let l=n.find(c=>c.name==r.find('[name="entryselection"]').val());E._vantageReturnFunction(e,t,s,l)},"callback")}await new Dialog({title:game.i18n.localize("dsk.DIALOG.ItemRequiresAdoption"),content:a,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:i},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}else E._vantageReturnFunction(e,t,s,null)}static hasVantage(e,t){return super.hasItem(e,t,["advantage","disadvantage"])}static vantageStep(e,t){return super.itemStep(e,t,["advantage","disadvantage"])}static getVantageAsModifier(e,t,s=1,a=!1,i=!1){return super.itemAsModifier(e,t,s,["advantage","disadvantage"],a,i)}};m(E,"AdvantageRulesDSK");j.children.AdvantageRulesDSK=E;var{getProperty:Ws}=foundry.utils,X=class{static rangeFinder(e,t){let s=canvas.scene.grid.size,i=new Ray(e,t).distance/s,n=i*canvas.scene.grid.distance,r=Math.abs((Ws(e,"document.elevation")||0)-(Ws(t,"document.elevation")||0)),l=Math.hypot(n,r);return{elevation:r,distance:n,distanceSum:l,tileDistance:i,unit:canvas.scene.grid.units}}static inDistance(e){for(let t of canvas.scene.tokens)if(t.isOwner&&this.rangeFinder(e,t.object).tileDistance<=2)return!0;return!1}static distanceModifier(e,t,s){if(!game.settings.get("dsk","enableDPS")||!e)return 1;let a={};for(let i of game.user.targets){let n=X.rangeFinder(e,i);(a.distanceSum||0)<n.distanceSum&&(a=n)}if(a.unit==game.i18n.localize("dsk.gridUnits")){let i=Number(Ws(s,"system.rangeMultiplier"))||1,n=t.system.rw.split("/").map(l=>Number(l)*i),r=0;for(;r<2&&n[r]<a.distanceSum;)r++;return r}else return 1}static initDoorMinDistance(){let e=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(t){return!game.user.isGM&&game.settings.get("dsk","enableDPS")&&!X.inDistance(this)?ui.notifications.warn(game.i18n.localize("dsk.DSKError.notInRangeToLoot")):e.apply(this,arguments)}}};m(X,"DPS");var{mergeObject:pi}=foundry.utils,Ae=class extends Dialog{static async getDialog(e){let t=Array.from(game.user.targets).map(i=>i.id),s=[],a=canvas.scene?canvas.scene.tokens.get(e.token)?.object:void 0;return game.combat&&game.combat.combatants.forEach(i=>{if(!!i.visible){if(i.isSelected=t.includes(i.token.id),a&&i.token){let n=canvas.scene.tokens.get(i.token.id).object;i.distance=X.rangeFinder(a,n),i.distance.distanceSum=Number(i.distance.distanceSum.toFixed(1))}s.push(i)}}),new Ae({title:game.i18n.localize("dsk.DIALOG.addTarget"),content:await renderTemplate("systems/dsk/templates/dialog/addTarget-dialog.html",{selectables:s}),buttons:{}})}activateListeners(e){super.activateListeners(e);let t=e.find(".combatant");t.click(s=>this.setTargets(s)),t.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),t.mousedown(s=>this._onRightClick(s))}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}_getCombatApp(){return game.combats.apps[0]}async setTargets(e){let t=e.originalEvent.shiftKey;t||$(e.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(e.currentTarget).addClass("selectedTarget");let s=e.currentTarget.dataset.combatantId;game.combat.combatants.get(s).token.object.setTarget(!0,{user:game.user,releaseOthers:!t,groupSelection:!0})}};m(Ae,"AddTargetDialog");var _e=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return pi(e,{classes:e.classes.concat(["dsk5Decent"])}),e}static async getDialog(){let e=game.users.filter(t=>t.active&&!t.isGM);return new _e({title:game.i18n.localize("dsk.DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsk/templates/dialog/selectForUserDialog.html",{users:e}),buttons:{}})}static registerButtons(){Hooks.on("getSceneControlButtons",e=>{if(!game.user.isGM)return;let t={name:"targetUser",title:game.i18n.localize("dsk.CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:async()=>{(await _e.getDialog()).render(!0)}};e[0].tools.splice(2,0,t)})}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){let t=Array.from(game.user.targets).map(i=>i.id),s=e.currentTarget.dataset.userId;game.users.get(s).updateTokenTargets(t),game.socket.emit("userActivity",s,{targets:t}),this.close()}};m(_e,"SelectUserDialog");var $e=class extends Dialog{static async getDialog(e){let t=game.users.filter(s=>s.active&&!s.isGM);new $e({title:game.i18n.localize("dsk.SHEET.PostItem"),content:await renderTemplate("systems/dsk/templates/dialog/usermultipickdialog.html",{users:t}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:s=>{this.postContent(s,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}static async postContent(e,t){let s=h.chatDataSetup(t);if(!e.find("#sel_all").is(":checked")){let a=[];e.find(".usersel:checked").each(function(){a.push($(this).val())}),s.whisper=a}ChatMessage.create(s)}activateListeners(e){super.activateListeners(e),e.find('[name="sel_all"]').change(t=>{e.find(".usersel").prop("disabled",t.currentTarget.checked).prop("checked",t.currentTarget.checked)})}};m($e,"UserMultipickDialog");var Ks=class extends Dialog{recallSettings(e,t,s){return this.recallData=game.dsk.memory.recall(e,t,s),this.dialogData={mode:s,speaker:e,source:t},this}async _render(e,t){await super._render(e,t),this.prepareFormRecall($(this._element))}setRollButtonWarning(){return this.dialogData.mode=="attack"?`<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("dsk.DIALOG.noTarget")}</span>`:""}setMultipleTargetsWarning(){return this.dialogData.mode=="attack"?`<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("dsk.DIALOG.multipleTarget")}</span>`:""}renderRollValueDie(){if(this.dialogData.rollValue&&this.dialogData.mode!="damage"){let e=this.dialogData.mode=="attack"?"die-mu":"die-in",t=this.dialogData.modifier||0;return`<span class="rollValue ${e} d20">${this.dialogData.rollValue+t}</span>`}else return""}async updateRollButton(e){let t=this.renderRollValueDie()+game.i18n.localize("dsk.Roll");e.length>0?e.length>1&&(t+=this.setMultipleTargetsWarning()):t+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(t)}async updateTargets(e,t){let s=await renderTemplate("systems/dsk/templates/dialog/parts/targets.html",{targets:t});e.find(".targets").html(s),this.updateRollButton(t)}removeTarget(e){let t=e.currentTarget.dataset.id;$(e.currentTarget).remove();let s=[];game.user.targets.forEach(a=>{t!=a.id&&s.push(a.id)}),game.user.updateTokenTargets(s)}readTargets(){let e=[];return game.user.targets.forEach(t=>{t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})}),e}compareTargets(e,t){let s=this.readTargets();return JSON.stringify(t)!=JSON.stringify(s)&&(t=s,this.updateTargets(e,t)),t}activateListeners(e){super.activateListeners(e),e.find(".quantity-click").mousedown(t=>{let s=t.currentTarget.dataset.quantityfocus,a=$(t.currentTarget);if(s&&!a.is(":focus")){setTimeout(function(){a.select()});return}let i={val:Number(a.val())};R.increment(t,i,"val"),a.val(i.val)}),e.find(".modifiers option").mousedown(t=>(t.preventDefault(),$(t.currentTarget).prop("selected",!$(t.currentTarget).prop("selected")),!1)),e.on("click",".rollTarget",t=>this.removeTarget(t)),e.on("click",".addTarget",t=>this.addTarget(t))}async addTarget(e){(await Ae.getDialog(this.dialogData.speaker)).render(!0)}prepareFormRecall(e){if(this.recallData)for(let t in this.recallData)if(t=="specAbs")for(let s of this.recallData[t]){let a=e.find(`.specAbs[data-id="${s.id}"]`);a.addClass("active").attr("data-step",s.step),a.find(".step").text(Ks.roman[s.step])}else{let s=e.find(`[name="${t}"]`);if(Array.isArray(this.recallData[t])){let a=s.find("option");for(let i of a){let n=this.recallData[t].find(r=>r.name==$(i).text().trim());n&&(i.selected=n.selected)}}else s.attr("type")=="checkbox"?s[0].checked=this.recallData[t]:s.val(this.recallData[t])}}},Q=Ks;m(Q,"DialogShared"),O(Q,"roman",[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"]);var{mergeObject:Us,getProperty:gi}=foundry.utils,se=class extends Q{static get defaultOptions(){let e=super.defaultOptions;return Us(e,{width:700,resizable:!0}),e}activateListeners(e){super.activateListeners(e);let t=e.find(".specAbs");t.mouseenter(i=>{if(i.currentTarget.getElementsByClassName("hovermenu").length==0){let n=document.createElement("div");n.classList.add("hovermenu");let r=document.createElement("i");r.classList.add("fas","fa-comment"),r.title=game.i18n.localize("dsk.SHEET.PostItem"),r.addEventListener("mousedown",this._postItem,!1),n.appendChild(r),i.currentTarget.appendChild(n)}}),t.mouseleave(i=>{let n=i.toElement||i.relatedTarget;n.parentNode==this||n==this||i.currentTarget.querySelectorAll(".hovermenu").forEach(r=>r.remove())}),e.on("mousedown",".specAbs",i=>{if(e.find(".opportunityAttack").is(":checked")){ui.notifications.error(game.i18n.localize("dsk.DSKError.opposedAttackNoSpecAbs"));return}let n=$(i.currentTarget),r=Number(n.attr("data-step")),l=Number(n.attr("data-maxStep")),c=Number(n.attr("data-category"));if(i.button==0){if(r=Math.min(l,r+1),[0,1].includes(c)&&game.settings.get("dsk","limitCombatSpecAbs")){let u=n.siblings(`[data-category="${c}"]`);u.removeClass("active").attr("data-step",0),u.find(".step").text(Q.roman[0])}}else i.button==2&&(r=Math.clamp(l,0,r-1));n.attr("data-step",r),r>0?n.addClass("active"):n.removeClass("active"),n.find(".step").text(Q.roman[r]),this.calculateModifier()}),e.find(".opportunityAttack").change(i=>{if($(i.currentTarget).is(":checked"))for(let n of e.find(".specAbs"))$(n).removeClass("active").attr("data-step",0).find(".step").text("")}),e.on("change","input,select",i=>this.calculateModifier(i)),e.find(".modifiers option").mousedown(i=>{this.calculateModifier(i)}),e.find(".quantity-click").mousedown(i=>this.calculateModifier(i));let s=this.readTargets();this.calculateModifier();let a=this;this.checkTargets=setInterval(function(){s=a.compareTargets(e,s)},500)}async close(e={}){return clearInterval(this.checkTargets),await super.close(e)}_postItem(e){e.stopPropagation();let t=$(e.currentTarget).closest(".specAbs"),s=t.attr("data-actor"),a=t.attr("data-id");return game.actors.get(s).items.get(a).postItem(),!1}recallSettings(e,t,s){return super.recallSettings(e,t,s),this.prepareWeapon(),this}prepareWeapon(){let e,t=this.dialogData.source,s=h.getSpeaker(this.dialogData.speaker);if(s)if(["meleeweapon","rangeweapon"].includes(t.type)){let a=t.system.combatskill,i=D._calculateCombatSkillValues(s.items.find(n=>n.type=="combatskill"&&n.name==a).toObject(),s.system);switch(t.type){case"meleeweapon":e=D._prepareMeleeWeapon(t,[i],s);break;case"rangeweapon":e=D._prepareRangeWeapon(t,[],[i],s);break}this.dialogData.mode=="attack"&&(this.dialogData.rollValue=e.attack)}else this.dialogData.mode=="attack"&&(this.dialogData.rollValue=Number(t.system.at))}prepareFormRecall(e){if(super.prepareFormRecall(e),canvas.scene&&game.settings.get("dsk","sightAutomationEnabled")){let t=canvas.scene?canvas.scene.darkness:0,s=game.settings.get("dsk","sightOptions").split("|").map(r=>Number(r)),a=0;for(;s[a]<=t;)a+=1;let i=h.getSpeaker(this.dialogData.speaker);if(i){let r=E.vantageStep(i,game.i18n.localize("dsk.LocalizedIDs.darksight"))+z.abilityStep(i,game.i18n.localize("dsk.LocalizedIDs.sappeurStyle")),l=z.abilityStep(i,game.i18n.localize("dsk.LocalizedIDs.blindFighting"));a<4&&a>0&&(r>1?a=0:(a=Math.max(0,a-r),a=Math.min(4,a+E.vantageStep(i,game.i18n.localize("dsk.LocalizedIDs.nightBlind"))))),a=Math.max(0,a-l)}let n=e.find(`[name="vision"] option:nth-child(${a+1})`);n.length&&(n[0].selected=!0)}}calculateModifier(){if(this.dialogData.mode=="damage")return;let e=this.dialogData.source,t=e.type=="trait"&&gi(e,"system.traitType")=="meleeAttack"||e.type=="meleeweapon",s={source:this.dialogData.source,extra:{options:{}}},a=h.getSpeaker(this.dialogData.speaker);t?se.resolveMeleeDialog(s,{},this.element,a,{},-2,this.dialogData.mode):se.resolveRangeDialog(s,{},this.element,a,{},this.dialogData.mode,-2),this.dialogData.modifier=_DiceDSK._situationalModifiers(s),this.updateRollButton(this.readTargets())}static resolveMeleeDialog(e,t,s,a,i,n,r){this._resolveDefault(e,t,s,a,i);let l=new FormDataExtended(s.find("form")[0]).object;e.opposingWeaponSize=l.weaponsize,e.narrowSpace=l.narrowSpace,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,l),e.situationalModifiers.push(C.parseValueType(game.i18n.localize("dsk.sight"),l.vision||0),{name:game.i18n.localize("dsk.attackFromBehind"),value:l.attackFromBehind?-4:0},{name:game.i18n.localize("dsk.MODS.damage"),damageBonus:l.damageModifier,value:0,step:1},{name:game.i18n.format("dsk.defenseCount",{malus:-1*n}),dmmalus:(Number(l.defenseCount)||0)*n*-1,value:(Number(l.defenseCount)||0)*n*-1,type:"defenseMalus"},{name:game.i18n.localize("dsk.wrongHand"),value:l.wrongHand?-4:0},{name:game.i18n.localize("dsk.advantageousPosition"),value:l.advantageousPosition?2:0},{name:game.i18n.localize("dsk.sizeCategory"),value:w.meleeSizeModifier[l.size]},...C.getSpecAbModifiers(s,r)),r=="attack"&&e.situationalModifiers.push({name:game.i18n.localize("dsk.doubleAttack"),value:l.doubleAttack?-3+Math.floor(z.abilityStep(a,game.i18n.localize("dsk.LocalizedIDs.twoWeaponCombat"))*1.5):0})}static resolveRangeDialog(e,t,s,a,i,n){this._resolveDefault(e,t,s,a,i);let r=new FormDataExtended(s.find("form")[0]).object;e.rangeModifier=r.distance,e.situationalModifiers.push({name:game.i18n.localize("dsk.target")+" "+s.find('[name="targetMovement"] option:selected').text(),value:Number(r.targetMovement)||0},{name:game.i18n.localize("dsk.shooter")+" "+s.find('[name="shooterMovement"] option:selected').text(),value:Number(r.shooterMovement)||0},{name:game.i18n.localize("dsk.mount")+" "+s.find('[name="mountedOptions"] option:selected').text(),value:Number(r.mountedOptions)||0},{name:game.i18n.format("dsk.defenseCount",{malus:-1*n}),dmmalus:(Number(r.defenseCount)||0)*n*-1,value:(Number(r.defenseCount)||0)*n*-1,type:"defenseMalus"},{name:game.i18n.localize("dsk.rangeMovementOptions.QUICKCHANGE"),value:r.quickChange?-4:0},{name:game.i18n.localize("dsk.MODS.combatTurmoil"),value:r.combatTurmoil?-2:0},{name:game.i18n.localize("dsk.aim"),value:Number(r.aim)||0},{name:game.i18n.localize("dsk.MODS.damage"),damageBonus:r.damageModifier,value:0,step:1},{name:game.i18n.localize("dsk.sight"),value:Number(r.vision||0)},...C.getSpecAbModifiers(s,"attack"),{name:game.i18n.localize("dsk.sizeCategory"),value:w.rangeSizeModifier[r.size]})}static _resolveDefault(e,t,s,a,i){t.rollMode=s.find('[name="rollMode"]').val(),e.situationalModifiers=D._parseModifiers(s),D.schipsModifier(s,e.situationalModifiers),e.vw=s.find('[name="vw"]').val(),Us(e.extra.options,i)}static attackOfOpportunity(e,t){let s=t.opportunityAttack?-8:0;if(s){e.push({name:game.i18n.localize("dsk.opportunityAttack"),value:s});let a=game.i18n.localize("dsk.LocalizedIDs.enemySense");game.user.targets.forEach(i=>{if(i.actor&&i.actor.items.find(n=>n.type=="specialability"&&n.name==a)){e.push({name:a,value:s});return}})}return s!=0}static getRollButtons(e,t,s,a){let i=U.getRollButtons(e,t,s,a);if(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType=="rangeAttack"){let n=e.source.type=="trait"?Number(e.source.system.lz):D.calcLZ(e.source,e.extra.actor),r=e.source.system.reloadTimeprogress;r<n&&Us(i,{reloadButton:{label:`${game.i18n.localize("dsk.WEAPON.reload")} (${r}/${n})`,callback:async()=>{await(await h.getSpeaker(e.extra.speaker)).updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTimeprogress":r+1}]);let c=game.i18n.format("dsk.WEAPON.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${r+1}/${n}`});await ChatMessage.create(h.chatDataSetup(c))}}})}return i}};m(se,"DSKCombatDialog");var{mergeObject:fa}=foundry.utils,Pe=class extends Q{static getRollButtons(e,t,s,a){let i=U.getRollButtons(e,t,s,a);i.rollButton.label=game.i18n.localize("dsk.Opposed");let n={nonOpposedButton:{label:game.i18n.localize("dsk.Roll"),callback:r=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,r),e.opposable=!1,s(t.callback(r))}}};return fa(n,i),n}activateListeners(e){super.activateListeners(e),e.on("change","input,select",a=>this.rememberFormData(a));let t=this.readTargets(),s=this;this.checkTargets=setInterval(function(){t=s.compareTargets(e,t)},500),this.rememberFormData(),e.on("mousedown",".quantity-click",a=>this.rememberFormData(a)),e.find(".modifiers option").mousedown(a=>{this.rememberFormData(a)})}rememberFormData(e){let t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=D._parseModifiers(this._element)}static get defaultOptions(){let e=super.defaultOptions;return fa(e,{width:700,resizable:!0}),e}};m(Pe,"SkillDialogDSK");var{mergeObject:pa,duplicate:hi}=foundry.utils,ct=class extends Q{static get defaultOptions(){let e=super.defaultOptions;return pa(e,{width:700,resizable:!0}),e}prepareFormRecall(e){super.prepareFormRecall(e),e.find(".spellModifier").trigger("change")}static getRollButtons(e,t,s,a){let i=U.getRollButtons(e,t,s,a);if(["spell","liturgy"].includes(e.source.type)){let n=Number(e.source.system.castingTime.value),r=e.source.system.castingTime.progress,l=e.source.system.castingTime.modified;if(n&&e.extra.speaker.token!="emptyActor"){let c=l>0?` (${r}/${l})`:"";pa(i,{reloadButton:{label:`${game.i18n.localize("dsk.SPELL.reload")}${c}`,callback:async u=>{let d=await h.getSpeaker(e.extra.speaker),f={_id:e.source._id,"system.castingTime.progress":r+1};l==0&&(l=Number(u.find(".castingTime").text())-1,f["system.castingTime.modified"]=l),await d.updateEmbeddedDocuments("Item",[f]);let p=game.i18n.format("dsk.SPELL.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${r+1}/${l}`});await ChatMessage.create(h.chatDataSetup(p))}}})}}return i}async recalcSpellModifiers(e,t){let s=e,a=hi(this.dialogData.source),i=s.find(".castingTime"),n=s.find(".aspcost"),r=s.find(".reach"),l=s.find(".maintainCost"),c=s.find(".ritual").length>0,u=s.find(".maxMods");if(s.find(".spellModifier:checked").length>Number(u.text())){t&&(t.currentTarget.checked=!1),u.addClass("emphasize"),setTimeout(function(){u.removeClass("emphasize")},600);return}let d=a.system.AeP,f=a.system.range,p=2,b=d;s.find(".variableBaseCost")[a.system.variableBaseCost=="true"?"show":"hide"]();let T=0;s.find(".spellModifier[data-cost]:checked").each(function(y,v){b=b*(v.value<0?.5:2),T+=Number(v.value)}),b<1?t&&(t.currentTarget.checked=!1):(n.text(b),n.attr("data-mod",T)),T=0,b=p,s.find(".spellModifier[data-castingTime]:checked").each(function(y,v){if(c){let k=ct.bigTimes.indexOf(Number(b));if(k!=null){let I=k+(v.value>0?1:-1);I<ct.bigTimes.length&&I>=0?b=ct.bigTimes[I]:ui.notifications.error(game.i18n.localize("dsk.DSKError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("dsk.DSKError.TimeCannotBeParsed"))}else b=b*(v.value>0?2:.5);T+=Number(v.value)}),b<1?t&&(t.currentTarget.checked=!1):(i.text(b),i.attr("data-mod",T)),T=0;let g=game.i18n.localize("dsk.ReverseSpellRanges."+f);r.text(f),s.find(".spellModifier[data-reach]:checked").each(function(y,v){if(g=="self")v.checked=!1;else if(g=="touch")r.text("4 "+game.i18n.localize("dsk.step")),T+=Number(v.value);else{let k=f.split(" ");g=Number(k[0]),isNaN(g)?(t&&(t.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("dsk.DSKError.RangeCannotBeParsed"))):(r.text(g*2+" "+game.i18n.localize("dsk.step")),T+=Number(v.value))}}),r.attr("data-mod",T),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}activateListeners(e){super.activateListeners(e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown(a=>{$(a.currentTarget).toggleClass("active"),this.recalcSpellModifiers(e)}),e.find(".variableBaseCost").change(a=>{let i=$(a.currentTarget).parents(".skill-test"),n=i.find(".aspcost").attr("data-base"),r=$(a.currentTarget).val();i.find(".aspcost").attr("data-base",r),i.find(".aspcost").text(Number(i.find(".aspcost").text())*r/n)}),e.find(".spellModifier").change(a=>this.recalcSpellModifiers(e,a));let t=this.readTargets();t.length==0&&this.setRollButtonWarning();let s=this;this.checkTargets=setInterval(function(){t=s.compareTargets(e,t)},500)}},be=ct;m(be,"DSKpellDialog"),O(be,"rollChanges",["defenseMalus"]),O(be,"bigTimes",[5,30,120,480,960,1920]);var{mergeObject:ga}=foundry.utils,U=class extends Q{static getDialogForItem(e){switch(e){case"rangeweapon":case"meleeweapon":case"trait":return se;case"ahnengabe":return be;case"skill":return Pe}return U}static getRollButtons(e,t,s,a){let i={rollButton:{label:game.i18n.localize("dsk.check"),callback:n=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,n),s(t.callback(n))}}};return game.user.isGM&&ga(i,{cheat:{label:game.i18n.localize("dsk.DIALOG.cheat"),callback:n=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,n),s(t.callback(n,{cheat:!0}))}}}),i}activateListeners(e){super.activateListeners(e),e.find(".dieButton").click(t=>{let s=$(t.currentTarget);s.attr("data-single")=="true"&&s.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),s.toggleClass("dieSelected")})}static get defaultOptions(){let e=super.defaultOptions;return ga(e,{resizable:!0}),e}};m(U,"DSKDialog");var{mergeObject:ka,getProperty:V,duplicate:Ct,setProperty:yi}=foundry.utils;function ha(o,e={}){h.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}m(ha,"automatedAnimation");async function ya(o,e,t,s,a,i={}){let n={};if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else{let l=await game.packs.get(o).getDocuments({name:e});if(!l.length){for(let c of game.packs.filter(u=>u.documentName=="Macro"&&/\(internal\)/.test(u.metadata.label)))if(l=await c.getDocuments({name:e}),l.length)break}if(l.length){let c=`(async () => {${l[0].command}})()`,u=Function("actor","item","qs","automatedAnimation","args",c);try{i.result=n;let d=ka({automatedAnimation:ha},this);await u.call(d,t,s,a,ha,i)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),n.error=!0}}else ui.notifications.error(game.i18n.format("dsk.DSKError.macroNotFound",{name:e}))}return n}m(ya,"callMacro");var Y=class extends ActiveEffectConfig{static get defaultOptions(){return ka(super.defaultOptions,{resizable:!0})}static async onEffectRemove(e,t){let s=V(t,"flags.dsk.onRemove");if(s)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let a=Object.getPrototypeOf(async function(){}).constructor;await new a("effect","actor",s).call(this,t,e)}catch(a){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(a),console.warn(a.stack)}}async checkTimesUpInstalled(){let e=h.moduleEnabled("times-up");return!e&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("dsk.DSKError.shouldTimesUp")),e}async _render(e=!1,t={}){await super._render(e,t);let s=-1,a=["none","systemEffect","macro","creature"].map(u=>({name:`dsk.ActiveEffects.advancedFunctions.${u}`,index:s+=1})),i=V(this.object,"parent.type"),n={hasSpellEffects:["ahnengabe","consumable","poison","ammunition","meleeweapon","rangeweapon"].includes(i)||["specialability"].includes(i)&&V(this.object,"parent.system.category")=="Combat"||i=="trait"&&["meleeAttack","rangeAttack"].includes(V(this.object,"parent.system.traitType")),hasDamageTransformation:["ammunition"].includes(i)};n.hasDamageTransformation&&a.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5});let r={systemEffects:this.getStatusEffects(),canEditMacros:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")},l=$(this._element);l.find(".tabs").append(`<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>${game.i18n.localize("dsk.advanced")}</a>`);let c=await renderTemplate("systems/dsk/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:a,effectConfigs:n,config:r});l.find('.tab[data-tab="effects"]').after($(c)),l.find(".advancedSelector").change(u=>{let d=this.object;d.flags.dsk.advancedFunction=$(u.currentTarget).val(),renderTemplate("systems/dsk/templates/status/advanced_functions.html",{effect:d,config:r}).then(f=>{l.find(".advancedFunctions").html(f)})}),this.checkTimesUpInstalled()}async _onSubmit(e,{updateData:t=null,preventClose:s=!1,preventRender:a=!1}={}){return V(this.object,"system.document.parent.documentName")!="Actor"&&V(this.object,"system.document.parent.parent")&&ui.notifications.error(game.i18n.localize("dsk.DSKError.nestedEffectNotSupported")),await super._onSubmit(e,{updateData:t,preventClose:s,preventRender:a})}getStatusEffects(){return Ct(CONFIG.statusEffects).map(e=>({id:e.id,name:game.i18n.localize(e.name)})).sort((e,t)=>e.name.localeCompare(t.name))}getData(e){return super.getData(e)}static applyRollTransformation(e,t,s){let a="",i=t.origin;for(let n of i.effects)try{if(Number(V(n,"flags.dsk.advancedFunction"))==s)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let r=Object.getPrototypeOf(function(){}).constructor;new r("ef","callMacro","actor","msg","source",V(n,"flags.dsk.args3")).call(this,n,ya,e,a,i)}catch(r){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(r),console.warn(r.stack)}}catch(r){console.warn("Unable to apply advanced effect",r,n)}return t.origin=i,{msg:a,options:t}}static async applyAdvancedFunction(e,t,s,a,i,n=!0){let r="",l=[],c=!1,u=[],d=new Set;for(let f of t){f.origin&&delete f.origin;let p=Number(V(f,"flags.dsk.specStep"))||0;try{let b=Number(V(f,"flags.dsk.advancedFunction")),T=Math.min(a.qualityStep||0,6),g=V(f,"flags.dsk.resistRoll");if(g&&!n){let y=g.split(" "),v=`${y.pop()}`;l.push({skill:y.join(" "),mod:Math.round(Roll.safeEval(`${v}`.replace(/q(l|s)/i,T).replace("step",p)))||0,effect:f,target:e,token:e.token?e.token.id:void 0})}else if(c=!0,d.has(f.name)||d.add(f.name),f.changes&&f.changes.length>0&&u.push(f),b)switch(b){case 1:{let v=Ct(CONFIG.statusEffects.find(I=>I.id==V(f,"flags.dsk.args0"))),k=`${V(f,"flags.dsk.args1")}`||"1";v.duration=f.duration,/,/.test(k)?k=Number(k.split(",")[T-1]):k=Number(k.replace(game.i18n.localize("dsk.CHARAbbrev.QS"),T)),await e.addCondition(v,k,!1,!1)}break;case 2:if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let v=Object.getPrototypeOf(async function(){}).constructor;await new v("effect","actor","callMacro","msg","source","actor","sourceActor","testData","qs",V(f,"flags.dsk.args3")).call(this,f,e,ya,r,s,e,i,a,T)}catch(v){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(v),console.warn(v.stack)}break;case 3:let y=(V(f,"flags.dsk.args4")||"").split(",").map(v=>`@Compendium[${v.trim().replace(/(@Compendium\[|\])/)}]`).join(" ");r+=`<p><b>${game.i18n.localize("dsk.ActiveEffects.advancedFunctions.creature")}</b>:</p><p>${y}</p>`;break}}catch(b){console.warn("Unable to apply advanced effect"),console.warn(b),console.warn(f)}}return await e.createEmbeddedDocuments("ActiveEffect",u.map(f=>(f.origin=e.uuid,f))),{msg:r,resistRolls:l,effectApplied:c,effectNames:Array.from(d)}}static async resistEffect(e){let t=e.currentTarget.dataset,s={token:t.token,actor:t.actor,scene:canvas.id},a=h.getSpeaker(s);if(a){let i=a.items.find(n=>n.type=="skill"&&n.name==t.skill);a.setupSkill(i,{modifier:t.mod},t.token).then(async n=>{n.testData.opposable=!1,((await a.basicTest(n)).result.qualityStep||0)<1&&await this.applyEffect(t.message,t.mode,[s],{effectIds:[t.effect],skipResistRolls:!0})})}else console.warn("Actor not found for resist roll.")}static async applyEffect(e,t,s,a={}){let i=game.messages.get(e),n=i.flags.data.preData.source,r=i.flags.data.postData,l=i.speaker;["poison","disease"].includes(n.type)&&(r.qualityStep=r.successLevel>0?2:1);let c=h.getSpeaker(l)||h.getSpeaker(V(i.flags,"data.preData.extra.speaker"))||game.actors.get(V(i.flags,"data.preData.extra.actor.id")),u=c,d=await this._parseEffectDuration(n,r,i.flags.data.preData,c);a.effectIds&&(d=d.filter(p=>a.effectIds.includes(p._id)));let f=[];if(t=="self"?c&&f.push(c):s?f=s.map(p=>h.getSpeaker(p)):game.user.targets.size&&game.user.targets.forEach(p=>{p.actor&&f.push(p.actor)}),game.user.isGM)for(let p of f){let{msg:b,resistRolls:T,effectApplied:g,effectNames:y}=await Y.applyAdvancedFunction(p,d,n,r,u,a.skipResistRolls||!1);if(g){let k=`${game.i18n.format("dsk.ActiveEffects.appliedEffect",{target:p.token?.name||p.name,source:y.join(", ")})}${b||""}`;await ChatMessage.create(h.chatDataSetup(k))}T.length&&await this.createResistRollMessage(T,e,t)}else game.socket.emit("system.dsk",{type:"addEffect",payload:{mode:t,id:e,actors:f.map(p=>({token:p.token?p.token.id:void 0,actor:p.id,scene:canvas.scene.id}))}})}static async createResistRollMessage(e,t,s){for(let a of e){let i=await renderTemplate("systems/dsk/templates/chat/roll/resist-roll.html",{resist:a,id:t,mode:s});await ChatMessage.create(h.chatDataSetup(i))}}static async _parseEffectDuration(e,t,s,a){let i={};for(let u of s.situationalModifiers.filter(d=>d.specAbId))i[u.specAbId]=u.step;let n=Object.keys(i),r=a?a.items.filter(u=>n.includes(u.id)):[],l=e.effects?Ct(e.effects):[];for(let u of r){let d=Ct(u).effects;for(let f of d)yi(f,"flags.dsk.specStep",i[u.id]);l.push(...d)}let c=V(e,"system.duration")||"";c=c.replace(" x "," * ").replace(game.i18n.localize("dsk.CHARAbbrev.QS"),t.qualityStep);try{let u=[{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.years"),"gi"),seconds:3024e4}];for(let d of u)if(d.regEx.test(c)){let f=c.replace(d.regEx,"").trim(),p=await _DiceDSK._stringToRoll(f);if(!isNaN(p))for(let b of l){let T=p*d.seconds,g=V(b,"flags.dsk.customDuration");if(g){let y=g.split(",")[t.qualityStep-1];y&&y!="-"&&(T=Number(y))}b.duration.seconds=T,b.duration.rounds=b.duration.seconds/5}break}}catch{console.error(`Could not parse duration '${c}' of '${e.name}'`)}return l}dropDownMenu(){let e=game.i18n.localize("dsk.MODS.FW"),t=game.i18n.localize("TYPES.Item.skill"),s=game.i18n.localize("dsk.regenerate"),a=game.i18n.localize("dsk.MODS.FP"),i=game.i18n.localize("dsk.stepValue"),n=game.i18n.localize("dsk.MODS.QS"),r=game.i18n.localize("dsk.MODS.partChecks"),l=`${game.i18n.localize("dsk.LocalizedIDs.perception")} 1`,c=`${game.i18n.localize("dsk.LocalizedIDs.wrestle")} 1`,u=game.i18n.localize("dsk.closeCombatAttacks"),d=game.i18n.localize("dsk.rangeCombatAttacks"),f=`${s} (${game.i18n.localize("dsk.CHARAbbrev.CR")})`,p=game.i18n.localize("dsk.AePCost"),b=`${game.i18n.localize("dsk.description")} 1`,T=`${game.i18n.localize("Healing")} 1`,g=[{name:game.i18n.localize("dsk.protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:`${game.i18n.localize("dsk.resistanceModifier")} (${game.i18n.localize("dsk.condition")})`,val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("dsk.carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.AW")}`,val:"system.meleeStats.attack",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.VW")}`,val:"system.meleeStats.parry",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:`${u} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("dsk.MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:"Elementar 1"},{name:`${d} - ${game.i18n.localize("dsk.CHARAbbrev.AW")}`,val:"system.rangeStats.attack",mode:2,ph:"1"},{name:`${d} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:`${d} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:`${game.i18n.localize("TYPES.Item.ahnengabe")} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.spellStats.damage",mode:2,ph:"1"},{name:p,val:"system.aepModifier",mode:2,ph:"1"},{name:`${t} - ${e}`,val:"system.skillModifiers.FW",mode:0,ph:l},{name:`${t} - ${a}`,val:"system.skillModifiers.FP",mode:0,ph:l},{name:`${t} - ${i}`,val:"system.skillModifiers.step",mode:0,ph:l},{name:`${t} - ${n}`,val:"system.skillModifiers.QL",mode:0,ph:l},{name:`${t} - ${r}`,val:"system.skillModifiers.TPM",mode:0,ph:l},{name:`${game.i18n.localize("dsk.vulnerability")} - ${game.i18n.localize("TYPES.Item.combatskill")}`,val:"system.vulnerabilities.combatskill",mode:0,ph:c},{name:`${t} - ${game.i18n.localize("dsk.MODS.global")}`,val:"system.skillModifiers.global",mode:0,ph:"1"},{name:`${f} - ${game.i18n.localize("dsk.LeP")}`,val:"system.repeatingEffects.startOfRound.LeP",mode:0,ph:"1d6"},{name:`${f} - ${game.i18n.localize("dsk.AeP")}`,val:"system.repeatingEffects.startOfRound.AeP",mode:0,ph:"1d6"},{name:`${s} - ${game.i18n.localize("dsk.LeP")}`,val:"system.stats.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:`${s} - ${game.i18n.localize("dsk.AeP")}`,val:"system.stats.regeneration.AePgearmodifier",mode:2,ph:"1"},{name:`${game.i18n.localize("dsk.advanced")} - ${p}`,val:"system.skillModifiers.conditional.AePCost",mode:0,ph:b}],y=["ahnengabe","skill","feature"];for(let k of y){let I=k=="skill"?"skillglobal":k,B=h.categoryLocalization(I);g.push({name:`${B} - ${e}`,val:`system.skillModifiers.${k}.FW`,mode:0,ph:l},{name:`${B} - ${a}`,val:`system.skillModifiers.${k}.FP`,mode:0,ph:l},{name:`${B} - ${i}`,val:`system.skillModifiers.${k}.step`,mode:0,ph:l},{name:`${B} - ${n}`,val:`system.skillModifiers.${k}.QL`,mode:0,ph:l},{name:`${B} - ${r}`,val:`system.skillModifiers.${k}.TPM`,mode:0,ph:l})}let v=["inpain","selfconfidence","encumbered","stunned","feared"];for(let k of v)g.push({name:game.i18n.localize(`dsk.CONDITION.${k}`),val:`system.status.${k}`,mode:2,ph:1});for(let k of Object.keys(w.characteristics))g.push({name:game.i18n.localize(`dsk.characteristics.${k}.name`),val:`system.characteristics.${k}.gearmodifier`,mode:2,ph:"1"});for(let k of w.gearModifyableCalculatedAttributes)g.push({name:game.i18n.localize(`dsk.${k}`),val:`system.stats.${k}.gearmodifier`,mode:2,ph:"1"});g=g.sort((k,I)=>k.name.localeCompare(I.name));for(let k of g)(!k.ph||k.mode==null)&&console.warn(k);return g=g.map(k=>`<option value="${k.val}" data-mode="${k.mode}" data-ph="${k.ph}">${k.name}</option>`).join(`
`),`<select class="selMenu">${g}</select>`}activateListeners(e){super.activateListeners(e);let t=this.dropDownMenu();e.find(".changes-list .effect-change .key").append(t),e.find(".selMenu").change(s=>{let a=$(s.currentTarget);a.siblings("input").val(a.val());let i=a.closest(".effect-change"),n=a.find("option:selected");i.find(".mode select").val(n.attr("data-mode")),i.find(".value input").attr("placeholder",n.attr("data-ph")),a.blur()})}};m(Y,"DSKActiveEffectConfig");var{hasProperty:ki,getProperty:bi}=foundry.utils,J=class{static async playEffect(e,t,s,a=void 0,i=!1){let n=await this.getSound(e,t,s);if(n)try{a?(game.socket.emit("system.dsk",{type:"playWhisperSound",payload:{whisper:a,soundPath:n}}),i||foundry.audio.AudioHelper.play({src:n,volume:.8,loop:!1},!1)):foundry.audio.AudioHelper.play({src:n,volume:.8,loop:!1},!0)}catch{console.warn(`Could not play item sound effect ${n}`)}}static async loadSoundConfig(){let e=await game.settings.get("dsk","soundConfig");if(e)try{let s=await(await fetch(e)).json();this.sounds=s,console.log("DSK | Sound Config Loaded")}catch(t){console.warn(t)}}static successLevelToString(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}static async getSound(e,t,s){if(!this.sounds&&!this.triedInit&&(await this.loadSoundConfig(),this.triedInit=!0),!this.sounds)return;let a=this.successLevelToString(s),i=[],n;switch(t.type){case"meleeweapon":case"rangeweapon":i=[...a.map(r=>`${t.type}.manual.${t.name}.${e}_${r}`),`${t.type}.manual.${t.name}.${e}`,`${t.type}.manual.${t.name}.default.${e}`,`${t.type}.manual.${t.name}.default`,...a.map(r=>`${t.type}.${t.system.combatskill}.${e}_${r}`),`${t.type}.${t.system.combatskill}.${e}`,...a.map(r=>`${t.type}.${t.system.combatskill}.default_${r}`),`${t.type}.${t.system.combatskill}.default`];break;case"skill":i=[...a.map(r=>`${t.type}.${t.name}.${e}_${r}`),`${t.type}.${t.name}.${e}`,...a.map(r=>`${t.type}.${t.name}.default_${r}`),`${t.type}.${t.name}.default`];break;case"ahnengabe":i=[...a.map(r=>`${t.type}.${t.name}.${e}_${r}`),`${t.type}.${t.name}.${e}`,...a.map(r=>`${t.type}.${t.name}.default_${r}`),`${t.type}.${t.name}.default`];break}i.push(...a.map(r=>`${t.type}.default_${r}`),`${t.type}.default`);for(let r of i)if(!!ki(this.sounds,r)&&(n=bi(this.sounds,r),n&&(typeof n=="string"||n instanceof String)))break;return n}static async playMoneySound(e=!1){if(!game.modules.get("gAudioBundle-3"))return;let t=["modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"],s=t[Math.floor(Math.random()*t.length)];await this.playSoundPath(s,e)}static async playEquipmentWearStatusChange(e,t=!1){let s=[],a=game.modules.get("gAudioBundle-2"),i=game.modules.get("gAudioBundle-3"),n=game.modules.get("gAudioBundle-4");switch(e.type){case"armor":a&&s.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg");break;case"meleeweapon":a&&s.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),i&&s.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg");break;case"rangeweapon":n&&s.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg");break}if(s.length==0&&a&&s.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg"),s.length>0){let r=s[Math.floor(Math.random()*s.length)];await this.playSoundPath(r,t,.5)}}static async playSoundPath(e,t=!1,s=.8){if(!!game.settings.get("dsk","inventorySound"))try{foundry.audio.AudioHelper.play({src:e,volume:s,loop:!1},t)}catch{console.warn(`Could not play item sound effect ${e}`)}}};m(J,"DSKSoundEffect"),O(J,"sounds"),O(J,"triedInit",!1);var{duplicate:ba}=foundry.utils,ee=class{constructor(e){this.item=e}async callMacro(e,t,s={}){let i=await game.packs.get(e).getDocuments({name:t});if(!i.length){for(let r of game.packs.filter(l=>l.documentName=="Macro"&&/\(internal\)/.test(l.metadata.label)))if(i=await r.getDocuments({name:t}),i.length)break}let n={};if(i.length){let r=`(async () => {${i[0].command}})()`,l=Function("args","actor","item",r);try{s.result=n,await l.call(this,s,this.item.actor,this.item)}catch(c){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(c),n.error=!0}}else ui.notifications.error(game.i18n.format("dsk.DSKError.macroNotFound",{name:t}));return n}async executeOnUseEffect(){if(!game.user.can("MACRO_SCRIPT"))return ui.notifications.warn("You are not allowed to use JavaScript macros.");if(!this.item.actor)return;let t=`(async () => {${ee.getOnUseEffect(this.item)}})()`,s=Function("item","actor",t);try{await s.call(this,this.item,this.item.actor)}catch(a){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(a),console.warn(a.stack)}}static getOnUseEffect(e){return e.getFlag("dsk","onUseEffect")}async automatedAnimation(e,t={}){h.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}effectDummy(e,t,s){return{label:e,img:"icons/svg/aura.svg",changes:t,duration:s,flags:{dsk:{value:null,description:e}}}}async socketedConditionAddActor(e,t){if(game.user.isGM){let s=typeof t=="string";s&&(t=ba(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let a=[];for(let i of e)s?await i.addCondition(t,1,!1,!1):await i.addCondition(t),a.push(i.name);await this.createInfoMessage(t,a)}else{let s={id:this.item.uuid,data:t,actors:e.map(a=>a.id)};game.socket.emit("system.dsk",{type:"socketedConditionAddActor",payload:s})}}async createInfoMessage(e,t,s=!0){if(t.length){let a=s?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",i=game.i18n.format(a,{source:e.label,target:t.join(", ")});await ChatMessage.create(h.chatDataSetup(i))}}async socketedRemoveCondition(e,t,s=1){if(game.user.isGM){let a=[];for(let n of e){let r=canvas.tokens.get(n);r.actor&&(await r.actor.removeCondition(t,s,!1),a.push(r.name))}let i=CONFIG.statusEffects.find(n=>n.id==t);i.name=game.i18n.localize(i.name),await this.createInfoMessage(i,a,!1)}else{let a={id:this.item.uuid,coreId:t,targets:e};game.socket.emit("system.dsk",{type:"socketedRemoveCondition",payload:a})}}async socketedActorTransformation(e,t){if(game.user.isGM)for(let s of e){let a=canvas.tokens.get(s);a.actor&&await a.actor.update(t)}else{let s={id:this.item.uuid,targets:e,update:t};game.socket.emit("system.dsk",{type:"socketedActorTransformation",payload:s})}}async socketedConditionAdd(e,t){if(game.user.isGM){let s=typeof t=="string";s&&(t=ba(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let a=[];for(let i of e){let n=canvas.tokens.get(i);n.actor&&(s?await n.actor.addCondition(t,1,!1,!1):await n.actor.addCondition(t),a.push(n.name))}await this.createInfoMessage(t,a)}else{let s={id:this.item.uuid,data:t,targets:e};game.socket.emit("system.dsk",{type:"socketedConditionAdd",payload:s})}}};m(ee,"OnUseEffect");var{getProperty:wi,mergeObject:vi}=foundry.utils,ne=class{static async showBotchCard(e,t={}){t.speaker={token:e.token,actor:e.actor,scene:e.scene},t.source=e.source;let s=w.systemTables.find(u=>u.name==e.table),a=await ne.getRollTable(s.pack[game.i18n.lang],game.i18n.localize(`dsk.TABLENAMES.${e.table}`),e),i=t.speaker?await ne.hasEffect(a):!1,n=h.replaceDies(h.replaceConditions(a.results[0].text)),r=`${game.i18n.localize("dsk.TABLENAMES."+e.table)}`,l=await renderTemplate("systems/dsk/templates/tables/tableCard.html",{result:n,title:r,hasEffect:i}),c=await this.buildEffects(a,i);ChatMessage.create({user:game.user.id,content:l,whisper:t.whisper,blind:t.blind,flags:{data:{preData:{source:{effects:c},extra:{actor:{id:t.speaker.actor},speaker:t.speaker},situationalModifiers:[]},postData:{}},dsk:{hasEffect:i,options:t}}})}static async hasEffect(e){return wi(e.results[0],"flags.dsk")||!1}static async buildEffects(e,t){let s=[];if(t&&t.resistEffect){let a=new ee().effectDummy(t.resistEffect.fail.description,t.resistEffect.changes||[],t.resistEffect.duration||{});t.resistEffect.fail.systemEffect&&vi(a,{_id:"botchEffect",flags:{dsk:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:'await actor.addCondition("prone");'}}}),s.push(a)}return s}static async getRollTable(e,t,s={}){let i=(await game.packs.get(e).getDocuments({name__in:[t]}))[0],n=await i.draw({displayChat:!1});return s.weaponless=="true"&&n.roll.total<7&&(n.roll.editRollAtIndex([{index:0,val:n.roll.total+5}]),n=await i.draw({displayChat:!1,roll:n.roll})),n}static async tableEnabledFor(e){let t=w.systemTables.find(s=>s.name==e);return t?game.settings.get(t.setting.module,t.setting.key):!1}static rollCritBotchButton(e,t,s){let a=game.i18n.localize(`dsk.TABLENAMES.${e}`),i=s.extra.speaker,n=s.source._id;return`, <a class="roll-button botch-roll" data-table="${e}" data-weaponless="${t}" data-source="${n}" data-token="${i.token}" data-actor="${i.actor}" data-scene="${i.scene}"><i class="fas fa-dice"></i>${a}</a>`}static async defaultBotch(){return", "+game.i18n.localize("dsk.selfDamage")+(await new Roll("1d6+2").evaluate()).total}static defaultAttackCrit(e){let t=", "+game.i18n.localize("dsk.halfDefense");return e&&(t+=", "+game.i18n.localize("dsk.doubleDamage")),t}static defaultParryCrit(){return", "+game.i18n.localize("dsk.attackOfOpportunity")}};m(ne,"DSKTables");var pe=class{constructor(){pe.skills.length==0&&h.allSkills(["skill"]).then(e=>{pe.skills=e.map(t=>({name:t.name,type:"skill"})).concat(Object.values(game.dsk.config.characteristics).map(t=>({name:game.i18n.localize(t),type:"attribute"})).concat({name:game.i18n.localize("dsk.regenerate"),type:"regeneration"}))}),this.regex,this.filtering=!1}get regex(){return new RegExp(`^/(${pe.cmds.join(" |")})`)}async chatListeners(e){let t=this;this.anchor=$("#chat-message").parent(),$("#chat-message").off("keydown",ui.chat._onChatKeyDownBinding),e.on("keyup","#chat-message",async function(s){t._parseInput(s)}),e.on("click",".quick-item",async function(s){t._quickSelect($(s.currentTarget))}),e.on("keydown","#chat-message",function(s){t._navigateQuickFind(s)})}_parseInput(e){let t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(e.which==27)return this._closeQuickfind(),!1;let s=this._getCmd(t),a=t.substring(1+s.length).toLowerCase().trim();this[`_filter${s}`](a),this.filtering=!0}else this._closeQuickfind()}_getCmd(e){return e.substring(1,3).toUpperCase().trim()}_completeCurrentEntry(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())+""}_closeQuickfind(){this.filtering=!1,this.anchor.find(".quickfind").remove()}_filterW(e){let t=game.users.contents.filter(s=>s.active&&s.name.toLowerCase().trim().indexOf(e)!=-1).map(s=>({name:s.name,type:"user"}));this._checkEmpty(t),this._setList(t,"W")}_filterAT(e){let{actor:t,tokenId:s}=pe._getActor();if(t){let a=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],n=t.items.filter(r=>(a.includes(r.type)&&r.system.worn.value==!0||r.type=="trait"&&i.includes(r.system.traitType))&&r.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(r=>({name:r.name,type:"item"}));this._checkEmpty(n),this._setList(n,"AT")}}_filterAH(e){let{actor:t,tokenId:s}=pe._getActor();if(t){let a=["ahnengabe"],i=t.items.filter(n=>a.includes(n.type)&&n.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(n=>({name:n.name,type:"item"}));this._checkEmpty(i),this._setList(i,"SP")}}_checkEmpty(e){e.length||e.push({name:game.i18n.localize("dsk.DSKError.noMatch"),type:"none"})}_getSkills(e,t=void 0){e=e.replace(/(-|\+)?\d+/g,"").trim();let s=pe.skills.filter(a=>a.name.toLowerCase().trim().indexOf(e)!=-1&&(t==null||t==a.type)).slice(0,5);return this._checkEmpty(s),s}_filterCH(e){this._setList(this._getSkills(e),"CH")}_filterSK(e){this._setList(this._getSkills(e),"SK")}_filterRQ(e){this._setList(this._getSkills(e),"RQ")}_setList(e,t){let s=$(`<div class="quickfind dsklist"><ul>${e.map(i=>`<li data-type="${i.type}" data-category="${t}" class="quick-item">${i.name}</li>`).join("")}</ul></div>`);s.find(".quick-item:first").addClass("focus");let a=this.anchor.find(".quickfind");a.length?a.replaceWith(s):this.anchor.append(s)}_navigateQuickFind(e){if(this.filtering){let t=this.anchor.find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if(t.attr("data-category")=="W")break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}ui.chat._onChatKeyDown(e)}static _getActor(){let e=ChatMessage.getSpeaker(),t;return e.token&&(t=game.actors.tokens[e.token]),t||(t=game.actors.get(e.actor)),t?{actor:t,tokenId:e.token}:(ui.notifications.error(game.i18n.localize("dsk.DSKError.noProperActor")),{})}_quickSelect(e){let t=e.attr("data-category");switch(t){case"NM":case"RQ":case"CH":this[`_quick${t}`](e);break;case"W":this._completeCurrentEntry(e);break;default:let{actor:s,tokenId:a}=pe._getActor();s&&(this._resetChatAutoCompletion(),this[`_quick${t}`](e,s,a))}}_quickW(e,t,s){}_quickCH(e){H.check3D20(e),this._resetChatAutoCompletion()}_quickSK(e,t,s){switch(e.attr("data-type")){case"skill":let a=t.items.find(n=>n.name==e.text()&&n.type=="skill");a&&t.setupSkill(a,{},s).then(n=>{t.basicTest(n)});break;case"attribute":let i=Object.keys(game.dsk.config.characteristics).find(n=>game.i18n.localize(game.dsk.config.characteristics[n])==e.text());t.setupCharacteristic(i,{},s).then(n=>{t.basicTest(n)});break;case"regeneration":t.setupRegeneration("regenerate",{},s).then(n=>{t.basicTest(n)});break}}_resetChatAutoCompletion(){$("#chat-message").val(""),this.anchor.find(".quickfind").remove()}_quickRQ(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),ae.showRQMessage(e.text(),t)}_quickAT(e,t,s){let a=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],n=t.items.find(r=>a.includes(r.type)&&r.name==e.text());n||(n=t.items.find(r=>r.type=="trait"&&r.name==e.text()&&i.includes(r.system.traitType))),n&&t.setupWeapon(n,"attack",{},s).then(r=>{t.basicTest(r)})}_quickSP(e,t,s){let a=["ahnengabe"],i=t.items.find(n=>a.includes(n.type)&&n.name==e.text());i&&t.setupSpell(i,{},s).then(n=>{t.basicTest(n)})}static async infoItemAsync(e){(await fromUuid(e)).postItem()}static bindRollCommands(e){e.on("click",".request-roll",t=>(ae.showRQMessage(t.currentTarget.dataset.name,Number(t.currentTarget.dataset.modifier)||0),t.stopPropagation(),!1)),e.on("click",".postInfo",t=>{let s=fromUuidSync(t.currentTarget.dataset.uuid);return s&&(typeof s.postItem=="function"?s.postItem():this.infoItemAsync(t.currentTarget.dataset.uuid)),t.stopPropagation(),!1}),e.on("click",".postContentChat",async t=>{let s=$(t.currentTarget).closest(".postChatSection").find(".postChatContent").html();$e.getDialog(s)}),e.on("click",".request-CH",t=>(H.check3D20(void 0,t.currentTarget.dataset.name,{modifier:Number(t.currentTarget.dataset.modifier)||0}),t.stopPropagation(),!1))}},q=pe;m(q,"DSKChatAutoCompletion"),O(q,"skills",[]),O(q,"cmds",["sk","at","ah","rq","w","ch"]);var ae=class{static async requestRoll(e,t,s=0){let{actor:a,tokenId:i}=q._getActor();if(a){game.user.updateTokenTargets([]);let n={modifier:s};switch(e){case"attribute":let r=Object.keys(game.dsk.config.characteristics).find(c=>game.i18n.localize(game.dsk.config.characteristics[c])==t);a.setupCharacteristic(r,n,i).then(c=>{a.basicTest(c)});break;case"regeneration":a.setupRegeneration("regenerate",n,i).then(c=>{a.basicTest(c)});break;default:let l=a.items.find(c=>c.name==t&&c.type==e);a.setupSkill(l,n,i).then(c=>{a.basicTest(c)})}}}static showRQMessage(e,t=0){let s=t<0?` ${t}`:t>0?` +${t}`:"",a=q.skills.find(n=>n.name==e).type,i=game.i18n.format("dsk.CHATNOTIFICATION.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${a}" data-modifier="${t}" data-name="${e}"><i class="fas fa-dice"></i> ${e}${s}</a>`});ChatMessage.create(h.chatDataSetup(i))}static async updateInformationRoll(e,t,s){let a=t.result.qualityStep||0;if(a>0){let i=await fromUuid(e.uuid),n=[`<p><b>${i.name}</b></p>`];for(let l=1;l<=a;l++){let c=`qs${l}`;i.system[c]&&n.push(`<p>${i.system[c]}</p>`)}let r=h.chatDataSetup(n.join(""));e.recipients.length&&(r.whisper=e.recipients),ChatMessage.create(r)}}static async informationRequestRoll(e){let t=e.currentTarget.dataset.mod,s=e.currentTarget.dataset.uuid,{actor:a,tokenId:i}=q._getActor();if(!a)return;let n=game.settings.get("dsk","informationDistribution"),r=[];n==1?(r=game.users.filter(u=>u.isGM).map(u=>u.id),r.push(game.user.id)):n==2&&(r=game.users.filter(u=>u.isGM).map(u=>u.id));let l={modifier:t,postFunction:{functionName:"game.dsk.apps.RequestRoll.updateInformationRoll",uuid:s,recipients:r}},c=a.items.find(u=>u.name==e.currentTarget.dataset.skill&&u.type=="skill");a.setupSkill(c,l,i).then(async u=>{u.testData.opposable=!1;let d=await a.basicTest(u);this.updateInformationRoll(l.postFunction,d)})}static chatListeners(e){e.on("click",".request-roll",t=>{let s=t.currentTarget.dataset;ae.requestRoll(s.type,s.name,Number(s.modifier)||0)}),e.on("click",".informationRequestRoll",t=>ae.informationRequestRoll(t))}};m(ae,"RequestRoll");var ge=class extends j{static async traitAdded(e,t){w.addTraitRules[t.name]&&await w.addTraitRules[t.name](e,t)}static hasTrait(e,t){return super.hasItem(e,t,["trait"])}};m(ge,"TraitRulesDSK");var{mergeObject:Z,deepClone:wa,getProperty:Mt,duplicate:Ti}=foundry.utils,_DiceDSK=class{static async rollTest(o){let e;switch(o.source.type){case"ahnengabe":e=await this.rollSpell(o);break;case"skill":e=await this.rollTalent(o);break;case"combatskill":e=await this.rollCombatskill(o);break;case"regenerate":e=await this.rollRegeneration(o);break;case"trait":e=o.mode=="damage"?await this.rollDamage(o):await this.rollCombatTrait(o),o.mode!="damage"&&await this.updateDefenseCount(e);break;case"meleeweapon":case"rangeweapon":e=o.mode=="damage"?await this.rollDamage(o):await this.rollWeapon(o),o.mode!="damage"&&await this.updateDefenseCount(e);break;case"poison":e=await this.rollItem(o);break;default:e=await this.rollAttribute(o)}return Z(e,wa(o.extra)),e}static async updateDefenseCount(o){game.combat&&await game.combat.updateDefenseCount(Array.from(game.user.targets).map(e=>e.id))}static async setupDialog({dialogOptions:o,testData:e,cardOptions:t}){let s=await game.settings.get("core","rollMode"),a=0;typeof e.source.toObject=="function"&&(e.source=e.source.toObject(!1)),Z(e,{testDifficulty:a}),Z(o.data,{testDifficulty:a,testModifier:o.data.modifier||0});let i=o.data.situationalModifiers||(e.extra.actor?x.getRollModifiers(e.extra.actor,e.source):[]);e.extra.options.moreModifiers!=null&&i.push(...e.extra.options.moreModifiers);let n=[];if(game.user.targets.forEach(r=>{r.actor&&n.push({name:r.actor.name,id:r.id,img:r.actor.img})}),Z(o.data,{hasSituationalModifiers:i.length>0,situationalModifiers:i,rollMode:o.data.rollMode||s,attributesList:["mu","kl","in","ch","ff","ge","ko","kk"].reduce((r,l)=>(r[l]=game.i18n.localize(`dsk.characteristics.${l}.abbr`),r),{}),rollModes:CONFIG.Dice.rollModes,defenseCount:await this.getDefenseCount(e),targets:n}),Z(t,{user:game.user.id}),e.extra.options.bypass)return t.rollMode=e.extra.options.rollMode||s,e.situationalModifiers||(e.situationalModifiers=[]),{testData:e,cardOptions:t};{let r=await renderTemplate(o.template,o.data);return new Promise((l,c)=>{let u=U.getDialogForItem(e.source.type);new u({title:o.title,content:r,buttons:u.getRollButtons(e,o,l,c),default:"rollButton"}).recallSettings(e.extra.speaker,e.source,e.mode).render(!0)})}}static _appendSituationalModifiers(o,e,t,s=""){let a=o.situationalModifiers.find(i=>i.name==e);a?a.value=t:o.situationalModifiers.push({name:e,value:t,type:s})}static _situationalPartCheckModifiers(o){return o.situationalModifiers.reduce(function(e,t){if(t.type=="TPM"){let s=t.value.split("|");return s.length!=2||(e[0]=e[0]+Number(s[0]),e[1]=e[1]+Number(s[1])),e}else return e},[0,0])}static _situationalModifiers(o,e=""){return o.situationalModifiers.reduce(function(t,s){return t+((s.type==e||e==""&&s.type==null)&&Number(s.value)||0)},0)}static async getDefenseCount(o){let e=Array.from(game.user.targets);return game.combat&&e[0]?await game.combat.getDefenseCount({token:e[0].id}):0}static async rollTalent(o){let e=await this._roll2D20(o);return e.rollType="talent",e}static async rollAttribute(o){let e=await this._roll2D20(o);return e.rollType="attribute",e}static get2D20SuccessLevel(o,e,t=20,s=1){let a=o.terms.filter(n=>n.results&&n.results[0].result<=s).length,i=o.terms.filter(n=>n.results&&n.results[0].result>=t).length;return a>=2?a:i>=2?i*-1:e>=0?1:-1}static async _addRollDiceSoNice(o,e,t){if(o.rollMode){for(let s=0;s<e.dice.length;s++)Z(e.dice[s].options,t);await this.showDiceSoNice(e,o.rollMode)}}static async rollSpell(o){let e=await this._roll2D20(o);if(e.rollType=o.source.types,e.preData.calculatedSpellModifiers.finalcost=Number(e.preData.calculatedSpellModifiers.cost),e.successLevel>=2){let t=10;e.description=e.description+", "+game.i18n.localize("dsk.additionalQLs")+" "+t,e.qualityStep=Math.min(6,Math.ceil(e.result/5)+2),e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.cost/2)}else e.successLevel<=-2&&(e.description+=ne.rollCritBotchButton("Ahnen",!1,o));if(e.successLevel>0&&o.source.system.effectFormula!=""){let t=o.source.system.effectFormula.replace(game.i18n.localize("dsk.CHARAbbrev.QS"),e.qualityStep).replace(/[Ww]/g,"d"),s=[];for(let r of o.situationalModifiers)r.armorPen&&s.push(r.armorPen);/(,|;)/.test(t)&&(t=t.split(/[,;]/)[e.qualityStep-1]);let a=o.damageRoll?Roll.fromData(o.damageRoll):await _DiceDSK.manualRolls(await new Roll(t).evaluate(),"dsk.CHAR.DAMAGE",o.extra.options);this._addRollDiceSoNice(o,a,game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),e.calculatedEffectFormula=t;for(let r of a.terms)if(r instanceof foundry.dice.terms.Die||r.class=="Die")for(let l of r.results)e.characteristics.push({char:"effect",res:l.result,die:"d"+r.faces});let i=[],n=await _DiceDSK._stringToRoll(o.extra.actor.system.spellStats.damage,o);n!=0&&i.push(game.i18n.localize("dsk.statuseffects")+" "+n),e.armorPen=s,e.damageRoll=damageRoll.toJSON(),e.damage=a.total+n,e.damagedescription=i.join(`
`)}return this.calculateEnergyCost(e,o),e}static calculateEnergyCost(o,e){let t=[];if(o.successLevel<0){let r=["traditionWitch","traditionFjarning","braniborian"].map(c=>game.i18n.localize(`dsk.LocalizedIDs.${c}`)),l=e.extra.actor.items.some(c=>c.type=="specialability"&&r.includes(c.name))?3:2;o.preData.calculatedSpellModifiers.finalcost=Math.round(o.preData.calculatedSpellModifiers.finalcost/l)}let s="AePCost",a=game.i18n.localize("dsk.LocalizedIDs.weakAstralBody"),i=game.i18n.localize(`dsk.LocalizedIDs.${o.successLevel>0?"energyControl":"smallEnergyControl"}`),n={val:"aepModifier",name:"AeP"};t.push({name:a,value:E.vantageStep(e.extra.actor,a)},{name:i,value:z.abilityStep(e.extra.actor,i)*-1},{name:`${game.i18n.localize("dsk.statuseffects")} (${game.i18n.localize("dsk.CHARAbbrev."+n.name)})`,value:e.extra.actor.system[n.val]+this._situationalModifiers(e,s)}),t=t.filter(r=>r.value!=0),o.preData.calculatedSpellModifiers.description=t.map(r=>`${r.name} ${r.value}`).join(`
`),o.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(o.preData.calculatedSpellModifiers.finalcost)+t.reduce((r,l)=>r+l.value,0))}static async _stringToRoll(o,e){let t=[],s=/\d{1}[dDwW]\d/g,a=`${o}`;a.replace(s,function(r){t.push(new Roll(r.replace(/[Ww]/,"d")).evaluate())});let i=await Promise.all(t),n=a.replace(s,()=>{let r=i.shift();return e&&_DiceDSK._addRollDiceSoNice(e,r,game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),r.total});return await Roll.safeEval(n)}static async detailedWeaponResult(o,e,t){if(e.mode=="attack")switch(o.successLevel){case 2:o.description+=ne.defaultAttackCrit(!0),o.doubleDamage=!0;break;case-2:let s=t.type=="meleeweapon"||Mt(t,"system.traitType")=="meleeAttack",a=Mt(t,"system.combatskill")==game.i18n.localize("dsk.LocalizedIDs.wrestle")||t.type=="trait";s?o.description+=ne.rollCritBotchButton("Melee",a,e):o.description+=ne.rollCritBotchButton("Range",!1,e);break}}static async evaluateDamage(o,e,t,s,a){let i=t.system.tp.replace(/[Ww]/g,"d"),n=[],r=t.dmgMultipliers||[],l=r.map(g=>`${g.name} *${g.val}`),c=[],u=0;for(let g of o.situationalModifiers){let y=0;if(g.armorPen&&c.push(g.armorPen),g.damageBonus){if(/^\*/.test(g.damageBonus)){r.push({name:g.name,val:Number(g.damageBonus.replace("*",""))});continue}let v=/^=/.test(g.damageBonus),k=`${g.damageBonus}`.replace(/^=/,""),I=await _DiceDSK._stringToRoll(k,o);if(y=I*(g.step||1),v){i=k.replace(/[Ww]/,"d"),n.push({name:g.name,roll:I});continue}else g.damageBonus=I,u+=y}}let d=o.damageRoll?Roll.fromData(o.damageRoll):await _DiceDSK.manualRolls(await new Roll(i).evaluate(),"dsk.damage",o.extra.options),f=d.total,p=0;for(let g of d.terms)if(g instanceof foundry.dice.terms.Die||g.class=="Die")for(let y of g.results)p+=Number(y.result),e.characteristics.push({char:"damage",res:y.result,die:"d"+g.faces});let b=f-p;if(n.length>0)l.push(n[0].name+" "+f);else{f+=u,l.push(game.i18n.localize("dsk.Roll")+" "+p),b!=0&&l.push(game.i18n.localize("dsk.weaponModifier")+" "+b),o.situationalModifiers.reduce((v,k)=>{if(k.damageBonus){let I=/^\*/.test(k.damageBonus)?k.damageBonus:Number(k.damageBonus)*(k.step||1);l.push(`${k.name} ${I}`)}},l),o.situationalModifiers.find(v=>v.name.indexOf(game.i18n.localize("dsk.CONDITION.bloodrush"))>-1)&&(f+=2,l.push(game.i18n.localize("dsk.CONDITION.bloodrush")+" "+2)),t.extraDamage&&(f=Number(t.extraDamage)+Number(f),l.push(game.i18n.localize("dsk.damageThreshold")+" "+t.extraDamage));let g;if(s){let v=w.rangeMods[o.rangeModifier||"medium"].damage;f+=v,v!=0&&l.push(game.i18n.localize("dsk.distance")+" "+v),g=o.extra.actor.system.rangeStats.damage}else g=o.extra.actor.system.meleeStats.damage;let y=await _DiceDSK._stringToRoll(g,o);y!=0&&(f+=y,l.push(game.i18n.localize("dsk.statuseffects")+" "+y))}let T=game.i18n.localize("dsk.LocalizedIDs.feint");e.qualityStep>0&&!o.situationalModifiers.find(g=>g.name==T)&&(f+=e.qualityStep,l.push(game.i18n.localize("dsk.qualityStep")+" "+e.qualityStep)),a&&(f=f*3,l.push(game.i18n.localize("dsk.doubleDamage")));for(let g of r)f=f*g.val;e.armorPen=c,e.damagedescription=l.join(", "),e.damage=Math.round(f),e.damageRoll=d.toJSON()}static parseEffect(o){let e=o.system.effect?o.system.effect:void 0,t=[];if(e){let a=/^[a-z]+\|[öäüÖÄÜa-zA-z ]+$/;for(let i of e.split(";"))if(a.test(i.trim())){let n=i.split("|").map(r=>r.trim());if(n[0]=="condition"){let r=CONFIG.statusEffects.find(l=>l.id==n[1]);t.push(`<a class="chat-condition chatButton" data-id="${r.id}">
                            <img src="${r.img}"/>${game.i18n.localize(r.name)}
                            </a>`)}else t.push(`<a class="roll-button roll-item" data-name="${n[1]}" data-type="${n[0]}"><i class="fas fa-dice"></i>${game.i18n.localize(n[0])}: ${n[1]}</a>`)}}let s=Mt(o,"flags.dsk.poison");return s&&t.push(`<a class="roll-button roll-item" data-removecharge="${!s.permanent}" data-name="${s.name}" data-type="poison"><i class="fas fa-dice"></i>${game.i18n.localize("TYPES.Item.poison")}: ${s.name}</a>`),t.join(", ")}static async _roll2D20(o){let e=o.roll?o.roll instanceof Roll?o.roll:Roll.fromData(o.roll):await new Roll("1d20+1d20").evaluate(),t=[],s=0;if(o.testDifficulty&&this._appendSituationalModifiers(o,game.i18n.localize("dsk.Difficulty"),o.testDifficulty),o.vw){let p=o.situationalModifiers.reduce((T,g)=>T+(Number(g.dmmalus)||0),0),b=Math.max(0,Number(o.vw)-p);this._appendSituationalModifiers(o,game.i18n.localize("dsk.ABBR.VW"),-1*b)}let a=this._situationalModifiers(o),i=this._situationalPartCheckModifiers(o,"TPM"),n=o.source.attack||Number(o.source.system.at);n||(o.source.system.level==null?n=-5+o.extra.actor.system.characteristics[o.source.system.characteristic1].value+o.extra.actor.system.characteristics[o.source.system.characteristic2].value:n=o.source.system.level+5+Math.round((o.extra.actor.system.characteristics[o.source.system.characteristic1].value+o.extra.actor.system.characteristics[o.source.system.characteristic2].value)/2));let r=n+this._situationalModifiers(o,"FW")+i[0]+i[1]+a;o.advancedModifiers&&(r+=o.advancedModifiers.fws+o.advancedModifiers.chars[0]+o.advancedModifiers.chars[1]);let l=r-e.terms[0].results[0].result-e.terms[2].results[0].result,c=1,u=20;if(o.source.type=="skill"&&E.hasVantage(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.incompetent")} (${o.source.name})`)){let p=await new Roll("1d20").evaluate(),b=res.reduce((g,y,v,k)=>y<k[g]?v:g,0),T=e.terms[b*2].total;l+=Math.max(res[b],0),l-=Math.max(0,p.total-tar[b]),e.editRollAtIndex([{index:b,val:p.total}]),this._addRollDiceSoNice(o,p,e.terms[b*2].options),t.push(game.i18n.format("dsk.CHATNOTIFICATION.unableReroll",{die:b+1,oldVal:T,newVal:p.total}))}let d=0;o.source.type=="skill"&&ge.hasTrait(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.automaticSuccess")} (${o.source.name})`)?(t.push(game.i18n.localize("dsk.LocalizedIDs.automaticSuccess")),s=1,d=1):o.source.type=="skill"&&ge.hasTrait(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.automaticFail")} (${o.source.name})`)?(t.push(game.i18n.localize("dsk.LocalizedIDs.automaticFail")),s=-1):(s=_DiceDSK.get2D20SuccessLevel(e,l,u,c),o.routine&&(s=1),t.push(_DiceDSK.getSuccessDescription(s))),t=t.join(", ");let f=0;return s>0&&(l+=this._situationalModifiers(o,"FP"),f=Math.max(1,(l==0?1:l>0?Math.ceil(l/5):0)+(o.qualityStep!=null?Number(o.qualityStep):0))+(o.advancedModifiers?.qls||0)+this._situationalModifiers(o,"QL")),f<d&&(f=d),{result:l,characteristics:[0,1].map(p=>({char:o.source.system[`characteristic${p+1}`]||o.source.type,res:e.terms[p*2].results[0].result,tar:o.extra.actor?.system.characteristics[o.source.system[`characteristic${p+1}`]]?.value})),qualityStep:f,pw:r,roll:e,description:t,preData:o,successLevel:s,modifiers:a,extra:{}}}static async renderRollCard(chatOptions,testData,rerenderMessage){let applyEffect=this.addApplyEffectData(testData),preData=wa(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:preData.mode=="attack";await Hooks.call("postProcessDSKRoll",chatOptions,testData,rerenderMessage,hideDamage),delete preData.extra.actor,delete testData.actor,delete testData.preData;let hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsk.config.areaTargetTypes,chatData={title:chatOptions.title,testData,hideData:game.user.isGM,preData,hideDamage,modifierList:preData.situationalModifiers.filter(o=>o.value!=0),applyEffect,hasAreaTemplate};if(preData.advancedModifiers&&(preData.advancedModifiers.chars.some(o=>o!=0)&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.partChecks"),value:preData.advancedModifiers.chars}),preData.advancedModifiers.fws!=0&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.FW"),value:preData.advancedModifiers.fws}),preData.advancedModifiers.qls!=0&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter(o=>o.isGM).map(o=>o.id)),chatOptions.rollMode==="blindroll"?chatOptions.blind=!0:chatOptions.rollMode==="selfroll"&&(chatOptions.whisper=[game.user.id]),J.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSKRoll:!0},rerenderMessage){let html=await renderTemplate(chatOptions.template,chatData),actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.author).character,rollData=actor?actor.getRollData():{},enriched=await TextEditor.enrichHTML(html,{rollData,async:!0});chatOptions.content=enriched;let postFunction=Mt(rerenderMessage,"flags.data.preData.extra.options.postFunction");postFunction&&(testData.messageId=rerenderMessage.id,eval(postFunction.functionName)(postFunction,{result:testData},preData.source));let newMsg=await rerenderMessage.update({content:chatOptions.content,["flags.data"]:chatOptions["flags.data"]});return ui.chat.updateMessage(newMsg),newMsg}else return chatOptions.content=await renderTemplate(chatOptions.template,chatData),await ChatMessage.create(chatOptions)}static addApplyEffectData(o){let e=o.preData.source;if(["ahnengabe","meleeweapon","rangeweapon"].includes(e.type)){if(o.successLevel>0&&e.effects.length>0)return!0}else{if(["poison"].includes(e.type))return e.effects.length>0;if(e.type=="trait"&&e.effects.length>0&&o.successLevel>0)return!0}let t=o.preData.situationalModifiers.filter(s=>s.specAbId).map(s=>s.specAbId);if(t.length>0){let s=o.preData.extra.actor.items.filter(a=>t.includes(a._id));for(let a of s)if(a.effects.length>0)return!0}return!1}static getSuccessDescription(o){return game.i18n.localize(["dsk.CriticalFailure","dsk.Failure","","dsk.Success","dsk.CriticalSuccess"][o+2])}static async showDiceSoNice(o,e){if(h.moduleEnabled("dice-so-nice")){let t=null,s=!1;switch(e){case"blindroll":s=!0,t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"gmroll":t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"selfroll":t=[];break}let a=game.dice3d.showForRoll(o,game.user,!0,t,s);game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")||await a}}static async manualRolls(o,e="",t={}){if(t.cheat||game.settings.get("dsk","allowPhysicalDice"))if(t.predefinedResult)o.editRollAtIndex(t.predefinedResult);else{let s=!1,a,i=[];for(let r of o.terms)if(r instanceof foundry.dice.terms.Die||r.class=="Die")for(let l of r.results)i.push({faces:r.faces,val:l.result});let n=await renderTemplate("systems/dsk/templates/dialog/manualroll-dialog.html",{dice:i,description:e});if([s,a]=await new Promise((r,l)=>{new U({title:game.i18n.localize(t.cheat?"dsk.DIALOG.cheat":"dsk.SETTINGS.allowPhysicalDice"),content:n,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:c=>{r([!0,c])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{r([!1,0])}}}}).render(!0)}),s){let r=[];a.find(".dieInput").each(function(l){let c=Number($(this).val());c>0&&r.push({val:c,index:l}),l++}),o.editRollAtIndex(r)}}return o}static _getNarrowSpaceModifier(o,e){return e.narrowSpace?game.i18n.localize("dsk.LocalizedIDs.Shields")==o.system.combatskill?w.narrowSpaceModifiers["shield"+o.system.shieldsize][e.mode]:w.narrowSpaceModifiers["weapon"+o.system.rw][e.mode]:0}static async rollCombatTrait(o){let e=o.source,t=e.system.traitType=="meleeAttack",s=e;t?this._appendSituationalModifiers(o,game.i18n.localize("dsk.narrowSpace"),this._getNarrowSpaceModifier(s,o)):this._appendSituationalModifiers(o,game.i18n.localize("dsk.distance"),w.rangeMods[o.rangeModifier||"medium"].attack);let a=await this._roll2D20(o);await this.detailedWeaponResult(a,o,e),o.mode=="attack"&&a.successLevel>0&&await _DiceDSK.evaluateDamage(o,a,s,!t,a.doubleDamage),a.rollType="weapon";let i=_DiceDSK.parseEffect(s);return i&&(a.parsedEffect=i),a}static async rollWeapon(o){let e,t=o.source,s=o.extra.actor,a=t.system.combatskill,i=D._calculateCombatSkillValues(s.items.find(c=>c.type=="combatskill"&&c.name==a),s.system),n=t.type=="meleeweapon";n?(e=D._prepareMeleeWeapon(t,[i],o.extra.actor),this._appendSituationalModifiers(o,game.i18n.localize("dsk.narrowSpace"),this._getNarrowSpaceModifier(e,o))):(e=D._prepareRangeWeapon(t,[],[i],o.extra.actor),this._appendSituationalModifiers(o,game.i18n.localize("dsk.distance"),w.rangeMods[o.rangeModifier||"medium"].attack));let r=await this._roll2D20(o);await this.detailedWeaponResult(r,o,t),o.mode=="attack"&&r.successLevel>0&&await _DiceDSK.evaluateDamage(o,r,e,!n,r.doubleDamage),r.rollType="weapon";let l=_DiceDSK.parseEffect(e);return l&&(r.parsedEffect=l),r}static async rollRegeneration(o){let e=this._situationalModifiers(o),t=o.roll,s=[],a={rollType:"regenerate",preData:o,modifiers:e,extra:{}},i=[];o.regenerateLeP&&i.push("LeP"),o.extra.actor.system.isMage&&o.regenerateAeP&&i.push("AeP");let n=0;if(o.extra.actor.effects.some(l=>l.statuses.includes("sick"))){this._appendSituationalModifiers(o,game.i18n.localize("dsk.CONDITION.sick"),"*0");for(let l of i)s.push({char:l,res:0,die:"d6"}),a[l]=0,n+=2}else for(let l of i)this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.regeneration${l}`),E.vantageStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.regeneration${l}`)),l),this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.weakRegeneration${l}`),E.vantageStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.weakRegeneration${l}`))*-1,l),this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.advancedRegeneration${l}`),z.abilityStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.advancedRegeneration${l}`)),l),this._appendSituationalModifiers(o,`${game.i18n.localize(`CHARAbbrev.${l}`)} ${game.i18n.localize("dsk.Modifier")}`,o[`${l}Modifier`],l),this._appendSituationalModifiers(o,`${game.i18n.localize(`CHARAbbrev.${l}`)} ${game.i18n.localize("dsk.regenerate")}`,o[`regeneration${l}`],l),s.push({char:l,res:t.terms[n].results[0].result,die:"d6"}),a[l]=Math.round(Math.max(0,Number(t.terms[n].results[0].result)+Number(e)+this._situationalModifiers(o,l))*Number(o.regenerationFactor)),n+=2;return a.characteristics=s,a}static async rollDices(o,e){if(!o.roll){let t=game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration,s;switch(o.source.type){case"char":case"ahnengabe":case"skill":s=await new Roll("1d20+1d20").evaluate(),Z(s.dice[0].options,t(o.source.system.characteristic1)),Z(s.dice[1].options,t(o.source.system.characteristic2));break;case"regenerate":let a=[];o.regenerateLeP&&a.push("1d6"),o.extra.actor.isMage&&o.regenerateAeP&&a.push("1d6"),s=await new Roll(a.join("+")).evaluate(),o.regenerateLeP&&Z(s.dice[0].options,t("mu")),o.extra.actor.isMage&&o.regenerateAeP&&Z(s.dice[a.length-1].options,t("ge"));break;case"meleeweapon":case"rangeweapon":case"combatskill":if(o.mode=="damage"){let n=await this.damageFormula(o);s=await new Roll(n).evaluate();for(let r=0;r<s.dice.length;r++)Z(s.dice[r].options,t("damage"))}else s=await new Roll("1d20+1d20").evaluate(),Z(s.dice[0].options,t("attack")),Z(s.dice[1].options,t("attack"));break;case"trait":if(o.mode=="damage"){let n=await this.damageFormula(o);s=await new Roll(n).evaluate();for(let r=0;r<s.dice.length;r++)Z(s.dice[r].options,t("damage"))}else s=await new Roll("1d20+1d20").evaluate(),Z(s.dice[0].options,t("attack")),Z(s.dice[1].options,t("attack"));break;case"poison":case"disease":let i=t("in");s=await new Roll("1d20+1d20").evaluate(),Z(s.dice[0].options,i),Z(s.dice[1].options,i);break;default:console.error("Unexpected roll mode")}s=await _DiceDSK.manualRolls(s,o.source.type,o.extra.options),await this.showDiceSoNice(s,e.rollMode),o.roll=Ti(s),o.rollMode=e.rollMode}return o}static async rollItem(o){o.source.attack=20+2*o.source.system.level;let e=await this._roll2D20(o);switch(o.source.type){case"poison":let t=o.source.system.duration.split(" / ").map(a=>a.trim()),s=o.source.system.effect.split(" / ").map(a=>a.trim());e.duration=t.length>1?e.successLevel>0?t[0]:t[1]:t[0],e.effect=s.length>1?e.successLevel>0?s[0]:s[1]:s[0];break;case"disease":break}return e}static async damageFormula(o){let e;if(o.source.type=="meleeweapon"){let t=D._calculateCombatSkillValues(o.extra.actor.items.find(s=>s.type=="combatskill"&&s.name==o.source.system.combatskill),o.extra.actor.system);e=D._prepareMeleeWeapon(o.source,[t],o.extra.actor)}else if(o.source.type=="rangeweapon"){let t=D._calculateCombatSkillValues(o.extra.actor.items.find(s=>s.type=="combatskill"&&s.name==o.source.system.combatskill),o.extra.actor.system);e=D._prepareRangeWeapon(o.source,[],[t],o.extra.actor)}else e=o.source.system;return o.source.system.tp.replace(/[Ww]/g,"d")+`+${e.extraDamage||0}`}static async rollDamage(o){let e=this._situationalModifiers(o),t=[],s=o.roll,a=s.total+e;for(let i of s.terms)if(i instanceof foundry.dice.terms.Die||i.class=="Die")for(let n of i.results)t.push({char:o.mode,res:n.result,die:"d"+i.faces});return{rollType:"damage",damage:a,characteristics:t,preData:o,modifiers:e,extra:{}}}static async _rollEdit(o){let e=$(o.currentTarget),t=e.parents(".message").attr("data-message-id"),s=game.messages.get(t),a=s.flags.data,i=a.preData;i.extra.actor=h.getSpeaker(i.extra.speaker)?.toObject(!1),i.extra.options.cheat&&delete i.extra.options.cheat;let n;switch(e.attr("data-edit-type")){case"roll":n=e.attr("data-edit-id");let l=Number(e.val());if(i.roll.terms.length>n*2){let u=Roll.fromData(i.roll);u.editRollAtIndex([{index:n,val:l}]),i.roll=u}else{let u=Roll.fromData(a.postData.damageRoll);n=n-i.roll.terms.filter(d=>d.results).length,u.editRollAtIndex([{index:n,val:l}]),i.damageRoll=u}break;case"mod":n=i.situationalModifiers.findIndex(u=>u.name==game.i18n.localize("dsk.chatEdit")),n>0&&i.situationalModifiers.splice(n,1);let c={name:game.i18n.localize("dsk.chatEdit"),value:Number(e.val())-this._situationalModifiers(i)};i.situationalModifiers.push(c);break}a.postData.damageRoll&&!i.damageRoll&&(i.damageRoll=a.postData.damageRoll);let r={template:a.template,rollMode:a.rollMode,title:a.title,speaker:s.speaker,user:s.author.id};["gmroll","blindroll"].includes(r.rollMode)&&(r.whisper=game.users.filter(l=>l.isGM).map(l=>l.id)),r.rollMode==="blindroll"&&(r.blind=!0),["poison","disease"].includes(i.source.type)?new C(i.source)[`${a.postData.postFunction}`]({testData:i,cardOptions:r},{rerenderMessage:s}):h.getSpeaker(s.speaker)[`${a.postData.postFunction}`]({testData:i,cardOptions:r},{rerenderMessage:s})}static async chatListeners(o){o.on("click",".expand-mods",e=>{e.preventDefault();let t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()}),o.on("click",".edit-toggle",e=>{e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()}),o.on("click",".botch-roll",e=>ne.showBotchCard(e.currentTarget.dataset)),o.on("click",".roll-item",e=>_DiceDSK._itemRoll(e)),o.on("change",".roll-edit",e=>_DiceDSK._rollEdit(e)),o.on("click",".applyEffect",async e=>{_DiceDSK.wrapLock(e,async(t,s)=>{let a=s.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await Y.applyEffect(a,i)})}),o.on("click",".applyTableEffect",async e=>{_DiceDSK.wrapLock(e,async(t,s)=>{let a=s.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await TableEffects.applyEffect(a,i)})}),o.on("click",".placeTemplate",async e=>MeasuredTemplateDSK.placeTemplateFromChat(e)),o.on("click",".resistEffect",e=>Y.resistEffect(e)),o.on("click",".resistPain",e=>_DiceDSK.rollResistPain(e)),ae.chatListeners(o)}};m(_DiceDSK,"DiceDSK");var{getProperty:Dt}=foundry.utils;Hooks.once("ready",async()=>{if(!M.creatureData){let o=await fetch(`systems/dsk/lazy/creaturetype/${game.i18n.lang}.json`);M.creatureData=await o.json(),M.magical=game.i18n.localize("dsk.WEAPON.magical"),M.clerical=game.i18n.localize("dsk.WEAPON.clerical"),M.silverPlated=game.i18n.localize("dsk.WEAPON.silverPlated"),game.dsk.apps.CreatureType=M}});var Si=m(o=>!(!o||o.length===0),"isNotEmpty"),ce=class{constructor(e){this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}static detectCreatureType(e){let t=e.system.details.species;return Object.keys(ce.creatureData.types).filter(a=>t.indexOf(a)>=0).map(a=>this.getClass(ce.creatureData.types[a],t))}static getClass(e,t){let s={DemonType:Et,ChimeraType:It,DaimonidType:At,DragonType:$t,ElementalType:xt,FairyType:zt,GhostType:Ot,GolemType:Nt,HomunculiType:_t,IntelligentCreatureType:Pt,PlantType:Rt,AnimalType:Lt,UndeadType:Ft,SupernaturalType:Ht,MagicalConstructType:Bt,WerCreatureType:Gt,VampireType:jt}[e];return new s(t)}static creatureTypeName(e){if(e.type=="creature"){let t=e.system.species;return Object.keys(ce.creatureData.types).filter(s=>t.indexOf(s)>=0)[0]}else return e.system.details.species}static addCreatureTypeModifiers(e,t,s,a){let i=ce.detectCreatureType(e),n=["spell","ceremony","liturgy","ritual"].includes(t.type);for(let r of i){let l=r.damageModifier(t);if(n)for(let c of l)c.armorPen=r.spellResistanceModifier(e);s.push(...l)}s.push(...this.creatureBonusDamage(e,a)),ce.addVulnerabilitiesToSource(e,t,s)}static addVulnerabilitiesToSource(e,t,s){let a=Dt(e,"system.vulnerabilities");a&&["meleeweapon","rangeweapon"].includes(t.type)&&Dt(a,"combatskill").reduce((n,r)=>{if(r.target==t.system.combatskill){let c=(/\*/.test(r.value)?Number(r.value.replace("*",""))>1:Number(r.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";s.push(...ce.buildDamageMod(`${game.i18n.format(c,{name:t.system.combatskill})} (${r.source})`,r.value))}},s)}ignoredCondition(e){return!1}damageModifier(e){return[]}static creatureBonusDamage(e,t){let s=[],a=e.system.details.species,i=Dt(t,"system.creatureBonus");for(let n of i)a.indexOf(n.target)>=0&&s.push(...this.buildDamageMod(n.source,n.value,!0));return s}spellImmunity(e){return this.spellImmunities.some(t=>e.includes(t))}spellArmorModifier(e){return 0}poisonImmunity(){return this.poisonImmunity}diseaseImmunity(){return this.diseaseImmunity}spellResistanceModifier(e){return 0}static buildDamageMod(e,t,s=!0){return[{name:e,value:t,selected:s,type:"dmg",source:game.i18n.localize("dsk.target")}]}weaponAttributes(e){return Dt(e,"system.effect.attributes")||""}getTypeByClass(e){return Object.keys(ce.creatureData.types).find(t=>ce.creatureData.types[t]===e)}isAttackItem(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&Si(this.weaponAttributes(e))}attributesRegex(e){let t=this.weaponAttributes(e);return new RegExp(`(${t.split(",").map(s=>h.escapeRegex(s.split("(")[0].trim())).join("|")})`,"i")}},M=ce;m(M,"CreatureType"),O(M,"creatureData"),O(M,"magical"),O(M,"clerical");var Re=class extends M{damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let s of M.creatureData.godOfLife){let a=`${M.clerical} (${s})`;if(t.test(a))return M.buildDamageMod(a,"*2")}}return super.damageModifier(e)}};m(Re,"VulnerableToLifeGods");var It=class extends Re{};m(It,"ChimeraType");var At=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation"].map(t=>game.i18n.localize(`Features.${t}`))}damageModifier(e){return this.isAttackItem(e)&&this.attributesRegex(e).test(M.clerical)?M.buildDamageMod(M.clerical,"*2"):super.damageModifier(e)}};m(At,"DaimonidType");var $t=class extends M{};m($t,"DragonType");var Et=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);if(t.test(M.clerical))return M.buildDamageMod(`${M.clerical} (${M.creatureData.opposingGod})`,"*2",!1);if(t.test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}spellArmorModifier(e){return Number(e.system.stats.soulpower.max)}spellResistanceModifier(e){return Number(e.system.stats.soulpower.max)}ignoredCondition(e){return!0}};m(Et,"DemonType");var xt=class extends M{constructor(e){super(e),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}spellArmorModifier(e){return Number(e.system.stats.soulpower.max)}spellResistanceModifier(e){return Number(e.system.stats.soulpower.max)}ignoredCondition(e){return!0}};m(xt,"ElementalType");var zt=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}};m(zt,"FairyType");var Ot=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let s of M.creatureData.godOfDeath){let a=`${M.clerical} (${s})`;if(t.test(a))return[]}if(t=this.attributesRegex(e),t.test(M.clerical))return M.buildDamageMod(M.clerical,"*0.5");if(t.test(M.magical))return M.buildDamageMod(M.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(M.magical,"*0.5");return M.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}ignoredCondition(e){return!["feared","inpain","confused"].includes(e)}};m(Ot,"GhostType");var Nt=class extends Re{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["confused","paralysed"].includes(e)}};m(Nt,"GolemType");var _t=class extends Re{constructor(e){super(e),this.spellImmunities=["Healing"].map(t=>game.i18n.localize(`Features.${t}`))}ignoredCondition(e){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(e)}};m(_t,"HomunculiType");var Pt=class extends M{};m(Pt,"IntelligentCreatureType");var Rt=class extends M{};m(Rt,"PlantType");var Lt=class extends M{};m(Lt,"AnimalType");var Ft=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let s of M.creatureData.godOfDeath){let a=`${M.clerical} (${s})`;if(t.test(a))return M.buildDamageMod(a,"*2")}}return super.damageModifier(e)}ignoredCondition(e){return!["paralysed"].includes(e)}};m(Ft,"UndeadType");var Ht=class extends M{};m(Ht,"SupernaturalType");var Bt=class extends M{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["stunned","feared","paralysed","confused"].includes(e)}};m(Bt,"MagicalConstructType");var Gt=class extends M{damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.silverPlated))return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}};m(Gt,"WerCreatureType");var jt=class extends M{damageModifier(e){return["spell","ceremony","liturgy","ritual"].includes(e.type)?super.damageModifier(e):M.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}};m(jt,"VampireType");var{duplicate:Le,mergeObject:re,getProperty:Ee}=foundry.utils,C=class extends Item{static defaultImages(e,t=""){let s=`${e}${t}`;return{effectwrapper:"icons/svg/aura.svg",information:"systems/dsk/icons/categories/DSK-Auge.webp",ammunition:"systems/dsk/icons/categories/arrow.webp",equipment:"systems/dsk/icons/categories/equipment.webp",advantage:"systems/dsk/icons/categories/advantage.webp",disadvantage:"systems/dsk/icons/categories/disadvantage.webp",specialability:"systems/dsk/icons/categories/specialability.webp",combatskill:"systems/dsk/icons/categories/combatskill.webp",ahnengabe:"systems/dsk/icons/categories/ahnengabe.webp",armor:"systems/dsk/icons/categories/armor.webp",rangeweapon:"systems/dsk/icons/categories/rangeweapon.webp",meleeweapon:"systems/dsk/icons/categories/meleeweapon.webp",ahnengeschenk:"systems/dsk/icons/categories/ahnengeschenk.webp",culture:"systems/dsk/icons/categories/culture.webp",profession:"systems/dsk/icons/categories/profession.webp",poison:"systems/dsk/icons/categories/poison.webp",trait:"systems/dsk/icons/categories/trait.webp",consumable:"systems/dsk/icons/categories/consumable.webp"}[s]}static defaultIcon(e){(!e.img||e.img=="")&&(e.img=this.defaultImages(e.type)||"systems/dsk/icons/blank.webp")}setupEffect(e,t={},s){return C.getSubClass(this.type).setupDialog(e,t,this,s)}async itemTest({testData:e,cardOptions:t},s={}){e=await _DiceDSK.rollDices(e,t);let a=await _DiceDSK.rollTest(e);if(a.postFunction="itemTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("dsk.Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}return s.suppressMessage||_DiceDSK.renderRollCard(t,a,s.rerenderMessage),{result:a,cardOptions:t}}static attackStatEffect(e,t){t!=0&&e.push({name:game.i18n.localize("dsk.statuseffects"),value:t,selected:!0})}static prepareRangeAttack(e,t,s,a,i,n,r=void 0){e.push(...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.restrictedSenseSight"),-2)),this.getCombatSkillModifier(t,a,e);let l=this.getTargetSizeAndModifier(t,a,e,s),c=Number(t.system.rangeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("dsk.statuseffects")} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0});let u={...w.rangeWeaponModifiers};delete u[E.hasVantage(t,game.i18n.localize("dsk.LocalizedIDs.senseOfRange"))?"long":"rangesense"],z.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.extremeShot"))||delete u.extreme;let d=z.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.drivingArcher")),f=Le(d?w.drivingArcherOptions:w.mountedRangeOptions),p={};for(let b of Object.keys(f))p[`${game.i18n.localize("mountedRangeOptions."+b)} (${f[b]})`]=f[b];re(s,{rangeOptions:u,rangeDistance:Object.keys(u)[X.distanceModifier(game.canvas.tokens.get(i),a,r)],sizeOptions:w.rangeSizeCategories,visionOptions:w.rangeVision,mountedOptions:p,shooterMovementOptions:w.shooterMovementOptions,targetMovementOptions:w.targetMomevementOptions,targetSize:l,combatSpecAbs:n,aimOptions:w.aimOptions})}async addCondition(e,t=1,s=!1,a=!0){return await x.addCondition(this,e,t,s,a)}async removeCondition(e,t=1,s=!0,a=!1){return x.removeCondition(this,e,t,s,a)}hasCondition(e){return x.hasCondition(this,e)}static async _onCreateOperation(e,t,s){for(let a of e)a.actor&&await D.postUpdateConditions(a.actor);return super._onCreateOperation(e,t,s)}static async _onUpdateOperation(e,t,s){for(let a of e)a.actor&&await D.postUpdateConditions(a.actor);return super._onUpdateOperation(e,t,s)}static async _onDeleteOperation(e,t,s){for(let a of e)a.actor&&await D.postUpdateConditions(a.actor);return super._onDeleteOperation(e,t,s)}static prepareMeleeAttack(e,t,s,a,i,n){let r="short";game.user.targets.forEach(u=>{if(u.actor){let d=u.actor.items.filter(f=>f.type=="meleeweapon"&&f.system.worn.value||f.type=="trait"&&f.system.traitType=="meleeAttack"&&f.system.pa);d.length>0&&(r=d[0].system.rw)}});let l=this.getTargetSizeAndModifier(t,a,e,s);this.getCombatSkillModifier(t,a,e);let c=Number(t.system.meleeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("dsk.statuseffects")} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0}),re(s,{visionOptions:w.meleeRangeVision(),weaponSizes:w.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:r,combatSpecAbs:i,meleeSizeOptions:w.meleeSizeCategories,targetSize:l,constricted:t.hasCondition("constricted"),wrongHandDisabled:n,offHand:!n&&Ee(a,"system.worn.offHand")})}static parseValueType(e,t){let s="";return/^\*/.test(t)&&(s="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:s}}static getSpecAbModifiers(e,t){let s=[];for(let a of e.find(".specAbs")){let i=Number($(a).attr("data-step"));if(i>0){let n=t=="attack"?$(a).attr("data-atbonus"):$(a).attr("data-pabonus"),r=n.split(",").reduce((l,c)=>l+Number(c),0);s.push({name:$(a).find("a").text(),value:isNaN(r)?Number(n.replace("*","")):Number(r)*i,damageBonus:$(a).attr("data-tpbonus"),dmmalus:$(a).attr("data-dmmalus")*i,step:i,specAbId:$(a).attr("data-id"),type:/^\*/.test(n)?"*":void 0})}}return s}static getTargetSizeAndModifier(e,t,s,a){let i="average",n=0;return game.user.targets.forEach(r=>{if(r.actor){let l=Ee(r.actor,"system.details.size");l&&(i=l),M.addCreatureTypeModifiers(r.actor,t,s,e),n=Math.max(n,r.actor.system.maxDefense.parry)}}),a.vw=n,i}static getCombatSkillModifier(e,t,s){if(t.type=="trait")return;let a=e.items.find(i=>i.type=="combatskill"&&i.name==t.system.combatskill);for(let i of a.effects)for(let n of i.changes)switch(n.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":s.push({name:`${a.name} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:n.value*-1,type:"defenseMalus",selected:!0});break}}static buildCombatSpecAbs(e,t,s,a){let i;s?(s.push(game.i18n.localize("dsk.LocalizedIDs.all")),s=s.map(f=>f.toLowerCase()),i=m((f,p)=>f.system.combatskills.split(/;|,/).map(b=>b.trim().toLowerCase()).filter(b=>p.includes(b.replace(/ \([a-zA-Z äüöÄÖÜ]*\)/,""))).length>0,"searchFilter")):i=m(()=>!0,"searchFilter");let n=e.items.filter(f=>f.type=="specialability"&&t.includes(f.system.category)&&f.system.effect!=""&&i(f,s)),r=[],l=game.i18n.localize("dsk.LocalizedAbilityModifiers.at"),c=game.i18n.localize("dsk.LocalizedAbilityModifiers.tp"),u=game.i18n.localize("dsk.LocalizedAbilityModifiers.pa"),d=game.i18n.localize("dsk.LocalizedAbilityModifiers.dm");if(a=="attack")for(let f of n){let p=C.parseEffect(f.system.effect,e),b=p[l]||0,T=p[c]||0,g=p[d]||0;if(b!=0||T!=0||g!=0||f.effects.size>0){let y=game.i18n.localize(w.combatSkillSubCategories[f.system.subcategory]);r.push({name:f.name,atbonus:b,tpbonus:T,dmmalus:g,label:`${l}: ${b}, ${c}: ${T}, ${d}: ${g}`,steps:f.system.level,category:{id:f.system.subcategory,css:`ab_${f.system.subcategory}`,name:y},id:f.id,actor:e.id})}}else for(let f of n){let b=C.parseEffect(f.system.effect,e)[u]||0;if(b!=0){let T=game.i18n.localize(w.combatSkillSubCategories[f.system.subcategory]);r.push({name:f.name,pabonus:b,tpbonus:0,dmmalus:0,label:`${u}: ${b}`,steps:f.system.level,category:{id:f.system.category.sub,css:`ab_${f.system.subcategory}`,name:T},id:f.id,actor:e.id})}}return r}_setupCardOptions(e,t,s){let a=ChatMessage.getSpeaker();return{speaker:{alias:a.alias,scene:a.scene},flags:{img:a.token?canvas.tokens.get(a.token).document.img:this.img},title:t,template:e}}static getSkZkModifier(e,t){let s=[],a=[],i=["ahnengabe"].includes(t.type)&&t.system.effectFormula.trim()=="";game.user.targets.size&&game.user.targets.forEach(n=>{if(n.actor){let r=0;i&&(r=M.detectCreatureType(n.actor).reduce((c,u)=>c+u.spellResistanceModifier(n.actor),0)),s.push(n.actor.system.stats.sk.max*-1-r),a.push(n.actor.system.stats.zk.max*-1-r)}}),re(e,{SKModifier:s.length>0?Math.min(...s):0,ZKModifier:a.length>0?Math.min(...a):0})}static async create(e,t){return this.defaultIcon(e),await super.create(e,t)}static changeChars(e,t,s){e.system.characteristic1=t,e.system.characteristic2=s}static getSubClass(e){return game.dsk.config.ItemSubClasses[e]||C}static areEquals(e,t){return e.type!=t.type?!1:C.getSubClass(e.type).checkEquality(e,t)}static checkEquality(e,t){return t.type==e.type&&e.name==t.name&&e.system.description.value==t.system.description.value}static setupDialog(e,t,s,a,i){return null}static buildSpeaker(e,t){return{token:t,actor:e?e.id:void 0,scene:canvas.scene?canvas.scene.id:null}}static async stackItems(e,t,s){return await C.getSubClass(e.type).combineItem(e,t,s)}static async combineItem(e,t,s){return e=Le(e),e.system.quantity+=t.system.quantity,await s.updateEmbeddedDocuments("Item",[e])}static _chatLineHelper(e,t){return`<b>${game.i18n.localize(e)}</b>: ${t||"-"}`}static setupSubClasses(){game.dsk.config.ItemSubClasses={meleeweapon:Vt,rangeweapon:Yt,armor:Jt,ammunition:Zt,equipment:Xt,species:Qt,culture:es,profession:ts,advantage:dt,disadvantage:ss,specialability:as,ahnengeschenk:is,ahnengabe:Fe,poison:ns,skill:rs,combatskill:os,effectwrapper:Wt,information:qt,trait:Kt,consumable:Ut}}static hasSchips(e){return Ee(e.system,"stats.schips.value")>0}async postItem(){C.getSubClass(this.type)._postItem(this)}static parseEffect(e,t){let s={},a=new RegExp(game.i18n.localize("dsk.CHARAbbrev.GS"),"gi");for(let i of e.split(/,|;/).map(n=>n.trim())){let n=i.replace(/(\s+)/g," ").trim().split(" ");n[0]=n[0].replace(a,t.system.stats.gs.max),n.length==2&&(!isNaN(n[0])||/(=)?[+-]\d([+-]\d)?/.test(n[0])||/(=)?\d[dDwW]\d/.test(n[0])||/=\d+/.test(n[0])||/\*\d(\.\d)*/.test(n[0]))&&(s[n[1].toLowerCase()]==null?s[n[1].toLowerCase()]=[n[0]]:s[n[1].toLowerCase()].push(n[0]))}return s}static chatData(e,t){return[]}static async _postItem(e){let t=Le(e),s=Ee(t,"system.obfuscation.details"),a=Ee(t,"system.obfuscation.description");re(t,{properties:s?[]:C.getSubClass(e.type).chatData(Le(t.system),e.name),descriptionObfuscated:a}),t.hasPrice="price"in t.system&&!s,t.hasPrice&&t.properties.push(`<b>${game.i18n.localize("dsk.price")}</b>: ${t.system.price}`),e.pack&&(t.itemLink=e.link),t.img.includes("/blank.webp")&&(t.img=null);let i=await renderTemplate("systems/dsk/templates/chat/post-item.html",t),n=h.chatDataSetup(i);ChatMessage.create(n)}};m(C,"ItemDSK");var qt=class extends C{static async _postItem(e){let t=await renderTemplate("systems/dsk/templates/chat/informationRequestRoll.html",{item:e}),s=h.chatDataSetup(t);ChatMessage.create(s)}};m(qt,"ItemInformation");var Wt=class extends C{};m(Wt,"ItemEffectwrapper");var Kt=class extends C{static chatData(e,t){let s=[];switch(e.traitType){case"meleeAttack":s=[this._chatLineHelper("dsk.ABBR.AW",e.at),this._chatLineHelper("dsk.damage",e.damage),this._chatLineHelper("dsk.range",e.rw)];break;case"rangeAttack":s=[this._chatLineHelper("dsk.ABBR.AW",e.at),this._chatLineHelper("dsk.damage",e.damage),this._chatLineHelper("dsk.range",e.rw),this._chatLineHelper("dsk.reloadTime",e.lz)];break;case"armor":s=[this._chatLineHelper("dsk.protection",e.damage)];break}return s}static getSituationalModifiers(e,t,s,a,i){a=h.toObjectIfPossible(a);let n=a.system.traitType,r=C.buildCombatSpecAbs(t,["Combat","animal"],void 0,s.mode);s.mode=="attack"&&n=="meleeAttack"?this.prepareMeleeAttack(e,t,s,a,r,!1):s.mode=="attack"&&n=="rangeAttack"&&this.prepareRangeAttack(e,t,s,a,i,r),this.attackStatEffect(e,Number(t.system[n=="meleeAttack"?"meleeStats":"rangeStats"][s.mode]))}static setupDialog(e,t,s,a,i){let n=t.mode,r=s.name+" "+game.i18n.localize("dsk."+n+"test");re(s.system,{characteristic1:"attack",characteristic2:"attack"});let l={opposable:!0,source:s,mode:n,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}},c=R.multipleDefenseValue(a,s.toObject()),u={rollMode:t.rollMode,mode:n,hasSchips:this.hasSchips(a),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*c})},d=Ee(s,"system.traitType"),f=a?x.getRollModifiers(a,s,{mode:n}):[];this.getSituationalModifiers(f,a,u,s,i),u.situationalModifiers=f;let p={title:r,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:u,callback:(T,g={})=>(d=="meleeAttack"?se.resolveMeleeDialog(l,b,T,a,g,c,n):se.resolveRangeDialog(l,b,T,a,g,c),l.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),l.isRangeDefense=u.isRangeDefense,Hooks.call("callbackDialogCombatDSK",l,a,T,s,i),{testData:l,cardOptions:b})},b=a._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSK.setupDialog({dialogOptions:p,testData:l,cardOptions:b})}};m(Kt,"ItemTrait");var Ut=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.consumable.effect",e[`effect${e.qs}`]),this._chatLineHelper("dsk.consumable.ingredients",e.ingredients)]}static consumablePrice(e){let t=`${e.system.price}`.split(";");return Number(t[[e.system.qs]]||t[0])}};m(Ut,"ItemConsumable");var Vt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.damage",e.tp),this._chatLineHelper("dsk.ABBR.awvw",`${e.aw} / ${e.vw}`),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill),this._chatLineHelper("dsk.range",game.i18n.localize(`dsk.Range.${e.rw}`))]}static getSituationalModifiers(e,t,s,a){let i=E.hasVantage(t,game.i18n.localize("dsk.LocalizedIDs.ambidextrous"));a=h.toObjectIfPossible(a);let n=[a.system.combatskill],r=C.buildCombatSpecAbs(t,["Combat"],n,s.mode);s.mode=="attack"&&this.prepareMeleeAttack(e,t,s,a,r,i),this.attackStatEffect(e,Number(t.system.meleeStats[s.mode]))}static setupDialog(e,t,s,a,i){let n=t.mode,r=s.name+" "+game.i18n.localize("dsk."+n+"test"),l=a.items.find(T=>T.type=="combatskill"&&T.name==s.system.combatskill);re(s.system,{characteristic1:l.system.characteristic1,characteristic2:l.system.characteristic2});let c={opposable:!0,source:s,mode:n,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}},u=R.multipleDefenseValue(a,c.source),d={rollMode:t.rollMode,mode:n,hasSchips:this.hasSchips(a),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*u})},f=a?x.getRollModifiers(a,s,{mode:n}):[];this.getSituationalModifiers(f,a,d,s),d.situationalModifiers=f;let p={title:r,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(T,g={})=>(se.resolveMeleeDialog(c,b,T,a,g,u,n),c.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),Hooks.call("callbackDialogCombatDSK",c,a,T,s,i),c.isRangeDefense=d.isRangeDefense,{testData:c,cardOptions:b})},b=a._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSK.setupDialog({dialogOptions:p,testData:c,cardOptions:b})}};m(Vt,"ItemMeleeweapon");var Yt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.damage",e.tp),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill),this._chatLineHelper("dsk.range",e.rw)]}static getSituationalModifiers(e,t,s,a,i){if(s.mode=="attack"){let n=h.toObjectIfPossible(a),r=[n.system.combatskill],l=C.buildCombatSpecAbs(t,["Combat"],r,s.mode),c=t.items.get(n.system.currentAmmo);if(c){c=c.toObject(!1);let u=Ee(c.flags,"dsk.poison");u&&re(a.flags,{dsk:{poison:u}})}if(this.prepareRangeAttack(e,t,s,n,i,l,c),c){if(c.system.atmod&&e.push({name:`${c.name} - ${game.i18n.localize("dsk.atmod")}`,value:c.system.atmod,selected:!0,specAbId:n.system.currentAmmo}),c.system.damageMod||c.system.armorMod){let u={name:`${c.name} - ${game.i18n.localize("dsk.MODS.damage")}`,value:c.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:n.system.currentAmmo};c.system.armorMod&&(u.armorPen=c.system.armorMod),e.push(u)}c.effects.length&&e.push({name:`${c.name} - ${game.i18n.localize("dsk.effect")}`,value:1,type:game.i18n.localize("dsk.effect"),selected:!0,specAbId:n.system.currentAmmo})}}this.attackStatEffect(e,Number(t.system.rangeStats[s.mode]))}static async checkAmmunitionState(e,t,s,a){let i=!0;if(a!="damage"){let n=e.system;if(n.ammunitionType!="infinite")if(n.ammunitionType=="-")t.extra.ammo=Le(e),i=t.extra.ammo.system.quantity>0;else{let r=s.items.get(n.currentAmmo);r?(t.extra.ammo=r.toObject(),n.ammunitionType=="mag"?i=t.extra.ammo.system.quantity>1||t.extra.ammo.system.mag.value>0&&t.extra.ammo.system.quantity>0:i=t.extra.ammo.system.quantity>0):i=!1}!i&&s.type=="creature"&&(i=!0)}return i||ui.notifications.error(game.i18n.localize("dsk.DSKError.NoAmmo")),i}static async setupDialog(e,t,s,a,i){let n=t.mode,r=s.name+" "+game.i18n.localize("dsk."+n+"test"),l=a.items.find(T=>T.type=="combatskill"&&T.name==s.system.combatskill);re(s.system,{characteristic1:l.system.characteristic1,characteristic2:l.system.characteristic2});let c={opposable:!0,source:s,mode:n,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}};if(!await this.checkAmmunitionState(s,c,a,n))return;let u=R.multipleDefenseValue(a,c.source),d={rollMode:t.rollMode,mode:n,hasSchips:this.hasSchips(a),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*u})},f=a?x.getRollModifiers(a,s,{mode:n}):[];this.getSituationalModifiers(f,a,d,s,i),d.situationalModifiers=f;let p={title:r,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(T,g={})=>(se.resolveRangeDialog(c,b,T,a,g,u),c.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),Hooks.call("callbackDialogCombatDSK",c,a,T,s,i),{testData:c,cardOptions:b})},b=a._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSK.setupDialog({dialogOptions:p,testData:c,cardOptions:b})}};m(Yt,"ItemRangeweapon");var Jt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.protection",e.rs)]}};m(Jt,"ItemArmor");var Zt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.ammunitionType",game.i18n.localize(`dsk.ammunition.${e.ammunitionType}`))]}};m(Zt,"ItemAmmunition");var Xt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.equipmentType",game.i18n.localize(`dsk.Equipment.${e.category}`))]}};m(Xt,"ItemEquipment");var Qt=class extends C{};m(Qt,"ItemSpecies");var es=class extends C{};m(es,"ItemCulture");var ts=class extends C{};m(ts,"ItemProfession");var dt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.rule",e.rule)]}};m(dt,"ItemAdvantage");var ss=class extends dt{};m(ss,"ItemDisadvantage");var as=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.rule",e.rule)]}};m(as,"ItemSpecialability");var is=class extends C{};m(is,"ItemAhnengeschenk");var Fe=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.AeP",e.AeP),this._chatLineHelper("dsk.distribution",e.distribution),this._chatLineHelper("dsk.duration",e.duration),this._chatLineHelper("dsk.range",e.range),this._chatLineHelper("dsk.targetCategory",e.targetCategory)]}static async getCallbackData(e,t,s){e.testDifficulty=0,e.situationalModifiers=D._parseModifiers(t),D.schipsModifier(t,e.situationalModifiers),e.situationalModifiers.some(i=>i.name==game.i18n.localize("dsk.schips"))&&s.reduceSchips(0);let a=new FormDataExtended(t.find("form")[0]).object;e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text()},e.situationalModifiers.push({name:game.i18n.localize("dsk.removeGesture"),value:Number(a.removeGesture)||0},{name:game.i18n.localize("dsk.removeFormula"),value:Number(a.removeFormula)||0},{name:game.i18n.localize("dsk.zkModifier"),value:a.zkModifier||0},{name:game.i18n.localize("dsk.skModifier"),value:a.skModifier||0}),e.extensions=Fe.getSpecAbModifiers(t),e.advancedModifiers={chars:[0,1].map(i=>a[`ch${i}`]),fws:a.fw,qls:a.qs},C.changeChars(e.source,...[0,1].map(i=>a[`characteristics${i}`]))}static getSpecAbModifiers(e){let t=[];for(let s of e.find(".specAbs.active"))t.push({name:s.dataset.name,title:s.getAttribute("title"),uuid:s.dataset.uuid});return t}static getSituationalModifiers(e,t,s,a){e.push(...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.magicalAttunement"),1,!0),...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.magicalRestriction"),-1,!0),...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.boundToArtifact"),-1,!0)),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&M.addCreatureTypeModifiers(i.actor,a,e,t)}),e.push(...t.getSkillModifier(a.name,a.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value});this.getSkZkModifier(s,a)}static setupDialog(e,t,s,a,i){let n="ahnen",r=s.name+" "+game.i18n.localize("dsk.probe")+(t.subtitle||""),l={opposable:!!s.system.effectFormula,source:s,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)},advancedModifiers:{chars:[0,0],fws:0,qls:0}},c={rollMode:t.rollMode,hasSKModifier:s.system.resist=="sk",hasZKModifier:s.system.resist=="zk",spellReach:s.system.range,hasSchips:this.hasSchips(a),characteristics:[1,2].map(p=>s.system[`characteristic${p}`])},u=a?x.getRollModifiers(a,s):[];this.getSituationalModifiers(u,a,c,s),c.situationalModifiers=u;let d={title:r,template:`/systems/dsk/templates/dialog/${n}-enhanced-dialog.html`,data:c,callback:async(p,b={})=>(f.rollMode=p.find('[name="rollMode"]').val(),await this.getCallbackData(l,p,a),re(l.extra.options,b),{testData:l,cardOptions:f})},f=a._setupCardOptions("systems/dsk/templates/chat/roll/spell-card.html",r,i);return _DiceDSK.setupDialog({dialogOptions:d,testData:l,cardOptions:f})}};m(Fe,"ItemAhnengabe");var ns=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.stepValue",e.level),this._chatLineHelper("dsk.poisonType",e.category),this._chatLineHelper("dsk.start",e.start),this._chatLineHelper("dsk.duration",e.duration),this._chatLineHelper("dsk.resistanceModifier",e.resist),this._chatLineHelper("dsk.effect",h.replaceConditions(h.replaceDies(e.effect)))]}static getSituationalModifiers(e,t,s,a){a=h.toObjectIfPossible(a),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...E.getVantageAsModifier(i.actor,game.i18n.localize("dsk.LocalizedIDs.poisonResistance"),-1,!1,!0))}),this.getSkZkModifier(s,a),re(s,{hasSKModifier:a.system.resist=="SK",hasZKModifier:a.system.resist=="ZK"})}static setupDialog(e,t,s,a,i){let n=s.name+" "+game.i18n.localize("TYPES.Item."+s.type)+" "+game.i18n.localize("dsk.check"),r={opposable:!1,source:s,extra:{options:t,speaker:C.buildSpeaker(a,i)}},l={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,a,l,s),l.situationalModifiers=c;let u={title:n,template:"/systems/dsk/templates/dialog/poison-dialog.html",data:l,callback:(f,p={})=>(d.rollMode=f.find('[name="rollMode"]').val(),r.situationalModifiers=D._parseModifiers(f),r.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:f.find('[name="zkModifier"]').val()||0}),r.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:f.find('[name="skModifier"]').val()||0}),re(r.extra.options,p),{testData:r,cardOptions:d})},d=s._setupCardOptions(`systems/dsk/templates/chat/roll/${s.type}-card.html`,n,i);return _DiceDSK.setupDialog({dialogOptions:u,testData:r,cardOptions:d})}};m(ns,"ItemPoison");var rs=class extends C{static getSituationalModifiers(e,t,s,a){e.push(...t.getSkillModifier(a.name,a.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value})}static setupDialog(e,t,s,a,i){let n=s.name+" "+game.i18n.localize("dsk.probe")+(t.subtitle||""),r={opposable:!0,source:s,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}},l={rollMode:t.rollMode,modifier:t.modifier||0,difficultyLabels:w.skillDifficultyLabels,hasSchips:this.hasSchips(a),characteristics:[1,2].map(d=>s.system[`characteristic${d}`]),situationalModifiers:a?x.getRollModifiers(a,s):[]};t.situationalModifiers&&l.situationalModifiers.push(...t.situationalModifiers),this.getSituationalModifiers(l.situationalModifiers,a,l,s);let c={title:n,template:"/systems/dsk/templates/dialog/skill-dialog.html",data:l,callback:(d,f={})=>(u.rollMode=d.find('[name="rollMode"]').val(),r.situationalModifiers=D._parseModifiers(d),D.schipsModifier(d,r.situationalModifiers),r.situationalModifiers.some(p=>p.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),r.testDifficulty=w.skillDifficultyModifiers[d.find('[name="testDifficulty"]').val()],r.advancedModifiers={chars:[0,1].map(p=>Number(d.find(`[name="ch${p}"]`).val())),fws:Number(d.find('[name="fw"]').val()),qls:Number(d.find('[name="qs"]').val())},C.changeChars(r.source,...[0,1].map(p=>d.find(`[name="characteristics${p}"]`).val())),re(r.extra.options,f),{testData:r,cardOptions:u})},u=a._setupCardOptions("systems/dsk/templates/chat/roll/skill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:c,testData:r,cardOptions:u})}};m(rs,"ItemSkill");var os=class extends C{};m(os,"ItemCombatskill");function va(o,e=320,t=40){o.attr({width:e*.8,viewBox:`0 0 ${e} ${t}`});let s=o.find("text"),a=s.get(0).getBBox(),i=e/a.width,n=t/a.height,r=i<n,l=r?i:n;isFinite(l)&&s.attr({transform:"matrix("+l+", 0, 0, "+l+", 0,0)",x:Math.max(0,(e-a.width)/2),y:t*.75/(r?1:l)})}m(va,"svgAutoFit");function Ta(o,e,t,s="div"){if(e=o.find(e)[0],!e)return;e.classList.add("slist");let a=e.querySelectorAll(s),i=null;for(let n of a)n.draggable=!0,n.addEventListener("dragstart",function(r){i=this}),n.addEventListener("dragover",function(r){r.preventDefault()}),n.addEventListener("drop",async function(r){if(r.preventDefault(),this!=i){let l=0,c=0;for(let u=0;u<a.length;u++)i==a[u]&&(l=u),this==a[u]&&(c=u);l<c?this.parentNode.insertBefore(i,this.nextSibling):this.parentNode.insertBefore(i,this),await t(e)}})}m(Ta,"slist");function Sa(o){let e=$(".tinyNotifications");e.length||($("body").append('<ul class="tinyNotifications"></ul>'),e=$(".tinyNotifications"));let t=$(`<li>${o}</li>`);e.prepend(t),setTimeout(function(){t.remove()},1500)}m(Sa,"tinyNotification");async function ls(o,e,t=!0){let s,a;o.type=="Actor"?(s=await Actor.implementation.fromDropData(o),a=e===s.id):(s=await Item.implementation.fromDropData(o),a=e===s.parent?.uuid);let i=s?.type;return t&&(s=s.toObject()),o.amount&&(s.system.quantity.value=Number(o.amount)),{item:s,typeClass:i,selfTarget:a}}m(ls,"itemFromDrop");var{getProperty:Ca}=foundry.utils,F=class{static async handleOpposedTarget(e){if(!e)return;let t=h.getSpeaker(e.speaker);if(!t)return;let s=e.flags.data.postData,a=e.flags.data.preData;game.user.targets.size&&e.flags.data.isOpposedTest&&!e.flags.data.defenderMessage&&!e.flags.data.attackerMessage&&(console.log("start opposed"),F.createOpposedTest(t,e,s,a)),await this.showDamage(e),await this.showSpellWithoutTarget(e)}static async createOpposedTest(e,t,s,a){let i;t.speaker.token?i=canvas.tokens.get(t.speaker.token).document:i=e.prototypeToken,s.successLevel>0?game.user.targets.forEach(async n=>{if(n.actor)switch(s.rollType){case"weapon":await F.evaluateAttack(e,t,s,a,i,n);break;default:let r=F.opposeMessage(i,n,!1);await ChatMessage.create({user:game.user.id,content:r,speaker:t.speaker,["flags.unopposeData"]:{attackMessageId:t.id,targetSpeaker:{scene:n.scene.id,token:n.id,alias:n.document.name}}})}}):game.user.targets.forEach(async n=>{n.actor&&await ChatMessage.create({user:game.user.id,content:F.opposeMessage(i,n,!0),speaker:t.speaker})})}static async evaluateAttack(e,t,s,a,i,n){if(s.qualityStep>0){s.source=a.source;let r=F._calculateOpposedDamage(s,n),l=[r.armorMod!=0?`${r.armorMod+" "+game.i18n.localize("dsk.Modifier")}`:"",r.armorMultiplier!=1?"*"+r.armorMultiplier+" "+game.i18n.localize("dsk.Modifier"):"",r.spellArmor!=0?`${r.spellArmor} ${game.i18n.localize("dsk.spellArmor")}`:""].join(""),c=`<b>${game.i18n.localize("dsk.damage")}</b>: ${r.damage}<i class="lighticon fa attackWeaponless" data-tooltip="Roll"></i> - <span data-tooltip="${l}">${r.armor}</span><i class="lighticon fa fa-shield-alt" data-tooltip="protection"></i> = ${r.sum}`,u={winner:"attacker",damage:{description:c,value:r.sum,sp:r.damage}};u=F.formatOpposedResult(u,i,n,s),await F.renderOpposedResult(u,{}),await F.playAutomatedJBA2(u.speakerAttack,u.speakerDefend,u)}}static _calculateOpposedDamage(e,t,s={}){let a=t.actor;s.origin=e.source,s.damage=e.damage;let i=Y.applyRollTransformation(a,s,5).options.damage,{wornArmor:n,armor:r}=D.armorValue(a,s),l=[],c=0,u=e.armorPen||[];for(let p of u)/^\*/.test(p)?l.push(Number(p.replace("*",""))):c+=Number(p);let d=0;["ahnengabe"].includes(e.source.type)&&(d+=a.system.spellArmor||0),r+=c;let f=l.reduce((p,b)=>p*b,1);return r=Math.max(Math.round(r*f),0),r+=d,{damage:i,armor:r,armorMod:c,spellArmor:d,armorMultiplier:f,sum:i-r}}static formatOpposedResult(e,t,s,a){let i=e.differenceSL?"winsFP":"wins";return e.winner=="attacker"?(e.result=game.i18n.format("dsk.OPPOSED."+i,{winner:t.name,loser:s.name,SL:e.differenceSL}),e.img=t.img):e.winner=="defender"&&(e.result=game.i18n.format("dsk.OPPOSED."+i,{winner:s.name,loser:t.name,SL:e.differenceSL}),e.img=s.img),e.speakerAttack=F.tokenDude(t,a),e.speakerDefend=F.tokenDude(s,{}),e}static tokenDude(e,t){return{speaker:{token:e.id,actor:e.actor?.id,scene:canvas.scene?.id},img:F.videoOrImgTag(e.document?.texture.src||e.texture.src),testResult:t}}static async renderOpposedResult(e,t={}){e.hideData=await game.settings.get("dsk","hideOpposedDamage");let s=await renderTemplate("systems/dsk/templates/chat/roll/opposed-result.html",e),a={user:game.user.id,content:s,"flags.opposeData":e,"flags.hideData":e.hideData,whisper:t.whisper,blind:t.blind};await ChatMessage.create(a)}static opposeMessage(e,t,s){return`<div class="opposed-message">
            <b>${e.name}</b> ${game.i18n.localize("dsk.ROLL.Targeting")} <b>${t.document.name}</b> ${s?game.i18n.localize("dsk.ROLL.failed"):""}
            </div>
            <div class="opposed-tokens row-section">
                <div class="col two attacker">${F.videoOrImgTag(e.texture.src)}</div>
                <div class="col two defender">${F.videoOrImgTag(t.document.texture.src)}</div>
            </div>
             `}static async playAutomatedJBA2(e,t,s){if(h.moduleEnabled("autoanimations")){let a=h.getSpeaker(e.speaker).getActiveTokens()[0],i=h.getSpeaker(t.speaker).getActiveTokens()[0];if(!a||!a.actor||!i||!i.actor)return;let n=a.actor.items.get(e.testResult.source._id);if(n||(n=new C(e.testResult.source)),!n)return;let r=[i],l=s.winner=="attacker"?r:[];AutomatedAnimations.playAnimation(a,n,{targets:r,hitTargets:l,playOnMiss:!0})}}static videoOrImgTag(e){return/\.webm$/.test(e)?`<video loop autoplay src="${e}" width="50" height="50"></video>`:`<img src="${e}" width="50" height="50"/>`}static async showDamage(e,t=!1){game.user.isGM?(!t||!e.flags.data.hideDamage)&&e.flags.data.postData.damageRoll&&(await e.update({content:e.content.replace(`data-hide-damage="${!t}"`,`data-hide-damage="${t}"`),"flags.data.hideDamage":t}),t||_DiceDSK._addRollDiceSoNice(e.flags.data.preData,Roll.fromData(e.flags.data.postData.damageRoll),game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"))):game.socket.emit("system.dsk",{type:"showDamage",payload:{id:e.id,hide:t}})}static async showSpellWithoutTarget(e){if(h.moduleEnabled("autoanimations")){let t=Ca(e,"flags.data");if(!t||t.isOpposedTest)return;if((Ca(t,"postData.result")||-1)>0){let a=h.getSpeaker(t.postData.speaker).getActiveTokens()[0];if(!a||!a.actor)return;let i=Array.from(game.user.targets),n=a.actor.items.get(t.preData.source._id);i.length||(i=[a]),AutomatedAnimations.playAnimation(a,n,{targets:i})}}}};m(F,"OpposedDSK");var{getProperty:W,mergeObject:we,duplicate:cs}=foundry.utils,N=class extends Actor{static async create(e,t){if(e instanceof Array||e.items)return await super.create(e,t);(!e.img||e.img=="icons/svg/mystery-man.svg")&&(e.img="icons/svg/mystery-man-black.svg");let s=["skill","combatskill"];["character","npc"].includes(e.type)&&s.push("meleeweapon","specialability"),e.items=await h.allSkills(s);let a={character:3,npc:1,creature:0},i=W(e,"system.stats.schips.current")||a[e.type]||0;return e.system={stats:{schips:{current:i,value:i}}},e.type!="creature"&&[void 0,0].includes(W(e,"system.stats.LeP.value"))&&we(e,{system:{stats:{LeP:{value:16}}}}),await super.create(e,t)}prepareDerivedData(){let e=this.system;try{e.canAdvance=this.isOwner&&this.type=="character";for(let r of Object.values(e.characteristics))r.value=r.initial+r.advances+(r.modifier||0)+r.gearmodifier;e.totalWeight=0;let t=[],s=new Map,a=this.items.filter(r=>r.type=="equipment"&&r.system.category=="bags");for(let r of a)s.set(r.id,[]);for(let r of this.items)if(N._baseCarryItems.has(r.type)){let l=W(r,"system.parent_id");if(l&&l!=r._id&&s.has(l)){s.get(l).push(r);continue}r.type=="armor"?(r.system.preparedWeight=parseFloat((r.system.weight*r.system.quantity).toFixed(3)),e.totalWeight+=parseFloat((r.system.weight*(r.system.worn.value?Math.max(0,r.system.quantity-1):r.system.quantity)).toFixed(3)),r.system.worn.value&&t.push(r)):(r.system.preparedWeight=parseFloat((r.system.weight*r.system.quantity).toFixed(3)),e.totalWeight+=Number(r.system.preparedWeight))}else switch(r.type){case"ahnengabe":case"ahnengeschenk":e.isMage=!0;break;case"specialability":N._mageSpecs.has(r.system.category)&&(e.isMage=!0);break}for(let r of a){let l=W(r,"system.parent_id");(!l||!s.has(l))&&(e.totalWeight+=this._calcBagweight(r,s,!0))}e.carrycapacity=e.characteristics.kk.value*2+e.carryModifier,e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent),(this.type=="character"||this.type=="npc")&&(e.stats.LeP.current=e.stats.LeP.initial+e.characteristics.ko.value*2,e.stats.AeP.current=!e.guidevalue||e.guidevalue=="-"?0:N._attrFromCharacteristic(e.guidevalue,e),e.stats.sk.value=(e.stats.sk.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/3)-10,e.stats.zk.value=(e.stats.zk.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/3)-10,e.stats.ini.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.stats.ini.modifier||0),e.stats.LeP.min=-1*e.characteristics.ko.value),this.type=="creature"&&(e.stats.LeP.current=e.stats.LeP.initial,e.stats.AeP.current=e.stats.AeP.initial,e.stats.ini.value=e.stats.ini.current+(e.stats.ini.modifier||0)),e.stats.schips.max=Number(e.stats.schips.current)+Number(e.stats.schips.modifier)+e.stats.schips.gearmodifier,e.stats.regeneration.LePmax=e.stats.regeneration.LePTemp+e.stats.regeneration.LePMod+e.stats.regeneration.LePgearmodifier,e.stats.regeneration.AePmax=e.stats.regeneration.AePTemp+e.stats.regeneration.AePMod+e.stats.regeneration.AePgearmodifier,e.stats.LeP.max=Math.round((e.stats.LeP.current+e.stats.LeP.modifier+e.stats.LeP.advances)*e.stats.LeP.multiplier+e.stats.LeP.gearmodifier),e.stats.AeP.max=e.stats.AeP.current+e.stats.AeP.modifier+e.stats.AeP.advances+e.stats.AeP.gearmodifier,e.stats.gs.max=Math.max(0,e.stats.gs.initial+(e.stats.gs.modifier||0)+e.stats.gs.gearmodifier),e.stats.sk.max=e.stats.sk.value+e.stats.sk.modifier+e.stats.sk.gearmodifier,e.stats.zk.max=e.stats.zk.value+e.stats.zk.modifier+e.stats.zk.gearmodifier;let i=0;e.stats.ini.value+=e.stats.ini.gearmodifier-Math.min(4,i);let n=Number((.01*e.stats.ini.value).toFixed(2));e.stats.ini.value*=e.stats.ini.multiplier||1,e.stats.ini.value=Math.round(e.stats.ini.value)+n;for(let r of Object.keys(e.status))e.status[r]=Math.clamp(e.status[r],0,8);e.armorEncumbrance=this.getArmorEncumbrance(this,t),this.effectivePain(e),e.maxDefense=this.maxDefenseValue()}catch(t){console.error("Something went wrong with preparing actor data: "+t+t.stack),ui.notifications.error(game.i18n.format("dsk.DSKError.PreparationError",{name:this.name})+t+t.stack)}}static async deferredEffectAddition(e,t,s){let i=(t.effects.find(r=>r.statuses.has(e))?.flags.dsk.auto||0)!=s,n=`changing${e}`;t[n]=i,i&&await t.addCondition(e,s,!0).then(()=>t[n]=void 0)}static async postUpdateConditions(e){if(!h.isActiveGM())return;let t=e.system,s=e.isMerchant();if(!ge.hasTrait(e,game.i18n.localize("dsk.LocalizedIDs.painImmunity"))){let i=e.woundPain(t);await this.deferredEffectAddition("inpain",e,i*2)}let a=t.armorEncumbrance;(e.type!="creature"||e.canAdvance)&&!s&&(a+=Math.max(0,Math.ceil((t.totalWeight-t.carrycapacity-5)/5))*2),await this.deferredEffectAddition("encumbered",e,a),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.blind"))&&await e.addCondition("blind"),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.mute"))&&await e.addCondition("mute"),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.deaf"))&&await e.addCondition("deaf"),s&&e.prepareMerchant()}static async _onCreateOperation(e,t,s){for(let a of e)await N.postUpdateConditions(a);return super._onCreateOperation(e,t,s)}static async _onUpdateOperation(e,t,s){for(let a of e)await N.postUpdateConditions(a);return super._onUpdateOperation(e,t,s)}_calcBagweight(e,t,s=!0){let a=0;if(t.has(e._id)){let i=0;!e.system.worn.value&&s&&(a-=e.system.preparedWeight);for(let n of t.get(e._id))n.system.preparedWeight=Number(parseFloat((n.system.weight*n.system.quantity).toFixed(3))),t.has(n._id)?i+=this._calcBagweight(n,t,!1):i+=n.system.preparedWeight;s?e.system.worn.value&&(a+=i):a+=i+e.system.preparedWeight,e.system.bagweight=`${i.toFixed(3)}/${e.system.capacity||0}`}return a}effectivePain(e){let t=e.status.inpain||0;t<8&&(t-=E.vantageStep(this,game.i18n.localize("dsk.LocalizedIDs.ruggedFighter"))),t>0&&(t+=E.vantageStep(this,game.i18n.localize("dsk.LocalizedIDs.sensitiveToPain"))),t=Math.clamp(t,0,8),e.status.inpain=t}woundPain(e){let t=0;return e.stats.LeP.max>0&&(this.type!="creature"||e.stats.LeP.max>=20?(t=Math.floor((1-e.stats.LeP.value/e.stats.LeP.max)*4),e.stats.LeP.value<=5&&(t=4)):t=Math.floor(5-5*e.stats.LeP.value/e.stats.LeP.max)),Math.clamp(t,0,4)}static _calculateCombatSkillValues(e,t){return e=N._calculatePW(e,t),e.system.attack=e.PW,e.system.weapontype=="melee"?e.system.parry=Math.round(e.PW*.25):e.system.parry=0,e.cost=game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(e.system.level,e.system.StF)}),e}async prepareMerchant(){if(W(this,"system.merchant.merchantType")=="loot"){if(W(this,"system.merchant.locked")&&!this.hasCondition("locked"))await this.addCondition(N.lockedCondition());else if(!W(this,"system.merchant.locked")){let e=this.effects.find(t=>t.statuses.has("locked"));e&&await this.deleteEmbeddedDocuments("ActiveEffect",[e.id])}}}static lockedCondition(){return{id:"locked",name:game.i18n.localize("dsk.MERCHANT.locked"),img:"icons/svg/padlock.svg",flags:{dsk:{value:null,hidePlayers:!0,description:game.i18n.localize("dsk.MERCHANT.locked")}}}}isMerchant(){return["merchant","loot"].includes(W(this,"system.merchant.merchantType"))}applyActiveEffects(){let e={};this.statuses??(this.statuses=new Set);let t=new Map;for(let r of Object.values(CONFIG.specialStatusEffects))t.set(r,this.statuses.has(r));this.statuses.clear();let s=[],a=1;for(let r of this.effects){if(r.disabled)continue;a=1;let l=r.getFlag("dsk","value");l&&(a=Number(l));for(let c=0;c<a;c++)s.push(...r.changes.map(u=>(u=foundry.utils.duplicate(u),u.effect=r,u.priority=u.priority?u.priority:u.mode*10,u)));for(let c of r.statuses)this.statuses.add(c)}let i=!0;for(let r of this.items)for(let l of r.effects)if(!l.disabled){switch(i=!0,r.type){case"meleeweapon":case"rangeweapon":case"armor":i=r.system.worn.value;break;case"equipment":i=!r.system.worn.wearable||r.system.worn.wearable&&r.system.worn.value;break;case"trait":i=!["meleeAttack","rangeAttack"].includes(r.system.traitType);break;case"ammunition":case"combatskill":case"poison":case"ahnengabe":case"consumable":case"ahnengeschenk":i=!1;break;case"specialability":i=r.system.category!="Combat"||[2,3].includes(r.system.subcategory),a=Number(r.system.level)||1;break;case"advantage":case"disadvantage":a=Number(r.system.level)||1;break}if(l.notApplicable=!i,!!i){for(let c=0;c<a;c++)s.push(...l.changes.map(u=>(u=foundry.utils.duplicate(u),u.effect=l,u.priority=u.priority?u.priority:u.mode*10,u)));for(let c of l.statuses)this.statuses.add(c)}}s.sort((r,l)=>r.priority-l.priority);for(let r of s){if(!r.key)continue;let l=r.effect.apply(this,r);Object.assign(e,l)}this.overrides=foundry.utils.expandObject(e);let n;for(let[r,l]of t){let c=this.statuses.has(r);if(c!==l){n??(n=this.getActiveTokens());for(let u of n)u._onApplyStatusEffect(r,c)}}}maxDefenseValue(){let e={parry:0,name:game.i18n.localize("dsk.noDefense")},t=[],s=[];for(let a of this.items)if(a.type=="combatskill")t.push(N._calculateCombatSkillValues(a,this.system));else if(a.type=="meleeweapon")W(a,"system.worn.value")&&s.push(a);else if(a.type=="trait"&&a.system.traitType=="meleeAttack"){let i=N._prepareMeleetrait(a,this);i.parry>e.parry&&(e=i)}for(let a of s){let i=N._prepareMeleeWeapon(a,t,this,s.filter(n=>n._id!=a._id&&!R.isYieldedTwohanded(n)));i.parry>=e.parry&&(e=i)}return e}preparePostRollAction(e){let t=e.flags.data,s={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.author};return t.attackerMessage&&(s.attackerMessage=t.attackerMessage),t.defenderMessage&&(s.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(s.unopposedStartMessage=t.unopposedStartMessage),s}async useFateOnRoll(e,t,s){if(t=="isTalented"||h.fateAvailable(this,s==1)){let a=e.flags.data,i=this.preparePostRollAction(e),n,r;s==0?(n=this.system.stats.schips.value-1,r="PointsRemaining"):(n=game.settings.get("dsk","groupschips").split("/")[0],r="GroupPointsRemaining");let l=`<h3 class="center"><b>${game.i18n.localize("dsk.CHATFATE.fatepointUsed")}</b></h3>
                  ${game.i18n.format("dsk.CHATFATE."+t,{character:"<b>"+this.name+"</b>"})}<br>
                  <b>${game.i18n.localize(`dsk.CHATFATE.${r}`)}</b>: ${n}`,c=a.preData;c.extra.actor=h.getSpeaker(c.extra.speaker).toObject(!1),this[`fate${t}`](l,i,c,e,a,s)}}resetTargetAndMessage(e,t){e.originalTargets?.size&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}async fatererollDamage(e,t,s,a,i,n){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let r=await renderTemplate("systems/dsk/templates/dialog/fateReroll-dialogDamage.html",{testData:s,postData:i.postData,singleDie:i.postData.characteristics.filter(l=>l.char=="damage").length==1});new U({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:r,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async l=>{let c=l.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let u=Roll.fromData(i.postData.damageRoll),d=await _DiceDSK.manualRolls(await new Roll(u.formula||u._formula).evaluate(),"dsk.CHATCONTEXT.rerollDamage");await _DiceDSK.showDiceSoNice(d,s.rollMode);for(let T=0;T<d.dice.length;T++)d.dice[T].options.colorset="black";let f=0,p=[],b=[];for(let T of c)p.push(`${u.terms[(T-2)*2].results[0].result}/${d.terms[f*2].results[0].result}`),b.push({index:(T-2)*2,val:d.terms[f*2].results[0].result}),f+=1;u.editRollAtIndex(b),s.damageRoll=u,e+=`<br><b>${game.i18n.localize("dsk.Roll")}</b>: ${p.join(", ")}`,ChatMessage.create(h.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:s,cardOptions:t},{rerenderMessage:a}),await a.update({"flags.data.fatePointDamageRerollUsed":!0}),await this.reduceSchips(n)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async fatereroll(e,t,s,a,i,n){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let r=await renderTemplate("systems/dsk/templates/dialog/fateReroll-dialog.html",{testData:s,postData:i.postData,singleDie:i.postData.characteristics.filter(l=>l.char!="damage").length==1});new U({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:r,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async l=>{let c=l.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let u=[];for(let g of c){let y=s.roll.terms[g*2];u.push(y.number+"d"+y.faces+"["+y.options.colorset+"]")}u=await _DiceDSK.manualRolls(await new Roll(u.join("+")).evaluate(),"dsk.CHATCONTEXT.Reroll"),await _DiceDSK.showDiceSoNice(u,s.rollMode);let d=0,f=[],p=h.getSpeaker(s.extra.speaker),b=game.i18n.localize("dsk.LocalizedIDs.traditionPhex"),T=p.items.some(g=>g.type=="specialability"&&g.name==b);for(let g of c){let y=s.source.system[`characteristic${g+1}`],v=y?`${game.i18n.localize(`dsk.characteristics.${y}.abbr`)} - `:"";f.push(`${v}${s.roll.terms[g*2].results[0].result}/${u.terms[d*2].results[0].result}`),T?s.roll.terms[g*2].results[0].result=Math.min(u.terms[d*2].results[0].result,s.roll.terms[g*2].results[0].result):s.roll.terms[g*2].results[0].result=u.terms[d*2].results[0].result,d+=1}e+=`<br><b>${game.i18n.localize("dsk.Roll")}</b>: ${f.join(", ")}`,ChatMessage.create(h.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:s,cardOptions:t},{rerenderMessage:a}),await a.update({"flags.data.fatePointRerollUsed":!0}),await this.reduceSchips(n)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async fateisTalented(e,t,s,a,i){t.talentedRerollUsed=!0,this.resetTargetAndMessage(i,t),e=`<h3 class="center"><b>${game.i18n.localize("dsk.CHATFATE.fatepointUsed")}</b></h3>
              ${game.i18n.format("dsk.CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"})}<br>`;let n=await renderTemplate("systems/dsk/templates/dialog/isTalentedReroll-dialog.html",{testData:s,postData:i.postData});new U({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async r=>{let l=r.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(l.length>0){let c=[];for(let f of l){let p=s.roll.terms[f*2];c.push(p.number+"d"+p.faces+"["+p.options.colorset+"]")}c=await _DiceDSK.manualRolls(await new Roll(c.join("+")).evaluate(),"dsk.CHATCONTEXT.talentedReroll"),await _DiceDSK.showDiceSoNice(c,s.rollMode);let u=0,d=[];for(let f of l){let p=s.source.system[`characteristic${f+1}`],b=p?`${game.i18n.localize(`dsk.characteristics.${p}.abbr`)} - `:"";d.push(`${b}${s.roll.terms[f*2].results[0].result}/${c.terms[u*2].results[0].result}`),s.roll.terms[f*2].results[0].result=c.terms[u*2].results[0].result,u+=1}e+=`<b>${game.i18n.localize("dsk.Roll")}</b>: ${d.join(", ")}`,ChatMessage.create(h.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:s,cardOptions:t},{rerenderMessage:a}),await a.update({"flags.data.talentedRerollUsed":!0})}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async reduceSchips(e){e==0?await this.update({"system.stats.schips.value":this.system.stats.schips.value-1}):await N.reduceGroupSchip()}async modifyTokenAttribute(e,t,s=!1,a=!0){let i=foundry.utils.getProperty(this.system,e),n;return a?(s&&(t=Math.clamp(i.min||0,Number(i.value)+t,i.max)),n={[`system.${e}.value`]:t}):(s&&(t=Number(i)+t),n={[`system.${e}`]:t}),Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:s,isBar:a},n)!==!1?this.update(n):this}static armorValue(e,t={}){let s=e.items.filter(n=>n.type=="armor"&&n.system.worn.value==!0);t.origin&&(s=s.map(n=>{let r=we(cs(t),{armor:n});return Y.applyRollTransformation(e,r,4).options.armor}));let a=s.reduce((n,r)=>n+r.system.rs,0),i=e.items.filter(n=>n.type=="trait"&&n.system.traitType=="armor").reduce((n,r)=>n+Number(r.system.at),0);return{wornArmor:s,armor:a+i+(e.system.totalArmor||0)}}prepareBaseData(){let e=this.system;we(e,{skillModifiers:{FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AePCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],AePCost:[]},...["ahnengabe","skill"].reduce((t,s)=>(t[s]={FP:[],step:[],QL:[],TPM:[],FW:[]},t),{})},repeatingEffects:{startOfRound:{LeP:[],AeP:[]}},aepModifier:0,creatureBonus:[],stats:{initiative:{multiplier:1},LeP:{multiplier:1},regeneration:{LePgearmodifier:0,AePgearmodifier:0}},status:{encumbered:0,stunned:0,feared:0,inpain:0,selfconfidence:0},spellStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},totalArmor:0,carryModifier:0});for(let t of Object.values(e.stats))t.gearmodifier=0;for(let t of Object.values(e.characteristics))t.gearmodifier=0}prepareSheet(e){let t=cs(this),s={system:{characteristics:{}}};if(we(s,this.prepareItems(e)),s.canAdvance){let a=["LeP","AeP"];for(let i of a)we(s.system,{stats:{[i]:{cost:game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(t.system.stats[i].advances,"D")}),refund:game.i18n.format("dsk.refundCost",{cost:h._calculateAdvCost(t.system.stats[i].advances,"D",0)})}}});for(let[i,n]of Object.entries(this.system.characteristics))s.system.characteristics[i]={cost:game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(n.initial+n.advances,"Eig")}),refund:game.i18n.format("dsk.refundCost",{cost:h._calculateAdvCost(n.initial+n.advances,"Eig",0)})}}return s}_perpareItemAdvancementCost(e){return e.cost=game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(e.system.level,e.system.StF)}),e.refund=game.i18n.format("dsk.refundCost",{cost:h._calculateAdvCost(e.system.level,e.system.StF,0)}),e.canAdvance=this.system.canAdvance,e}static _prepareRangeTrait(e,t){return e.attack=Number(e.system.at)+Number(t.system.rangeStats.attack),e.LZ=Number(e.system.lz),e.LZ>0&&N.buildReloadProgress(e),this._parseDmg(e)}static _prepareRangeWeapon(e,t,s,a){let i=s.find(r=>r.name==e.system.combatskill);e.calculatedRange=e.system.rw;let n;if(i){if(e.attack=Number(i.system.attack)+Number(a.system.rangeStats.attack),e.system.ammunitionType!="-"){e.ammo=t.filter(r=>r.system.ammunitionType==e.system.ammunitionType);for(let r of e.ammo)r.label=`(${r.system.quantity}) ${r.name}`;if(n=e.ammo.find(r=>r._id==e.system.currentAmmo),n){let r=Number(n.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map(l=>Math.round(Number(l)*r)).join("/"),e.attack+=Number(n.system.atmod)||0,n.system.ammunitionType=="mag"&&(e.ammoMax=n.system.mag.max,e.ammoCurrent=n.system.mag.value)}}e.LZ=N.calcLZ(e,a),e.LZ>0&&N.buildReloadProgress(e)}else ui.notifications.error(game.i18n.format("dsk.DSKError.unknownCombatSkill",{skill:e.system.combatskill,item:e.name}));return this._parseDmg(e,n)}static _prepareMeleetrait(e,t){return e.attack=Number(e.system.at),e.parry=Math.max(0,(Number(e.system.pa)||Math.round(e.attack/4))+Number(t.system.meleeStats.parry)),this._parseDmg(e)}static _prepareMeleeWeapon(e,t,s,a=null){let i=t.find(n=>n.name==e.system.combatskill);if(i){e.attack=Number(i.system.attack)+Number(e.system.aw),e.parry=Math.max(0,i.system.parry+Number(e.system.vw)+Number(s.system.meleeStats.parry)+(e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Shields")?Number(e.system.vw):0)),e.yieldedTwoHand=R.isYieldedTwohanded(e),e.yieldedTwoHand||(a||(a=cs(s.items).filter(r=>r.type=="meleeweapon"&&r.system.worn.value&&r._id!=e._id&&!R.isYieldedTwohanded(r))),a.length>0&&(e.parry+=Math.max(...a.map(r=>r.system.vwoffhand)),e.attack+=Math.max(...a.map(r=>r.system.awoffhand))));let n=0;e.system.worn.wrongGrip&&e.yieldedTwoHand&&(e.parry-=1,n+=1),e=this._parseDmg(e),n>0&&(e.extraDamage=n,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(n)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}else ui.notifications.error(game.i18n.format("dsk.DSKError.unknownCombatSkill",{skill:e.system.combatskill,item:e.name}));return e}static _parseDmg(e,t=void 0){let s=new Roll(e.system.tp.replace(/[Ww]/g,"d"),{async:!1}),a="",i="",n="+";for(let r of s.terms)r.faces?a=r.number+"d"+r.faces:r.operator?n=r.operator:r.number&&(i+=Number(`${n}${r.number}`));if(t){let r=W(t,"system.damageMod");Number(r)?i+=`+${Number(r)}`:r&&(e.damageBonusDescription=`, ${r} ${game.i18n.localize("dsk.CHARAbbrev.damage")} ${t.name}`)}return i&&(i=Roll.safeEval(i)),e.damagedie=a||"0d6",e.damageAdd=i!=""?(Number(i)>=0?"+":"")+i:"",e}static calcLZ(e,t){let s=1,a=0;e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Throwing Weapons")?a=z.abilityStep(t,game.i18n.localize("dsk.LocalizedIDs.quickdraw"))*-1:e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Crossbows")&&z.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.quickload"))?s=.5:a=z.abilityStep(t,game.i18n.localize("dsk.LocalizedIDs.quickload"))*-1;let i=`${e.system.lz}`.split("/");if(e.system.ammunitionType=="mag"){let n=t.items.find(l=>l.id==e.system.currentAmmo||l._id==e.system.currentAmmo),r=0;n&&(n=h.toObjectIfPossible(n),n.system.mag.value<=0&&(r=1)),i=i[r]||i[0]}else i=i[0];return Math.max(0,Math.round(Number(i)*s)+a)}_setOnUseEffect(e){W(e,"flags.dsk.onUseEffect")&&(e.OnUseEffect=!0)}static _attrFromCharacteristic(e,t){return t.characteristics[e].value}static _calculatePW(e,t){return e.PW=Math.round((N._attrFromCharacteristic(e.system.characteristic1,t)+N._attrFromCharacteristic(e.system.characteristic2,t))/2)+5+(e.system.level||0),e}static buildReloadProgress(e){let t=e.system.reloadTimeprogress/e.LZ;e.title=game.i18n.format("dsk.WEAPON.loading",{status:`${e.system.reloadTimeprogress}/${e.LZ}`}),e.progress=`${e.system.reloadTimeprogress}/${e.LZ}`,t>=1&&(e.title=game.i18n.localize("dsk.WEAPON.loaded")),this.progressTransformation(e,t)}static progressTransformation(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft=`${Math.round(t*360-179)}deg`):(e.transformRight=`${Math.round(t*360+1)}deg`,e.transformLeft=0)}getArmorEncumbrance(e,t){let s=t.reduce((a,i)=>(i.system.calculatedEncumbrance=Number(i.system.encumbrance),a+=i.system.calculatedEncumbrance),0);return Math.max(0,s-z.abilityStep(e,game.i18n.localize("dsk.LocalizedIDs.inuredToEncumbrance")))}prepareItems(e){let t=this.toObject(!1),s=[],a=[],i=[],n=[],r=[],l=[],c=[],u=[],d=[],f=[],p=Object.fromEntries(Object.keys(w.specialAbilityCategories).map(S=>[S,[]])),b=Object.fromEntries(Object.keys(w.traitCategories).map(S=>[S,[]])),T={hasSpells:this.system.isMage,ahnengabe:[],ahnengeschenk:[]},g={body:[],social:[],knowledge:[],trade:[]},y={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},poison:{items:[],show:!1,dataType:"poison"},consumable:{items:[],show:!1,dataType:"consumable"}};for(let S in w.equipmentTypes)y[S]={items:[],show:!1,dataType:S};y.misc.show=!0;for(let S=1;S<=Number(t.system.stats.schips.max);S++)f.push({value:S,cssClass:S<=Number(t.system.stats.schips.value)?"fullSchip":"emptySchip"});let v=new Map;for(let S of t.items.filter(G=>G.type=="equipment"&&G.system.category=="bags"))v.set(S._id,[]);t.items=t.items.sort((S,G)=>S.name.localeCompare(G.name));let k=t.system.totalArmor||0,I=!1;for(let S of t.items)try{let G=W(S,"system.parent_id");if(S.type=="ammunition"&&d.push(N._prepareitemStructure(S)),G&&G!=S._id&&v.has(G)){v.get(G).push(S);continue}switch(e.details&&e.details.includes(S._id)&&(S.detailed="shown"),S.type){case"skill":g[S.system.group].push(N._calculatePW(this._perpareItemAdvancementCost(S,t.system),t.system));break;case"information":n.push(S);break;case"ahnengabe":T[S.type].push(N._calculatePW(this._perpareItemAdvancementCost(S),t.system));break;case"ahnengeschenk":T[S.type].push(S);break;case"combatskill":s.push(N._calculateCombatSkillValues(this._perpareItemAdvancementCost(S,t.system),t.system));break;case"ammunition":y.ammunition.items.push(N.prepareMag(S)),y.ammunition.show=!0;break;case"consumable":y.consumable.items.push(S),y.consumable.show=!0;break;case"meleeweapon":S.toggleValue=W(S.system,"worn.value")||!1,S.toggle=!0,this._setOnUseEffect(S),S.system.notInInventory||(y.meleeweapons.items.push(N._prepareitemStructure(S)),y.meleeweapons.show=!0),S.toggleValue&&u.push(S);break;case"rangeweapon":S.toggleValue=W(S.system,"worn.value")||!1,S.toggle=!0,this._setOnUseEffect(S),y.rangeweapons.items.push(N._prepareitemStructure(S)),y.rangeweapons.show=!0;break;case"armor":S.toggleValue=W(S.system,"worn.value")||!1,y.armor.items.push(N._prepareitemStructure(S)),y.armor.show=!0,S.toggle=!0,this._setOnUseEffect(S),S.system.worn.value&&(k+=Number(S.system.rs),r.push(S));break;case"trait":switch(S.system.traitType){case"rangeAttack":S=N._prepareRangeTrait(S,t);break;case"meleeAttack":S=N._prepareMeleetrait(S,t);break;case"armor":k+=Number(S.system.at);break}b[S.system.traitType].push(S),I=!0;break;case"poison":y.poison.items.push(S),y.poison.show=!0;break;case"equipment":S.toggle=W(S,"system.worn.wearable")||!1,S.toggle&&(S.toggleValue=W(S.system,"worn.value")||!1),this._setOnUseEffect(S),y[S.system.category].items.push(N._prepareitemStructure(S)),y[S.system.category].show=!0;break;case"advantage":this._setOnUseEffect(S),a.push(S);break;case"disadvantage":this._setOnUseEffect(S),i.push(S);break;case"specialability":this._setOnUseEffect(S),p[S.system.category].push(S);break}}catch(G){this._itemPreparationError(S,G)}for(let S of y.bags.items)this._setBagContent(S,v);for(let S of y.rangeweapons.items)try{S.system.worn.value&&l.push(N._prepareRangeWeapon(S,d,s,this))}catch(G){this._itemPreparationError(S,G)}for(let S of u)try{c.push(N._prepareMeleeWeapon(S,s,t,u.filter(G=>G._id!=S._id&&!R.isYieldedTwohanded(G))))}catch(G){this._itemPreparationError(S,G)}let B=cs(w.characteristics);return B["-"]="-",{totalWeight:parseFloat(this.system.totalWeight.toFixed(3)),armorSum:k,encumbrance:this.system.condition?.encumbered||0,carrycapacity:this.system.carrycapacity,wornRangedWeapons:l,guidevalues:B,wornMeleeWeapons:c,advantages:a,disadvantages:i,specAbs:p,information:n,combatskills:s,hasTrait:I,traits:b,wornArmor:r,inventory:y,canAdvance:this.system.canAdvance,sheetLocked:t.system.sheetLocked,magic:T,allSkillsLeft:{body:g.body,social:g.social},allSkillsRight:{knowledge:g.knowledge,trade:g.trade},schips:f}}setupWeapon(e,t,s,a){return s.mode=t,C.getSubClass(e.type).setupDialog(null,s,e,this,a)}setupSpell(e,t={},s){return C.getSubClass(e.type).setupDialog(null,t,e,this,s)}static _prepareitemStructure(e){let t=W(e,"flags.dsk.enchantments");return t&&t.length>0?e.enchantClass="rar":e.effects.length>0&&(e.enchantClass="common"),e}async checkEnoughXP(e){if(!this.system.canAdvance||isNaN(e)||e==null||Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=e)return!0;if(Number(this.system.details.experience.total==0)){let t=`<p>${game.i18n.localize("dsk.DSKError.zeroXP")}</p><label>${game.i18n.localize("dsk.APValue")}: </label><input type="number" name="APsel" value="150"/>`,s=0,a=!1;if([a,s]=await new Promise((i,n)=>{new Dialog({title:game.i18n.localize("dsk.DSKError.NotEnoughXP"),content:t,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:r=>{i([!0,r.find('[name="APsel"]')[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{i([!1,0])}}}}).render(!0)}),a)return await this.update({"system.details.experience.total":Number(s)}),!0}return ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughXP")),!1}getSkillModifier(e,t){let s=[],a=["FP","step","QL","TPM","FW"];for(let i of a){let n=i=="step"?"":i;s.push(...this.system.skillModifiers[i].filter(r=>r.target==e).map(r=>({name:r.source,value:r.value,type:n}))),this.system.skillModifiers[t]&&s.push(...this.system.skillModifiers[t][i].map(r=>({name:r.source,value:r.value,type:n})))}return s}setupSkill(e,t={},s){return C.getSubClass(e.type).setupDialog(null,t,e,this,s)}static prepareMag(e){return e.system.ammunitiongroup=="mag"&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}async _updateAPs(e,t={},s={}){if(this.system.canAdvance)if(!isNaN(e)&&e!=null){let a=Number(e);t["system.details.experience.spent"]=Number(this.system.details.experience.spent)+a,await this.update(t,s);let i=game.i18n.format(a>0?"dsk.advancementCost":"dsk.refundCost",{cost:Math.abs(a)});Sa(i)}else ui.notifications.error(game.i18n.localize("dsk.DSKError.APUpdateError"))}setupRegeneration(e,t={},s){let a=game.i18n.localize("dsk.regenerationTest"),i={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this.actor,s)}};i.extra.actor.isMage=this.system.isMage;let n=x.getRollModifiers(i.extra.actor,i.source),r={title:a,template:"/systems/dsk/templates/dialog/regeneration-dialog.html",data:{rollMode:t.rollMode,regenerationInterruptOptions:w.regenerationInterruptOptions,regnerationCampLocations:w.regnerationCampLocations,showAepModifier:this.system.isMage,situationalModifiers:n,modifier:t.modifier||0},callback:(c,u={})=>{i.situationalModifiers=N._parseModifiers(c),l.rollMode=c.find('[name="rollMode"]').val(),i.situationalModifiers.push({name:game.i18n.localize("dsk.camplocation")+" - "+c.find('[name="regnerationCampLocations"] option:selected').text(),value:c.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("dsk.interruption")+" - "+c.find('[name="regenerationInterruptOptions"] option:selected').text(),value:c.find('[name="regenerationInterruptOptions"]').val()}),i.regenerationFactor=c.find('[name="badEnvironment"]').is(":checked")?.5:1;let d=["LeP","AeP"],f={};for(let p of d){i[`${p}Modifier`]=Number(c.find(`[name="${p}Modifier"]`).val()||0),i[`regeneration${p}`]=Number(this.system.stats.regeneration[`${p}max`]);let b=c.find(`[name="regenerate${p}"]`).is(":checked")?1:0;i[`regenerate${p}`]=b,b&&(f[`system.stats.regeneration.${p}Temp`]=0)}return we(i.extra.options,u),this.update(f),{testData:i,cardOptions:l}}},l=this._setupCardOptions("systems/dsk/templates/chat/roll/regeneration-card.html",a,s);return _DiceDSK.setupDialog({dialogOptions:r,testData:i,cardOptions:l})}setupCharacteristic(e,t={},s){let a=this.system.characteristics[e],i=game.i18n.localize(`dsk.characteristics.${e}.name`)+" "+game.i18n.localize("dsk.probe"),n={opposable:!1,source:{type:"char",system:{characteristic1:e,characteristic2:e}},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this,s)}},r={title:i,template:"/systems/dsk/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,modifier:t.modifier||0,characteristics:[1,2].map(c=>e),hasSchips:C.hasSchips(this)},callback:(c,u={})=>(l.rollMode=c.find('[name="rollMode"]').val(),n.situationalModifiers=N._parseModifiers(c),N.schipsModifier(c,n.situationalModifiers),n.situationalModifiers.some(d=>d.name==game.i18n.localize("dsk.schips"))&&this.reduceSchips(0),C.changeChars(n.source,...[0,1].map(d=>c.find(`[name="characteristics${d}"]`).val())),we(n.extra.options,u),{testData:n,cardOptions:l})},l=this._setupCardOptions("systems/dsk/templates/chat/roll/characteristic-card.html",i,s);return _DiceDSK.setupDialog({dialogOptions:r,testData:n,cardOptions:l})}_setupCardOptions(e,t,s){let a=game.canvas.tokens.get(s),i={speaker:{alias:a?a.name:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{let n=ChatMessage.getSpeaker();n.actor==this.id&&(i.speaker.alias=n.alias,i.speaker.token=n.token,i.speaker.scene=n.scene,i.flags.img=n.token?canvas.tokens.get(n.token).img:i.flags.img)}return i}static _parseModifiers(e,t){let s=[];return e.find('[name="situationalModifiers"] option:selected').each(function(){let a=$(this).val(),i={name:$(this).text().trim().split("[")[0],value:isNaN(a)?a:Number(a),type:$(this).attr("data-type")};i.type=="dmg"&&(i.damageBonus=i.value,i.value=0),$(this).attr("data-specAbId")&&(i.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(i.armorPen=$(this).attr("data-armorPen")),s.push(i)}),s.push({name:game.i18n.localize("dsk.manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),s}static async schipsModifier(e,t){e.find('[name="schips"]').is(":checked")&&t.push({name:game.i18n.localize("dsk.schips"),value:5,type:""})}async consumeAmmunition(e){if(e.extra.ammo&&!e.extra.ammoDecreased){if(e.extra.ammoDecreased=!0,e.extra.ammo._id){let t={_id:e.extra.ammo._id};e.extra.ammo.system.ammunitionType=="mag"?e.extra.ammo.system.mag.value<=0?(e.extra.ammo.system.quantity--,t["system.quantity"]=e.extra.ammo.system.quantity,t["system.mag.value"]=e.extra.ammo.system.mag.max-1):t["system.mag.value"]=e.extra.ammo.system.mag.value-1:(e.extra.ammo.system.quantity--,t["system.quantity"]=e.extra.ammo.system.quantity),await this.updateEmbeddedDocuments("Item",[t,{_id:e.source._id,"system.reloadTimeprogress":0}])}}else(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType=="rangeAttack")&&!e.extra.ammoDecreased?(e.extra.ammoDecreased=!0,await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTimeprogress":0}])):["ahnengabe"].includes(e.source.type)&&e.extra.speaker.token!="emptyActor"&&await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}])}async basicTest({testData:e,cardOptions:t},s={}){e=await _DiceDSK.rollDices(e,t);let a=await _DiceDSK.rollTest(e);if(e.extra.options.other&&(a.other||(a.other=[]),a.other.push(...e.extra.options.other)),a.postFunction="basicTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("dsk.Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}if(await this.consumeAmmunition(e),!s.suppressMessage){let i=await _DiceDSK.renderRollCard(t,a,s.rerenderMessage);await F.handleOpposedTarget(i),a.messageId=i.id}return{result:a,cardOptions:t,options:s}}tokenScrollingText(e){let t=this.isToken?[this.token?.object]:this.getActiveTokens(!0);for(let s of t){if(!s)continue;let a=0;for(let i of e)canvas.interface.createScrollingText(s.center,i.value,{anchor:a,direction:i.value>0?2:1,fontSize:game.settings.get("dsk","scrollingFontsize"),stroke:i.stroke,strokeThickness:1,jitter:.25,duration:1e3}),a+=1}}_containsChangedAttribute(e,t){let s=W(e,t);return[null,void 0].includes(s)||s===W(this,t)?!1:s}async _preUpdate(e,t,s){let a={LeP:9109504,AeP:723929},i=[];for(let n of Object.keys(a)){let r=this._containsChangedAttribute(e,`system.stats.${n}.value`);r&&i.push({value:r-this.system.stats[n].value,stroke:a[n]})}return i.length&&this.tokenScrollingText(i),super._preUpdate(e,t,s)}_itemPreparationError(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}_setBagContent(e,t){if(t.has(e._id)){e.children=[];for(let s of t.get(e._id))e.children.push(N._prepareitemStructure(s)),t.has(s._id)&&this._setBagContent(s,t)}}async applyDamage(e){let t=Math.min(this.system.stats.LeP.max,this.system.stats.LeP.value-e);await this.update({"system.stats.LeP.value":t})}async applyRegeneration(e,t){let s={"system.stats.LeP.value":Math.min(this.system.stats.LeP.max,this.system.stats.LeP.value+(e||0)),"system.stats.AeP.value":Math.min(this.system.stats.AeP.max,this.system.stats.AeP.value+(t||0))};await this.update(s)}async applyMana(e){let t=Math.min(this.system.stats.AeP.max,this.system.stats.AeP.value-e);return t>=0?(await this.update({["data.stats.AeP.value"]:t}),!0):(ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughAeP")),!1)}async actorEffects(){let e=["dead"];return game.user.isGM||this.testUserPermission(game.user,"OBSERVER")||!await game.settings.get("dsk","hideEffects")?this.effects.filter(s=>!s.disabled&&!s.notApplicable&&(game.user.isGM||!s.getFlag("dsk","hidePlayers"))&&!s.getFlag("dsk","hideOnToken")&&(s.origin==this.uuid||!s.origin)):this.effects.filter(s=>e.some(a=>s.statuses.has(a)))}async _preCreate(e,t,s){await super._preCreate(e,t,s);let a={};e.img||(a.img="icons/svg/mystery-man-black.svg"),e.type=="character"&&we(a,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(a)}async markDead(e){let t=this.getActiveTokens();for(let s of t)s.combatant&&await s.combatant.update({defeated:e})}async addCondition(e,t=1,s=!1,a=!0){if(e=="bleeding")return await R.bleedingMessage(this);if(this.isToken&&!this.token?.object){console.warn("Actor token object is null for",this.name);return}return await x.addCondition(this,e,t,s,a)}async removeCondition(e,t=1,s=!0,a=!1){return await x.removeCondition(this,e,t,s,a)}hasCondition(e){return x.hasCondition(this,e)}},D=N;m(D,"ActorDSK"),O(D,"_baseCarryItems",new Set(["armor","meleeweapon","ammunition","rangeweapon","plant","poison","money","consumable","equipment"])),O(D,"_mageSpecs",new Set(["ahnen"]));function Ma(){let o={Rq:"roll"},e={Rq:"dice"},t={Rq:""},s=/(-|\+)?\d+/,a=/\[[a-zA-zöüäÖÜÄ&; -]+/,i=/[\[\]]/g;if(!w.statusRegex){let n=w.statusEffects.map(l=>game.i18n.localize(l.name).toLowerCase()),r=["dsk.status","dsk.condition","dsk.level","dsk.levels"].map(l=>game.i18n.localize(l)).join("|");w.statusRegex={effects:n,regex:new RegExp(`(${r}) (${n.join("|")})`,"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Ch)\[[a-zA-zöüäÖÜÄ&; -]+ (-|\+)?\d+\]/g,enricher:(n,r)=>{let l=n[0],c=n[1],u=Number(l.match(s)[0]),d=l.replace(u,"").match(a)[0].replace(i,"").trim();return $(`<a class="roll-button request-${o[c]}" data-type="skill" data-modifier="${u}" data-name="${d}"><em class="fas fa-${e[c]}"></em>${t[c]}${d} ${u}</a>`)[0]}},{pattern:w.statusRegex.regex,enricher:(n,r)=>$(Vs(n))[0]},{pattern:/@Info\[[a-zA-zöüäÖÜÄ&; -\.0-9]+\]/g,enricher:async(n,r)=>{let l=n[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),c=await fromUuid(l);if(!c||c.type!="information")return $('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0];if(!game.user.isGM)return $(`<a class="content-link"><i class="fas fa-mask"></i>${game.i18n.localize("dsk.GM notes")}</a>`)[0];let u=await renderTemplate("systems/dsk/templates/items/infopreview.html",{item:c});return $(u)[0]}},{pattern:/@PostChat\[(.*?)\]/g,enricher:async(n,r)=>{let l=n[1];return $(`<div class="row-section wrap maskfield postChatSection"><div class="col ninety"></div><div class="col ten center postContentChat" data-tooltip="dsk.SHEET.PostItem"><em class="far fa-comment-dots"></em></div><div class="col postChatContent">${l}</div></div>`)[0]}})}m(Ma,"setEnrichers");function Vs(o){let t=o[0].split(" "),s=t.shift();t=t.join(" ");let a=w.statusEffects[w.statusRegex.effects.indexOf(t.toLowerCase())];return`<span>${s} <a class="chatButton chat-condition" data-id="${a.id}"><img src="${a.img}"/>${t}</a></span>`}m(Vs,"conditionsMatcher");var{duplicate:Ci,mergeObject:Da}=foundry.utils,h=class{static chatDataSetup(e,t,s){let a={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(a.rollMode)&&(a.whisper=ChatMessage.getWhisperRecipients("GM").map(i=>i.id)),a.rollMode==="blindroll"?a.blind=!0:a.rollMode==="selfroll"&&(a.whisper=[game.user]),s&&(a.speaker=ChatMessage.getSpeaker(),a.whisper=ChatMessage.getWhisperRecipients(s)),a}static categoryLocalization(e){return game.i18n.localize(`TYPES.Item.${e}`)}static fateAvailable(e,t){return e.system.stats.schips.value>0}static isActiveGM(){let e=game.users.activeGM;return e||ui.notifications.warn(game.i18n.localize("DSKError.requiresGM")),e?.isSelf}static parseAbilityString(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:e.match(/[-+]\d{1,2}$/)!=null}}static async allSkills(e=["skill","combatskill","specialability"]){let t=game.i18n.lang=="de"?"dsk.default":"dsk.defaulten";return await this.getCompendiumEntries(t,e)}static escapeRegex(e){return(typeof e=="string"||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static replaceDies(e,t=!1){let s=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,a=t?"":"/roll ";return e.replace(s,function(i){return` [[${a}${i.replace(/[DwW]/,"d")}]]`})}static toObjectIfPossible(e){return typeof e.toObject=="function"?e.toObject(!1):Ci(e)}static async allSkillsList(e=["skill","combatskill","specialability"]){let t=await this.allSkills(e),s=[],a=[],i=[];for(let n of t)n.type=="skill"?s.push(n.name):n.type=="combatskill"&&(n.system.weapontype=="melee"?i.push(n.name):a.push(n.name));return{skills:s.sort((n,r)=>n.localeCompare(r)),rangeSkills:a.sort((n,r)=>n.localeCompare(r)),meleeSkills:i.sort((n,r)=>n.localeCompare(r))}}static replaceConditions(e){return e&&e.replace(w.statusRegex.regex,t=>Vs([t]))}static moduleEnabled(e){return game.modules.get(e)&&game.modules.get(e).active}static getSpeaker(e){let t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){let s=canvas.tokens.get(e.token);s&&(t=s.actor)}if(!t){let s=game.scenes.get(e.scene);try{s&&(t=new Token(s.getEmbeddedDocument("Token",e.token))?.actor)}catch{}}return t}static async showArtwork({img:e,name:t,uuid:s,isOwner:a},i=!1){new ImagePopout(e,{title:i?a?t:"-":t,shareable:!0,uuid:s}).render(!0)}static renderToggle(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}static async skillByName(e){let t=game.packs.get(game.i18n.lang=="de"?"dsk.default":"dsk.defaulten");await t.getIndex();let s=t.index.find(a=>a.name===e);return await t.getDocument(s._id)}static async emptyActor(e=12){Array.isArray(e)||(e=[e,e,e,e,e,e,e,e]);let t=new D({name:"Alricat",type:"npc",items:[],system:{stats:{LeP:{value:50},schips:{}},characteristics:{mu:{initial:e[0]},kl:{initial:e[1]},in:{initial:e[2]},ch:{initial:e[3]},ff:{initial:e[4]},ge:{initial:e[5]},ko:{initial:e[6]},kk:{initial:e[7]}}}},{noHook:!0});return t.prepareData(),t}static calcTokenSize(e,t){let s=game.dsk.config.tokenSizeCategories[e.system.details.size];if(s)if(s<1)Da(t,{texture:{scaleX:s,scaleY:s},width:1,height:1});else{let a=Math.floor(s),i=Math.max(s/a,.25);Da(t,{width:a,height:a,texture:{scaleX:i,scaleY:i}})}}static _calculateAdvCost(e,t,s=1){return w.advancementCosts[t][Number(e)+s]}static async getCompendiumEntries(e,t){let s=await game.packs.get(e);if(!s)return ui.notifications.error("No content found"),[];let a=Array.isArray(t)?t:[t];return(await s.getDocuments()).filter(n=>a.includes(n.type)).map(n=>n.toObject())}static async getFolderForType(e,t=null,s=null,a=0,i="",n=void 0){let r=await game.folders.contents.find(l=>l.name==s&&l.type==e&&l.folder?.id==t);return r||(r=await Folder.create({name:s,type:e,sorting:n||(e=="JournalEntry"?"a":"m"),color:i,sort:a,folder:t})),r}};m(h,"DSKUtility");var{mergeObject:ds}=foundry.utils,ve=class{static async showDialog(e){let[t]=await new Promise((s,a)=>{new Dialog({title:game.i18n.localize("dsk.Migrakel.Migration"),content:e,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{s([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{s([!1])}}},close:()=>{s([!1])}}).render(!0)});return t}static async refreshStatusEffects(e){let t=[];for(let s of e.effects)if(s.origin){let a;try{a=await fromUuid(s.origin)}catch{}a||t.push(s.id)}await e.deleteEmbeddedDocuments("ActiveEffect",t)}static async updateVals(e,t,s){let a=game.dsk.itemLibrary,i=[],n=[],r=new Map;if(await this.refreshStatusEffects(e),t({type:"equipment"})){let l=[],c=[];for(let d of e.items.filter(f=>f.type=="equipment"&&f.system.category=="bags")){let f=await a.findCompendiumItem(d.name,d.type);if(f.length>0){if(f=f.find(b=>b.name==d.name&&b.type==d.type),!f)continue;console.log(`MIGRATION - Updated ${d.name}`);let p=ds(d.toObject(),s(f));c.push(p),l.push(d.id)}}let u=await e.createEmbeddedDocuments("Item",c);for(let d=0;d<u.length;d++)r.set(l[d],u[d].id);await e.deleteEmbeddedDocuments("Item",l)}for(let l of e.items.filter(c=>t(c)&&!(c.type=="equipment"&&c.system.category=="bags"))){let c=await a.findCompendiumItem(l.name,l.type);if(c.length>0){if(c=c.find(d=>d.name==l.name&&d.type==l.type),!c)continue;console.log(`MIGRATION - Updated ${l.name}`);let u=ds(l.toObject(),s(c));u.system.parent_id&&r.has(u.system.parent_id)&&(u.system.parent_id=r.get(u.system.parent_id)),n.push(u),i.push(l.id)}}await e.createEmbeddedDocuments("Item",n),await e.deleteEmbeddedDocuments("Item",i),ui.notifications.notify(game.i18n.localize("dsk.Migrakel.migrationDone"))}static async updateSpellsAndLiturgies(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.spells"))){let t=m(a=>["spell","liturgy","ritual","ceremony","spellextension"].includes(a.type),"condition"),s=m(a=>({effects:a.effects.toObject()}),"updator");await this.updateVals(e,t,s)}}static async updateSpecialAbilities(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.abilities"))){let t=m(a=>{let i={system:{effect:{value:a.system.effect}},effects:a.effects.toObject()};return a.type=="specialability"&&ds(i,{system:{category:{sub:a.system.category.sub||0},list:{value:a.system.list.value}}}),this.updateMacro(i,a),i},"updator"),s=m(a=>["specialability","advantage","disadvantage","trait"].includes(a.type),"condition");await this.updateVals(e,s,t)}}static async updateCombatskills(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.cskills"))){let t=m(a=>({effects:a.effects.toObject()}),"updator"),s=m(a=>["combatskill"].includes(a.type),"condition");await this.updateVals(e,s,t)}}static async updateSkills(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.skills"))){let t=m(a=>["skill"].includes(a.type),"condition"),s=m(a=>({img:a.img}),"updator");await this.updateVals(e,t,s)}}static updateMacro(e,t){let s=t.getFlag("dsk","onUseEffect");s&&ds(e,{flags:{dsk:{onUseEffect:s}}})}static async updateGear(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.gear"))){let t=m(a=>["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(a.type),"condition"),s=m(a=>{let i={img:a.img,effects:a.effects.toObject()};return this.updateMacro(i,a),i},"updator");await this.updateVals(e,t,s)}}};m(ve,"Migrakel");var Te=class extends Dialog{constructor(e,t){super(t),this.actor=e,this.lock=!1}static async buildDialog(e){let t=await renderTemplate("systems/dsk/templates/actors/parts/actorConfig.html",{actor:e});new Te(e,{title:game.i18n.localize("dsk.SHEET.actorConfig"),content:t,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.save"),callback:s=>{e.update({"system.config.autoBar":s.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":s.find('[name="autoSize"]').is(":checked")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async updateWrapper(e,t){return ui.notifications.warn("There is nothing to migrate yet.")}activateListeners(e){super.activateListeners(e),e.find(".updateSpells").click(async t=>this.updateWrapper("updateSpellsAndLiturgies",t)),e.find(".updateAbilities").click(async t=>this.updateWrapper("updateSpecialAbilities",t)),e.find(".updatecSkills").click(async t=>this.updateWrapper("updateCombatskills",t)),e.find(".updateSkills").click(async t=>this.updateWrapper("updateSkills",t)),e.find(".updateGear").click(async t=>this.updateWrapper("updateGear",t))}};m(Te,"DialogActorConfig");function xe(o,e="img"){!game.user.isGM||o.find(e).each(function(t,s){s.setAttribute("draggable",!0),s.addEventListener("dragstart",a=>Mi(a))})}m(xe,"bindImgToCanvasDragStart");var Mi=m(o=>{canvas.tiles.activate();let e=o.currentTarget.src,t=o.currentTarget,s=canvas.dimensions.sceneHeight/t.naturalHeight,a=canvas.dimensions.sceneWidth/t.naturalWidth,i=Math.min(1,a,s),n=Math.round(canvas.dimensions.size/i),r={type:"Tile",texture:{src:e},tileSize:n};o.dataTransfer.setData("text/plain",JSON.stringify(r));let l=t.naturalWidth*i*canvas.stage.scale.x,c=t.naturalHeight*i*canvas.stage.scale.y,u=DragDrop.createDragImage(t,l,c);o.dataTransfer.setDragImage(u,l/2,c/2)},"dragTileImg");var{mergeObject:Ia,getProperty:He,duplicate:mt}=foundry.utils,de=class extends ActorSheet{async _render(e=!1,t={}){this._saveSearchFields(),this._saveCollapsed(),await super._render(e,t),this._setCollapsed(),this._restoreSeachFields();let s=$(this._element),a={".close":"dsk.SHEET.Close",".configure-sheet":"dsk.SHEET.Configure",".configure-token":"dsk.SHEET.Token",".import":"dsk.SHEET.Import"};for(let i of Object.keys(a))s.find(i).attr("data-tooltip",game.i18n.localize(a[i]));this.currentFocus&&(s.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null)}async swapWeaponHand(e){let t=this._getItemId(e),s=this.actor.items.get(t);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.wrongGrip":!s.system.worn.wrongGrip}])}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],Ia(e,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),e}_saveSearchFields(){if(this.form===null)return;let e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}_restoreSeachFields(){if(this.searchFields!=null){let e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));let t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),this.searchFields.searchText!=""&&this._filterTalents(t);let s=$(e.find(".gearSearch"));s.val(this.searchFields.gearSearch),this.searchFields.searchText!=""&&this._filterGear(s)}}_saveCollapsed(){if(this.form===null)return;let e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];let t=e.find(".ch-collapse i");for(let s of t)this.collapsedBoxes.push($(s).attr("class"));for(let s of $(e.find(".expandDetails.shown")))this.openDetails.push($(s).closest(".item").attr("data-item-id"))}_setCollapsed(){let e=$(this.form).parent();if(this.collapsedBoxes){let t=e.find(".ch-collapse i");for(let s=0;s<t.length;s++)$(t[s]).attr("class",this.collapsedBoxes[s]),this.collapsedBoxes[s]&&this.collapsedBoxes[s].indexOf("fa-angle-down")!=-1&&$(t[s]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}}async getData(e){let t=await super.getData(e);this.wrapperLocked=!1;let s={actor:t.actor,editable:t.editable,limited:t.limited,owner:t.owner};return s.prepare=this.actor.prepareSheet({details:this.openDetails}),s.sizeCategories=w.sizeCategories,s.isGM=game.user.isGM,s.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},x.prepareActiveEffects(this.actor,s),s.enrichedOwnerdescription=await TextEditor.enrichHTML(He(this.actor.system,"notes.owner"),{secrets:this.object.isOwner,async:!0}),s.enrichedGmdescription=await TextEditor.enrichHTML(He(this.actor.system,"notes.gm"),{secrets:this.object.isOwner,async:!0}),s.enrichedNotes=await TextEditor.enrichHTML(He(this.actor.system,"notes.description"),{secrets:this.object.isOwner,async:!0}),s.enrichedBiography=await TextEditor.enrichHTML(He(this.actor.system,"notes.biography"),{secrets:this.object.isOwner,async:!0}),s}async _openLibrary(){game.dsk.itemLibrary.render(!0)}async _configActor(){Te.buildDialog(this.actor)}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"library",icon:"fas fa-university",tooltip:"dsk.SHEET.Library",onclick:async()=>this._openLibrary()}),this.actor.isOwner&&e.unshift({class:"actorConfig",tooltip:"dsk.SHEET.actorConfig",icon:"fas fa-link",onclick:async()=>this._configActor()}),this.actor.system.canAdvance&&e.unshift({class:"locksheet",tooltip:"dsk.SHEET.Lock",icon:`fas fa-${this.actor.system.sheetLocked?"":"un"}lock`,onclick:async t=>this._changeAdvanceLock(t)}),e}async _changeAdvanceLock(e){await this.actor.update({"system.sheetLocked":!this.actor.system.sheetLocked}),$(e.currentTarget).find("i").toggleClass("fa-unlock fa-lock")}showLimited(){return!game.user.isGM&&this.actor.limited}getTokenId(){return this.token?this.token.id:void 0}activateListeners(e){super.activateListeners(e);let t=m(d=>{this.actor.items.get(this._getItemId(d)).postItem()},"posthand");e.find(".schip").click(d=>{d.preventDefault();let f=Number(d.currentTarget.getAttribute("data-val"));f==1&&$(this.form).find(".fullSchip").length==1&&(f=0),this.actor.update({"system.stats.schips.value":f})}),e.find(".swapWeaponHand").click(d=>this.swapWeaponHand(d)),e.find(".loadWeapon").mousedown(async d=>{let f=this._getItemId(d),p=this.actor.items.get(f).toObject();if(He(p,"system.currentAmmo")==="")return;let b={_id:f};if(d.button==0){let T=p.type=="trait"?p.system.lz:D.calcLZ(p,this.actor);b["system.reloadTimeprogress"]=Math.min(p.system.reloadTimeprogress+1,T)}else d.button==2&&(b["system.reloadTimeprogress"]=0);await this.actor.updateEmbeddedDocuments("Item",[b])}),e.find(".item-swapMag").click(async d=>{await this.actor.swapMag(this._getItemId(d))}),e.find(".ammo-selector").change(async d=>{d.preventDefault();let f=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:f,"system.currentAmmo":$(d.currentTarget).val()}])}),e.find(".condition-edit").click(async d=>{(d.currentTarget.dataset.uuid?await fromUuid(d.currentTarget.dataset.uuid):this.actor.effects.get(d.currentTarget.dataset.id)).sheet.render(!0)}),e.find(".ch-collapse").click(d=>{$(d.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(d.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()}),e.find(".item-toggle").click(d=>{let f=this._getItemId(d),p=this.actor.items.get(f).toObject();switch(p.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":this.actor.updateEmbeddedDocuments("Item",[{_id:f,"system.worn.value":!p.system.worn.value}]),J.playEquipmentWearStatusChange(p);break}}),e.find(".status-create").click(d=>{let f=$(d.currentTarget).closest(".statusEffectMenu").find("ul");f.fadeIn("fast",()=>{f.find("input").focus()})}),e.find(".statusEffectMenu ul").mouseleave(d=>$(d.currentTarget).fadeOut()),e.find(".status-add").click(async d=>{let f=$(d.currentTarget).attr("data-id");f=="custom"?x.createCustomEffect(this.actor):await this.actor.addCondition(f,1,!1,!1)}),e.find(".skill-select").mousedown(d=>{let f=this._getItemId(d),p=this.actor.items.get(f);d.button==0?this.actor.setupSkill(p,{},this.getTokenId()).then(b=>{this.actor.basicTest(b)}):d.button==2&&p.sheet.render(!0)}),e.find(".advance-attribute").mousedown(d=>this.advanceWrapper(d,"_advanceAttribute",$(d.currentTarget).attr("data-attr"))),e.find(".refund-attribute").mousedown(d=>this.advanceWrapper(d,"_refundAttributeAdvance",$(d.currentTarget).attr("data-attr"))),e.find(".advance-item").mousedown(d=>this.advanceWrapper(d,"_advanceItem",this._getItemId(d))),e.find(".refund-item").mousedown(d=>this.advanceWrapper(d,"_refundItemAdvance",this._getItemId(d))),e.find(".advance-points").mousedown(d=>this.advanceWrapper(d,"_advancePoints",$(d.currentTarget).attr("data-attr"))),e.find(".refund-points").mousedown(d=>this.advanceWrapper(d,"_refundPointsAdvance",$(d.currentTarget).attr("data-attr"))),e.find(".spell-select").mousedown(d=>{let f=this._getItemId(d),p=this.actor.items.get(f);d.button==0?this.actor.setupSpell(p,{},this.getTokenId()).then(b=>this.actor.basicTest(b)):d.button==2&&p.sheet.render(!0)}),e.find(".quantity-click").mousedown(d=>{let f=this._getItemId(d),p=this.actor.items.get(f).toObject();R.increment(d,p,"system.quantity",0),this.actor.updateEmbeddedDocuments("Item",[p])}),e.find(".item-post").click(d=>t(d)),e.find(".item-dropdown").click(d=>{d.preventDefault(),$(d.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")}),e.find(".condition-show").mousedown(d=>{d.preventDefault();let f=d.currentTarget.dataset.id,p=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");if(d.button==0){let b=$(d.currentTarget).parents(".statusEffect").attr("data-origin");if(b)fromUuid(b).then(T=>T.sheet.render(!0));else{let T,g;p?(T=CONFIG.statusEffects.find(v=>v.id==p),g=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${T.id}"><img src="${T.img}"/>${game.i18n.localize(T.name)}</a></b>: ${game.i18n.localize(T.description)}</div>`)):(T=this.actor.effects.find(v=>v.id==f),T&&(g=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${T.id}"><img src="${T.img}"/>${game.i18n.localize(T.name)}</a></b>: ${game.i18n.localize(T.flags.dsk.description)}</div>`)));let y=$(d.currentTarget).closest(".groupbox").find(".effectDescription");y.fadeOut("fast",function(){y.html(g).fadeIn("fast")})}}else d.button==2&&!d.currentTarget.dataset.locked&&this._deleteActiveEffect(f)}),e.on("click",".chat-condition",d=>H.postStatus($(d.currentTarget).attr("data-id"))),e.find(".skill-advances").change(async d=>{let f=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:f,"system.level":Number(d.target.value)}])}),e.find(".item-edit").click(d=>{d.preventDefault();let f=this._getItemId(d);this.actor.items.get(f).sheet.render(!0)}),e.find(".disableRegeneration").click(d=>{let p=`system.repeatingEffects.disabled.${d.currentTarget.dataset.type}`;this.actor.update({[p]:!He(this.actor,p)})}),e.find(".consume-item").mousedown(d=>{if(d.button==2){let f=this._getItemId(d),p=this.actor.items.get(f);this.consumeItem(p)}}),e.find(".ch-value").click(d=>{d.preventDefault();let f=d.currentTarget.attributes["data-char"].value;this.actor.setupCharacteristic(f,{},this.getTokenId()).then(p=>this.actor.basicTest(p))}),e.find(".ch-regenerate").click(d=>{d.preventDefault(),this.actor.setupRegeneration("regenerate",{},this.getTokenId()).then(f=>this.actor.basicTest(f))}),e.find(".item-create").click(d=>this._onItemCreate(d)),e.find(".ch-rollCombat").click(d=>{d.preventDefault();let f=this._getItemId(d),p=$(d.currentTarget).attr("data-mode"),b=this.actor.items.get(f);this.actor.setupWeapon(b,p,{},this.getTokenId()).then(T=>this.actor.basicTest(T))});let s=m(d=>this._deleteItem(d),"deletehand");e.find(".onUseItem").click(d=>this._onMacroUseItem(d)),e.find(".cards .item").mouseenter(d=>{if(d.currentTarget.getElementsByClassName("hovermenu").length==0){let f=document.createElement("div");f.classList.add("hovermenu");let p=document.createElement("i");p.classList.add("fas","fa-times"),p.title=game.i18n.localize("dsk.SHEET.DeleteItem"),p.addEventListener("click",s,!1);let b=document.createElement("i");b.classList.add("fas","fa-comment"),b.title=game.i18n.localize("dsk.SHEET.PostItem"),b.addEventListener("click",t,!1),f.appendChild(b),f.appendChild(p),d.currentTarget.appendChild(f)}}),e.find(".cards .item").mouseleave(d=>{let f=d.toElement||d.relatedTarget;!f||f.parentNode==this||f==this||d.currentTarget.querySelectorAll(".hovermenu").forEach(p=>p.remove())});let a=this.actor.uuid;e.find(".actorDrag").each(function(d,f){f.setAttribute("draggable",!0),f.addEventListener("dragstart",p=>{let b={type:"Actor",uuid:a};p.dataTransfer.setData("text/plain",JSON.stringify(b))})}),e.find(".item-delete").click(d=>this._deleteItem(d)),e.find(".filterTalents").click(d=>{$(d.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(d.currentTarget).toggleClass("filtered")}),e.find(".condition-value").mousedown(async d=>{let f=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");d.button==0?await this.actor.addCondition(f,1,!1,!1):d.button==2&&await this.actor.removeCondition(f,1,!1)}),e.find(".condition-toggle").mousedown(async d=>{if(!this.isEditable)return;let f=$(d.currentTarget).parents(".statusEffect").attr("data-id"),p=this.actor.effects.get(f);await p.update({disabled:!p.disabled})}),e.find(".charimg").mousedown(d=>{d.button==2&&h.showArtwork(this.actor,!0)}),q.bindRollCommands(e);let i=m(d=>this._filterTalents($(d.currentTarget)),"filterTalents"),n=e.find(".talentSearch");n.keyup(d=>this._filterTalents($(d.currentTarget))),n[0]&&n[0].addEventListener("search",i,!1);let r=m(d=>this._filterConditions($(d.currentTarget)),"filterConditions"),l=e.find(".conditionSearch");l.keyup(d=>this._filterConditions($(d.currentTarget))),l[0]&&l[0].addEventListener("search",r,!1);let c=m(d=>this._filterGear($(d.currentTarget)),"filterGear"),u=e.find(".gearSearch");u.keyup(d=>this._filterGear($(d.currentTarget))),u[0]&&u[0].addEventListener("search",c,!1),xe(e,"img.charimg")}async advanceWrapper(e,t,s){this.wrapperLocked||(this.wrapperLocked=!0,$(e.currentTarget).find("i").addClass("fa-spin fa-spinner"),await this[t](s))}async _advanceAttribute(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial),s=h._calculateAdvCost(t,"Eig");await this._checkEnoughXP(s)&&await this._updateAPs(s,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)+1})}async _refundAttributeAdvance(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial);if(Number(this.actor.system.characteristics[e].advances)>0){let s=h._calculateAdvCost(t,"Eig",0)*-1;await this._updateAPs(s,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)-1})}}async _advancePoints(e){let t=Number(this.actor.system.stats[e].advances),s=h._calculateAdvCost(t,"D");await this._checkEnoughXP(s)&&this._checkMaximumPointAdvancement(e,t+1)&&await this._updateAPs(s,{[`system.stats.${e}.advances`]:Number(this.actor.system.stats[e].advances)+1})}async _refundPointsAdvance(e){let t=Number(this.actor.system.stats[e].advances);if(t>0){let s=h._calculateAdvCost(t,"D",0)*-1;await this._updateAPs(s,{[`system.stats.${e}.advances`]:Number(this.actor.system.stats[e].advances)-1})}}async _advanceItem(e){let t=this.actor.items.get(e).toObject(),s=h._calculateAdvCost(Number(t.system.level),t.system.StF);await this._checkEnoughXP(s)&&this._checkMaximumItemAdvancement(t,Number(t.system.level)+1)&&(await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.level":t.system.level+1}]),await this._updateAPs(s))}async _refundItemAdvance(e){let t=this.actor.items.get(e).toObject();if(t.system.level>0){let s=h._calculateAdvCost(Number(t.system.level),t.system.StF,0)*-1;await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.level":t.system.level-1}]),await this._updateAPs(s)}}_checkMaximumItemAdvancement(e,t){let s=!1;switch(e.type){case"combatskill":s=t<=this.maxByAttr(e,"dsk.LocalizedIDs.exceptionalCombatTechnique");break;case"ahnengabe":case"skill":s=t<=this.maxByAttr(e,"dsk.LocalizedIDs.exceptionalSkill");break}return s||ui.notifications.error(game.i18n.localize("dsk.DSKError.AdvanceMaximumReached")),s}maxByAttr(e,t){return Math.max(this.actor.system.characteristics[e.system.characteristic1].value,this.actor.system.characteristics[e.system.characteristic2].value)+2+E.vantageStep(this.actor,`${game.i18n.localize(t)} (${e.name})`)}async _checkEnoughXP(e){return await this.actor.checkEnoughXP(e)}_checkMaximumPointAdvancement(e,t){let s=!1;switch(e){case"LeP":s=t<=this.actor.system.characteristics.ko.value;break;case"AeP":s=t<=(this.actor.system.characteristics[this.actor.system.guidevalue]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue].value);break}return s||ui.notifications.error(game.i18n.localize("dsk.DSKError.AdvanceMaximumReached")),s}_onItemCreate(e){e.preventDefault();let t=e.currentTarget,s=mt(t.dataset);w.equipmentTypes[s.type]&&(s.type="equipment",s=Ia(s,{"system.category":e.currentTarget.attributes["item-section"].value,"system.effect":""})),["aggregatedTest","ahnengabe"].includes(s.type)||(s["system.weight"]=0,s["system.quantity"]=0),C.defaultIcon(s),s.name=h.categoryLocalization(s.type),this.actor.createEmbeddedDocuments("Item",[s])}_onMacroUseItem(e){let t=this.actor.items.get(this._getItemId(e));new OnUseEffect(t).executeOnUseEffect()}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),s=$(this.element).find(".inventory .item");s.removeClass("filterHide"),s.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}_filterTalents(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),s=$(this.form).parent().find(".allTalents");s.find(".item, .table-header, .table-title").removeClass("filterHide"),s.addClass("showAll").find(".item").filter(function(){return $(this).find(".talentName").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide"),t.length>0?(s.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),s.addClass("filterfull")):s.removeClass("filterfull")}}_filterConditions(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),s=$(this.form).find(".statusEffectMenu li:not(.search)");s.removeClass("filterHide"),s.filter(function(){return game.i18n.localize($(this).find("a").attr("data-tooltip")).toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async _deleteActiveEffect(e){if(!this.isEditable)return;let t=this.actor.effects.get(e);t&&this.actor.deleteEmbeddedDocuments("ActiveEffect",[t.id])}_deleteItem(e){if(!this.isEditable)return;let t=this._getItemId(e),s=this.actor.items.get(t),a=game.i18n.format("dsk.DIALOG.DeleteItemDetail",{item:s.name});renderTemplate("systems/dsk/templates/dialog/delete-item-dialog.html",{message:a}).then(i=>{new Dialog({title:game.i18n.localize("dsk.DIALOG.deleteConfirmation"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>this._cleverDeleteItem(t)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)})}async _addVantage(e,t){E.needsAdoption(this.actor,e,t)}async _addSpecialAbility(e,t){z.needsAdoption(this.actor,e,t)}async _cleverDeleteItem(e){let t=this.actor.items.get(e),s=[e];switch(t.type){case"advantage":case"disadvantage":{await E.vantageRemoved(this.actor,t);let a=t.system.ap*(t.system.level||1);if(/;/.test(t.system.ap)){let i=t.system.ap.split(";").map(n=>Number(n.trim()));a=0;for(let n=0;n<t.system.level;n++)a+=i[n]}await this._updateAPs(-1*a,{},{render:!1})}break;case"specialability":await z.abilityRemoved(this.actor,t);break;case"ahnengeschenk":await this._updateAPs(-1);break;case"ahnengabe":{let a=0;for(let i=0;i<=t.system.level;i++)a+=h._calculateAdvCost(i,t.system.StF,0);await this._updateAPs(a*-1,{},{render:!1})}break}await this.actor.deleteEmbeddedDocuments("Item",s)}_getItemId(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}_onDragStart(e){let t=e.currentTarget;if(e.target.classList.contains("content-link"))return;let s;t.dataset.itemId&&(s=this.actor.items.get(t.dataset.itemId).toDragData(),t.dataset.mod&&(s.mod=t.dataset.mod)),t.dataset.id&&(s=this.actor.effects.get(t.dataset.id).toDragData()),s&&e.dataTransfer.setData("text/plain",JSON.stringify(s))}async _addUniqueItem(e){if(e=mt(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async handleItemCopy(e,t){if(w.equipmentCategories.includes(t))return e.name+=" (Copy)",await this._addLoot(e)}async _addLoot(e){e=mt(e);let t=this.actor.items.find(s=>C.areEquals(e,s));return t?(await C.stackItems(t,e,this.actor))[0]:(this._tabs[0].active=="combat"&&e.system.worn&&(e.system.worn.value=!0),(await this.actor.createEmbeddedDocuments("Item",[e]))[0])}async _manageDragItems(e,t){switch(t){case"meleeweapon":case"rangeweapon":case"equipment":case"ammunition":case"consumable":case"armor":case"poison":return await this._addLoot(e);case"disadvantage":case"advantage":await this._addVantage(e,t);break;case"specialability":await this._addSpecialAbility(e,t);break;case"information":case"skill":await this._addUniqueItem(e);break;case"ahnengabe":case"ahnengeschenk":await this._addSpellOrLiturgy(e);break;case"effectwrapper":await this._handleEffectWrapper(e);break;default:ui.notifications.error(game.i18n.format("dsk.DSKError.canNotBeAdded",{item:e.name,category:game.i18n.localize(e.type)}))}}async _updateAPs(e,t={},s={}){await this.actor._updateAPs(e,t,s)}async _addSpellOrLiturgy(e){let t=this.actor.items.find(a=>a.type==e.type&&a.name==e.name),s;if(e=mt(e),!t){switch(e.type){case"ahnengabe":s=h._calculateAdvCost(0,e.system.StF,0);break;case"ahnengeschenk":s=1;break;default:return}await this.actor.checkEnoughXP(s)&&(await this._updateAPs(s,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}async _addUniqueItem(e){if(e=mt(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async _handleEffectWrapper(e){this.actor.createEmbeddedDocuments("ActiveEffect",e.effects.map(t=>(t.origin=null,t)))}async _onDropItemCreate(e){return e instanceof Array?this.actor.createEmbeddedDocuments("Item",e):await this._manageDragItems(e,e.type)}async _onDropActor(e,t){if(!this.actor.isOwner)return!1;let{item:s,typeClass:a,selfTarget:i}=await ls(t,this.id,!1);if(!i)return await this._manageDragItems(s,a)}async _onDropActiveEffect(e,t){let s=await ActiveEffect.implementation.fromDropData(t);if(!this.actor.isOwner||!s||this.actor.uuid===s.parent?.uuid)return!1;let a=s.toObject();return a.origin=this.actor.uuid,ActiveEffect.create(a,{parent:this.actor})}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;let s=await Item.implementation.fromDropData(t),a=s.toObject();R.obfuscateDropData(a,t.tabsinvisible);let i,n=$(e.target).parents(".item");n&&n.attr("data-category")=="bags"&&w.equipmentCategories.includes(s.type)&&n.attr("data-item-id")!=s.id&&(i=n.attr("data-item-id"));let r=this.actor.uuid===s.parent?.uuid;if(r)if(e.ctrlKey)await this.handleItemCopy(a,s.type);else if(i){let l={_id:s.id,"system.parent_id":i};s.system.worn&&s.system.worn.value&&(l["system.worn.value"]=!1),await this.actor.updateEmbeddedDocuments("Item",[l])}else w.equipmentCategories.includes(s.type)&&await this.actor.updateEmbeddedDocuments("Item",[{_id:s.id,system:{parent_id:0}}]);else await this._onDropItemCreate(a);e.altKey&&!r&&w.equipmentCategories.includes(s.type)&&await this._handleRemoveSourceOnDrop(s)}};m(de,"ActorSheetDSK");var{getProperty:Di}=foundry.utils,Se=m(o=>class extends o{async obfuscateItem(e){e.stopPropagation(),e.preventDefault();let t=e.currentTarget.dataset.obfuscate;await this.item.update({[`system.obfuscation.${t}`]:!this.isObfuscated(t)})}isObfuscated(e){return Di(this.item,`system.obfuscation.${e}`)}activateListeners(e){super.activateListeners(e),e.on("click",".obfuscateSection",t=>this.obfuscateItem(t))}obfuscationCss(e){return this.isObfuscated(e)?"":" pale"}async _render(e=!1,t={}){await super._render(e,t);let s=["details","effects","description","enchantment"],a=!1;for(let i of s){let n=$(this._element).find(`nav [data-tab="${i}"]`);if(!n.length)continue;let r=t.tabsinvisible||this.isObfuscated(i),l=game.i18n.localize(`dsk.SHEET.${r?"deobfuscateItem":"obfuscateItem"}`);if(game.user.isGM){let c=`obfuscateSection${this.obfuscationCss(i)}`,u=n.find(`.${c}`),d=`<a data-tooltip="${l}" class="obfuscationBtn ${c}" data-obfuscate="${i}"><i class="fas fa-mask"></i></a>`;u.length?u.replaceWith(d):n.append(` ${d}`)}else r&&(n.hasClass("active")&&(a=!0),n.remove(),i=="details"&&$(this._element).find('[name="system.price"]').replaceWith("<label>?</label>"))}if(a){let i=$(this._element).find("nav .item:first-child");if(i.length)this.activateTab(i.attr("data-tab"));else{let n=await renderTemplate("systems/dsk/templates/items/obfuscatedItem.html",{item:this.item});$(this._element).find(".content").html(n)}}}},"ItemSheetObfuscation");var{mergeObject:K,getProperty:Be}=foundry.utils,L=class extends ItemSheet{static setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsk",gs,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsk",hs,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsk",ys,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsk",ks,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsk",bs,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsk",ws,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsk",vs,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsk",Ts,{makeDefault:!0,types:["profession"]}),Items.registerSheet("dsk",ut,{makeDefault:!0,types:["advantage"]}),Items.registerSheet("dsk",Ss,{makeDefault:!0,types:["disadvantage"]}),Items.registerSheet("dsk",Cs,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsk",Ms,{makeDefault:!0,types:["ahnengeschenk"]}),Items.registerSheet("dsk",Ds,{makeDefault:!0,types:["ahnengabe"]}),Items.registerSheet("dsk",Is,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsk",ft,{makeDefault:!0,types:["skill"]}),Items.registerSheet("dsk",As,{makeDefault:!0,types:["combatskill"]}),Items.registerSheet("dsk",fs,{makeDefault:!0,types:["information"]}),Items.registerSheet("dsk",ms,{makeDefault:!0,types:["effectwrapper"]}),Items.registerSheet("dsk",us,{makeDefault:!0,types:["trait"]}),Items.registerSheet("dsk",ps,{makeDefault:!0,types:["consumable"]})}setupEffect(e){this.item.setupEffect().then(t=>this.item.itemTest(t))}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:async()=>this.item.postItem()}),e}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content"}],K(e,{classes:e.classes.concat(["dsk","item"]),width:450,height:500}),e}get template(){return`systems/dsk/templates/items/item-${this.item.type}-sheet.html`}async getData(e){let t=super.getData(e).data;return this.wrapperLocked=!1,K(t,{isOwned:this.item.actor,editable:this.isEditable,item:this.item,isGM:game.user.isGM,enrichedDescription:await TextEditor.enrichHTML(Be(this.item.system,"description.value"),{secrets:this.object.isOwner,async:!0}),enrichedGmdescription:await TextEditor.enrichHTML(Be(this.item.system,"description.gminfo"),{secrets:this.object.isOwner,async:!0})}),x.prepareActiveEffects(this.item,t),t}async advanceWrapper(e,t){this.wrapperLocked||(this.wrapperLocked=!0,$(e.currentTarget).find("i").addClass("fa-spin fa-spinner"),await this[t]())}activateListeners(e){super.activateListeners(e),e.find(".advance-step").mousedown(s=>this.advanceWrapper(s,"_advanceStep")),e.find(".refund-step").mousedown(s=>this.advanceWrapper(s,"_refundStep")),e.find('[data-edit="img"]').mousedown(s=>{s.button==2&&h.showArtwork(this.item)}),e.find(".status-add").click(()=>{this.item.actor?ui.notifications.error(game.i18n.localize("dsk.DSKError.nestedEffectNotSupported")):x.createCustomEffect(this.item,"",this.item.name)}),e.find(".condition-show").mousedown(s=>{s.preventDefault();let a=$(s.currentTarget).attr("data-id");s.button==0?this.item.effects.get(a).sheet.render(!0):s.button==2&&this.item.deleteEmbeddedDocuments("ActiveEffect",[a])}),e.find(".condition-toggle").mousedown(s=>{let a=$(s.currentTarget).parents(".statusEffect").attr("data-id"),i=this.item.effects.get(a);i.update({disabled:!i.system.disabled})}),e.find(".condition-edit").click(s=>{this.item.effects.get($(s.currentTarget).attr("data-id")).sheet.render(!0)}),q.bindRollCommands(e),x.bindButtons(e);let t=e.find(".item-header");if(t.length){let s=t.find("svg");if(s){new ResizeObserver(function(n){let r=n[0];va(s,r.contentRect.width)}).observe(t.get(0));let i=t.find("input");i.get(0).disabled||(s.click(()=>{s.hide(),i.show(),i.focus()}),i.blur(function(){s.show(),i.hide()}))}}}};m(L,"ItemSheetDSK");var ms=class extends L{};m(ms,"ItemSheetEffectwrapper");var us=class extends L{async getData(e){let t=await super.getData(e);return K(t,{traitCategories:w.traitCategories,ranges:w.meleeRanges}),t}};m(us,"ItemSheetTrait");var fs=class extends L{async getData(e){let t=await super.getData(e);return K(t,{allSkills:(await h.allSkillsList(["skill"])).skills}),t}};m(fs,"ItemSheetInformation");var ps=class extends Se(L){async getData(e){let t=await super.getData(e);return K(t,{calculatedPrice:game.dsk.config.ItemSubClasses.consumable.consumablePrice(this.item),qsOptions:Array.fromRange(3,0).reduce((s,a)=>(s[a]=game.i18n.localize(`dsk.consumable.qs.${a}`),s),{}),consumableCategories:{0:"dsk.consumable.category.0"}}),t}};m(ps,"ItemSheetConsumable");var gs=class extends Se(L){async getData(e){let t=await super.getData(e),s=!1,a="";if(!s)a="wrongGrip.yieldTwo";else switch(game.i18n.localize(`dsk.LocalizedCTs.${this.item.system.combatskill}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":new RegExp(game.i18n.localize("dsk.wrongGrip.wrongGripBastardRegex")).test(this.item.name)?a="wrongGrip.yieldOneBastard":a="wrongGrip.yieldOneSwordBlunt";break;default:a="wrongGrip.yieldOnePolearms"}if(K(t,{twoHanded:s,wrongGripLabel:s?"wrongGrip.oneHanded":"wrongGrip.twoHanded",wrongGripHint:a,isShield:this.item.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Shields"),combatskills:(await h.allSkillsList(["combatskill"])).meleeSkills,ranges:w.meleeRanges,shieldSizes:w.shieldSizes}),this.item.actor){let i=this.item.actor.items.find(n=>n.type=="combatskill"&&n.name==this.item.system.combatskill);t.canBeOffHand=i&&!i.system.weapontype.twoHanded&&this.item.system.worn.value,t.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize(`dsk.LocalizedCTs.${this.item.system.combatskill}`))}return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),t}};m(gs,"ItemSheetMeleeweapon");var hs=class extends Se(L){async getData(e){let t=await super.getData(e);return K(t,{canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),ammunitiongroups:w.ammunitiongroups,combatskills:(await h.allSkillsList(["combatskill"])).rangeSkills}),t}};m(hs,"ItemSheetRangeweapon");var ys=class extends Se(L){};m(ys,"ItemSheetArmor");var ks=class extends Se(L){async getData(e){let t=await super.getData(e);return K(t,{ammunitiongroups:w.ammunitiongroups}),t}};m(ks,"ItemSheetAmmunition");var bs=class extends Se(L){async getData(e){let t=await super.getData(e);if(K(t,{equipmentTypes:w.equipmentTypes,canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")}),this.isBagWithContents()){let s=0;K(t,{containerContent:this.item.actor.items.filter(a=>w.equipmentCategories.includes(a.type)&&a.system.parent_id==this.item.id).map(a=>(a.weight=parseFloat((a.system.weight*a.system.quantity).toFixed(3)),s+=Number(a.weight),a)),weightSum:parseFloat(s.toFixed(3)),weightWidth:`style="width: ${Math.min(this.item.system.capacity?s/this.item.system.capacity*100:0,100)}%"`,weightExceeded:s>Number(this.item.system.capacity)?"exceeded":""})}return t}async breakOverflow(e,t){let s=$(await renderTemplate("systems/dsk/templates/items/baghover.html",e)),a=t.offset().top+52,i=t.offset().left-75;return s.appendTo($("body")),s.css({position:"absolute",left:i+"px",top:a+"px",bottom:"auto",right:"auto","z-index":1e4}),s}activateListeners(e){super.activateListeners(e);let t=e.find(".slot");t.mouseenter(async s=>{let a=$(s.currentTarget),i=await this.breakOverflow({name:a.attr("data-name"),weight:a.attr("data-weight"),quantity:a.attr("data-quantity")},a);i.fadeIn(),a.mouseleave(()=>{i.remove(),a.off("mouseleave")})}),t.mousedown(async s=>{let a=$(s.currentTarget).attr("data-item-id"),i=this.actor.items.get(a);s.button==0?i.sheet.render(!0):s.button==2&&($(".itemInfo").remove(),await i.update({"system.parent_id":0}),this.render(!0))})}isBagWithContents(){return this.item.actor&&Be(this.item,"system.category")=="bags"}async _onDrop(e){if(this.isBagWithContents()){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:s,typeClass:a,selfTarget:i}=await ls(t,void 0),n=this.item.id==s.id,r=this.item.parent.id==t.actorId;if(w.equipmentCategories.includes(a)&&!n){s.system.parent_id=this.item.id,s.system.worn&&s.system.worn.value&&(s.system.worn.value=!1),r?await this.item.actor.updateEmbeddedDocuments("Item",[s]):await this.item.actor.sheet._addLoot(s),this.render(!0);return}}await super._onDrop(e)}};m(bs,"ItemSheetEquipment");var ws=class extends L{static get defaultOptions(){let e=super.defaultOptions;return K(e,{width:530,height:570}),e}async getData(e){let t=await super.getData(e);return K(t,{hasLocalization:game.i18n.has(`dsk.Racedescr.${this.item.name}`)}),t}};m(ws,"ItemSheetSpecies");var vs=class extends L{static get defaultOptions(){let e=super.defaultOptions;return K(e,{width:700,height:700}),e}};m(vs,"ItemSheetCulture");var Ts=class extends L{static get defaultOptions(){let e=super.defaultOptions;return K(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e);return K(t,{enrichedClothing:await TextEditor.enrichHTML(Be(this.item.system,"description.gear"),{secrets:this.object.isOwner,async:!0})}),t}};m(Ts,"ItemSheetProfession");var ut=class extends L{async getData(e){let t=await super.getData(e);return t.enrichedRule=await TextEditor.enrichHTML(Be(this.item.system,"rule"),{secrets:this.object.isOwner,async:!0}),t}_advancable(){return this.item.system.max>0}async _refundStep(){let e,t;this.item.system.level>1&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level-1]),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.level":this.item.system.level-1}))}async _advanceStep(){let e,t;this.item.system.level<this.item.system.max&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level]),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.level":this.item.system.level+1})))}};m(ut,"ItemSheetAdvantage");var Ss=class extends ut{};m(Ss,"ItemSheetDisadvantage");var Cs=class extends L{async getData(e){let t=await super.getData(e);return K(t,{categories:w.specialAbilityCategories,subCategories:w.combatSkillSubCategories,enrichedRule:await TextEditor.enrichHTML(Be(this.item.system,"rule"),{secrets:this.object.isOwner,async:!0}),canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")}),t}async _refundStep(){let e,t;this.item.system.level>1&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level-1]),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.level":this.item.system.level-1}))}async _advanceStep(){let e,t;this.item.system.level<this.item.system.max&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level]),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.level":this.item.system.level+1})))}_advancable(){return this.item.system.max>0}};m(Cs,"ItemSheetSpecialability");var Ms=class extends L{async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async setupEffect(e){if(this.item.actor.system.stats.AeP.value<1)return ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughAeP"));let t=game.dsk.config.ItemSubClasses.ahnengeschenk;await this.item.actor.update({"system.stats.AeP.value":this.item.actor.system.stats.AeP.value-=1});let s=`<p><b>${this.item.name} - ${game.i18n.localize("TYPES.Item.ahnengeschenk")} ${game.i18n.localize("dsk.probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(h.chatDataSetup(s))}};m(Ms,"ItemSheetAhnengeschenk");var Ds=class extends L{async getData(e){let t=await super.getData(e);return K(t,{characteristics:w.characteristics,StFs:w.StFs,resistances:w.magicResistanceModifiers}),t}};m(Ds,"ItemSheetAhnengabe");var Is=class extends Se(L){async getData(e){let t=await super.getData(e);return K(t,{resistances:w.magicResistanceModifiers}),t}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}};m(Is,"ItemSheetPoison");var ft=class extends L{async getData(e){let t=await super.getData(e);return K(t,{characteristics:w.characteristics,skillGroups:w.skillGroups,skillBurdens:w.skillBurdens,hasLocalization:game.i18n.has(`dsk.SKILLdescr.${this.item.name}`),StFs:w.StFs}),t}};m(ft,"ItemSheetSkill");var As=class extends ft{async getData(e){let t=await super.getData(e);return K(t,{weapontypes:w.weapontypes,hasLocalization:game.i18n.has(`dsk.Combatskilldescr.${this.item.name}`)}),t}};m(As,"ItemSheetCombatskill");var{mergeObject:Ii,duplicate:Aa,getProperty:Ai}=foundry.utils,te=class extends Application{constructor(e){super(e),this.items=[],this.errors=[],this.attributes=[],this.updating=!1}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],Ii(e,{classes:e.classes.concat(["dsk","largeDialog"]),width:750,height:640}),e.resizable=!0,e}async updateSkill(e,t,s=1,a=!0){let i=[];for(let n of e){if(["","-"].includes(n.trim()))continue;let r=h.parseAbilityString(n.trim()),l=this.actor.items.find(c=>c.type==t&&c.name==r.name);if(l){let c=Aa(l);c.system.level=Math.max(0,s*r.step+(a?Number(c.system.level):0)),i.push(c)}else console.warn(`Could not find ${t} ${n}`),this.errors.push(`${h.categoryLocalization(t)}: ${n}`)}await this.actor.updateEmbeddedDocuments("Item",i,{},{render:!1})}async findCompendiumItem(e,t){for(let s of t){let a=await game.dsk.itemLibrary.findCompendiumItem(e,s);if(a.length)return a.find(i=>i.name==e&&i.type==s&&i.system)}}async parseToItem(e,t){return e.trim()==""?[]:await Promise.all(e.split(", ").map(async s=>{let a=h.parseAbilityString(s.trim()),i=await this.findCompendiumItem(a.original,t);if(i||(i=await this.findCompendiumItem(a.name,t)),i){let r=i.uuid;i=Aa(i),i.uuid=r,i.tooltip=game.i18n.localize("dsk.details"),i=j.reverseAdoptionCalculation(this.actor,a,i),i.system.ap&&(i.APunparseable=isNaN(i.system.ap),i.apCost=i.APunparseable?i.system.ap:a.step*Number(i.system.ap))}else{console.warn(`Not found <${s}>`);let r=t.map(l=>h.categoryLocalization(l)).join("/");this.errors.push(`${r}: ${s}`),i={name:s.trim(),notFound:!0,tooltip:game.i18n.localize("dsk.DSKError.itemNotFound"),apCost:"?"}}i.replaceName=a.original,i.step=a.step;let n=this.actor.items.find(r=>t.includes(r.type)&&r.name==a.original)!=null;return i.disabled=n||i.notFound||i.APunparseable,n&&(i.tooltip=game.i18n.localize("dsk.YouAlreadyHaveit")),i}))}activateListeners(e){super.activateListeners(e),e.find("button.ok").click(()=>{this.updating||(this.updating=!0,this.updateCharacter().then(()=>this.updating=!1))}),e.find("button.cancel").click(()=>{this.close()}),e.find(".show-item").click(t=>{let s=$(t.currentTarget).attr("data-id");this.items.find(i=>i.id==s).sheet.render(!0)}),e.find(".optional").change(t=>{let s=$(t.currentTarget).closest(".content"),a=Number(s.attr("data-cost"));s.find(".optional:checked").each(function(){a+=Number($(this).attr("data-cost"))});let i=s.find(".apCost");i.text(a),te.flashElem(i,"emphasize2")}),e.find(".exclusive").change(t=>{let s=$(t.currentTarget).closest(".content"),a=$(t.currentTarget).attr("data-sel"),i=s.find(`.allowedCount_${a}`),n=Number(i.attr("data-count"));if(s.find(`.exclusive_${a}:checked`).length>n){t.currentTarget.checked=!1,te.flashElem(i);return}})}_validateInput(e){let t=new Set,s=/^exclusive_/;for(let a of e.find(".exclusive"))t.add(a.className.split(/\s+/).filter(i=>s.test(i))[0]);for(let a of t){let i=e.find(".allowedCount_"+a.split("_")[1]),n=Number(i.attr("data-count"));if(e.find(`.${a}:checked`).length!=n)return this._showInputValidation(i,e,app),!1}return!0}_showInputValidation(e,t,s){ui.notifications.error(game.i18n.localize("dsk.DSKError.MissingChoices"));let a=e.closest(".tab").attr("data-tab");s.activateTab(a),te.flashElem(t.find(`.tabs a[data-tab='${a}']`)),te.flashElem(e.closest("div"))}async alreadyAdded(e,t){if(e=="")return!1;let s=!1;return s=await new Promise((a,i)=>{new Dialog({title:game.i18n.localize("dsk.DIALOG.warning"),content:game.i18n.format("dsk.DIALOG.alreadyAddedCharacterpart",{category:h.categoryLocalization(t)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("dsk.ok"),default:!0,callback:()=>{a(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("dsk.cancel"),default:!0,callback:()=>{a(!0)}}}}).render(!0)}),s}async addSelections(e){let t=[];for(let s of e){if($(s).val()=="")continue;let i=await fromUuid($(s).val()),n=h.parseAbilityString(i.name);switch(i.name=$(s).attr("name"),i.type){case"advantage":case"disadvantage":i.system.level=Number($(s).attr("data-step")),i=j.reverseAdoptionCalculation(this.actor,n,i),this.mergeLevels(t,i)||E.vantageAdded(this.actor,i);break;case"specialability":i.system.level=Number($(s).attr("data-step")),$(s).attr("data-free")&&(i.system.ap=0),i=j.reverseAdoptionCalculation(this.actor,n,i),this.mergeLevels(t,i)||z.abilityAdded(this.actor,i);break}}await this.actor.createEmbeddedDocuments("Item",t)}mergeLevels(e,t){let s=!1,a=e.find(i=>i.name==t.name&&i.type==t.type);if(a){s=!0;let i=Number(Ai(t,"system.level"));i&&(a.system.level+=i)}else e.push(t);return s}static flashElem(e,t="emphasize"){e.addClass(t),setTimeout(function(){e.removeClass(t)},600)}finalizeUpdate(){this.errors.length==0?this.close():$(this._element).find(".dialog-buttons").html(`<div class="error"><p>${game.i18n.localize("dsk.DSKError.notUnderstood")}</p><ul><li>${this.errors.join("</li><li>")}</li></ul></div>`)}};m(te,"WizardDSK");var{mergeObject:$i,duplicate:Ei}=foundry.utils,Ge=class extends te{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")}`}),e.template="systems/dsk/templates/wizard/add-species-wizard.html",e}async _parseBonus(e){let t=[],s=[],a=!1,i=Object.keys(w.characteristics),n=new RegExp(game.i18n.localize("dsk.WIZARDPARSER.speciesAdvantage"),"i");for(let r of e.split(","))if(n.test(r)){a=!0;let l=i.filter(c=>r.includes(c.toUpperCase()));t.push({choices:l,allowedCount:1});break}else s.push(r.trim());return s=await this.parseToItem(s.join(", "),["advantage","disadvantage"]),{anyAttributeRequirements:a,attributeRequirements:t,optionals:s}}async getData(e){let t=await super.getData(e),{anyAttributeRequirements:s,attributeRequirements:a,optionals:i}=await this._parseBonus(this.species.system.advantages),n=s;return $i(t,{speciesDescription:game.i18n.has(`dsk.Racedescr.${this.species.name}`)?game.i18n.localize(`dsk.Racedescr.${this.species.name}`):this.species.system.description.value,species:this.species,description:game.i18n.format("dsk.WIZARD.speciesdescr",{species:this.species.name}),title:game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")} ${this.species.name}`}),generalToChose:n,anyAttributeRequirements:s,optionals:i,attributeRequirements:a}),t}async addSpecies(e,t){this.actor=e,this.species=Ei(t)}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.species,"species")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.species":this.species.name,"system.stats.gs.initial":this.species.system.gs,"system.stats.sk.initial":this.species.system.sk,"system.stats.zk.initial":this.species.system.zk,"system.stats.LeP.initial":this.species.system.LeP,"system.stats.LeP.value":this.species.system.LeP+this.actor.system.characteristics.ko.value*2};for(let a of e.find(".exclusive:checked"))s[`system.characteristics.${$(a).val()}.species`]=1;await this.actor._updateAPs(t,{},{render:!1}),await this.addSelections(e.find(".optional:checked")),await this.actor.update(s),await this.actor.removeCondition("incapacitated"),this.finalizeUpdate()}};m(Ge,"SpeciesWizard");var{mergeObject:xi,duplicate:zi}=foundry.utils,je=class extends te{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")}`}),e.template="systems/dsk/templates/wizard/add-culture-wizard.html",e}async getData(e){let t=await super.getData(e),s=0;return xi(t,{title:game.i18n.format("dsk.WIZARD.addItem",{item:`${h.categoryLocalization("culture")} ${this.culture.name}`}),culture:this.culture,description:game.i18n.format("dsk.WIZARD.culturedescr",{culture:this.culture.name,cost:s})}),t}async addCulture(e,t){this.actor=e,this.culture=zi(t)}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.culture,"culture")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.culture":this.culture.name};await this.actor._updateAPs(t,{},{render:!1}),await this.updateSkill(this.culture.system.skills.split(","),"skill"),await this.actor.update(s),this.finalizeUpdate()}};m(je,"CultureWizard");var{mergeObject:Oi,duplicate:Ys}=foundry.utils,qe=class extends te{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.profession")}`}),e.template="systems/dsk/templates/wizard/add-career-wizard.html",e}async getData(e){let t=await super.getData(e),s=[...await this.parseToItem(this.career.system.requirements.advantage,["disadvantage","advantage"]),...await this.parseToItem(this.career.system.requirements.specialability,["specialability"])],a=s.filter(l=>["advantage","disadvantage"].includes(l.type)&&!l.disabled),i=0,n=s.reduce(function(l,c){return l+(c.disabled?0:Number(c.system.ap)||0)},0),r=s.filter(l=>l.type=="specialability"&&!l.disabled);return Oi(t,{title:game.i18n.format("dsk.WIZARD.addItem",{item:`${h.categoryLocalization("profession")} ${this.career.name}`}),career:this.career,description:game.i18n.format("dsk.WIZARD.careerdescr",{career:this.career.name,cost:i+n}),baseCost:i,missingVantagesToChose:a.length>0,missingSpecialabiltiesToChose:r.length>0}),t}async addCareer(e,t){this.actor=e,this.career=Ys(t)}async setAbility(e,t){if(e.trim()=="")return;let s=[],a=[];for(let i of e.split(",")){if(["","-"].includes(i.trim()))continue;let n=h.parseAbilityString(i.trim()),r=this.actor.items.find(l=>t.includes(l.type)&&l.name==n.original);if(r)r=Ys(r),r.system.level!=null&&(r.system.level=n.step),r=j.reverseAdoptionCalculation(this.actor,n,r),a.push(r);else if(r=await this.findCompendiumItem(n.original,t),r||(r=await this.findCompendiumItem(n.name,t)),r)r=Ys(r),r.name=n.original,r.system.level!=null&&(r.system.level=n.step),r=j.reverseAdoptionCalculation(this.actor,n,r),s.push(r);else{let l=t.map(c=>h.categoryLocalization(c)).join("/");this.errors.push(`${l}: ${i}`),ui.notifications.error(game.i18n.format("dsk.DSKError.notFound",{category:l,name:i}))}}await this.actor.updateEmbeddedDocuments("Item",a,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",s,{},{render:!1})}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.profession,"profession")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.profession":this.career.name};this.career.system.isAncestor&&(await this.setAbility(this.career.system.ahnengabe,["ahnengabe"]),await this.setAbility(this.career.system.ahnengeschenk,["ahnengeschenk"])),await this.setAbility(this.career.system.requirements.specialability,["specialability"]),await this.setAbility(this.career.system.requirements.advantage,["advantage","disadvantage"]),await this.actor._updateAPs(t,{},{render:!1});let a=[...this.career.system.skills.body.split(","),...this.career.system.skills.social.split(","),...this.career.system.skills.mental.split(","),...this.career.system.skills.trade.split(",")];await this.updateSkill(a,"skill"),await this.updateSkill(this.career.system.skills.combat.split(","),"combatskill"),await this.actor.update(s),this.finalizeUpdate()}};m(qe,"CareerWizard");var{mergeObject:Ni}=foundry.utils,oe=class extends de{static get defaultOptions(){let e=super.defaultOptions;return Ni(e,{classes:e.classes.concat(["dsk","actor","character-sheet"]),width:795}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/npc-limited.html":"systems/dsk/templates/actors/actor-sheet.html"}async _manageDragItems(e,t){switch(t){case"aggregatedTest":await this.actor.createEmbeddedDocuments("Item",[e]);break;case"species":let s=new Ge;await s.addSpecies(this.actor,e),s.render(!0);break;case"culture":let a=new je;await a.addCulture(this.actor,e),a.render(!0);break;case"profession":let i=new qe;await i.addCareer(this.actor,e),i.render(!0);break;default:return super._manageDragItems(e,t)}}};m(oe,"ActorSheetCharacter");var{mergeObject:_i,getProperty:$a}=foundry.utils,me=class extends de{static get defaultOptions(){let e=super.defaultOptions;return _i(e,{classes:e.classes.concat(["dsk","actor","creature-sheet","character-sheet"])}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/creature-limited.html":"systems/dsk/templates/actors/creature-sheet.html"}async getData(e){let t=await super.getData(e);return t.enrichedBehaviour=await TextEditor.enrichHTML($a(this.actor.system,"notes.fight"),{secrets:this.object.isOwner,async:!0}),t.enrichedSpecialrules=await TextEditor.enrichHTML($a(this.actor.system,"notes.specialRules"),{secrets:this.object.isOwner,async:!0}),t}async _cleverDeleteItem(e){let t=this.actor.items.find(s=>s.id==e);switch(t.type){case"trait":await this._updateAPs(t.system.ap*-1,{},{render:!1});break}await super._cleverDeleteItem(e)}async _addTrait(e){this.actor.items.find(s=>s.type=="trait"&&s.name==e.name)||(await this._updateAPs(e.system.ap,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}async _onDropItemCreate(e){return e.type=="trait"?this._addTrait(e):super._onDropItemCreate(e)}};m(me,"ActorSheetCreature");var{mergeObject:Pi}=foundry.utils,ue=class extends oe{static get defaultOptions(){let e=super.defaultOptions;return Pi(e,{classes:e.classes.concat(["dsk","actor","npc-sheet"])}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/npc-limited.html":"systems/dsk/templates/actors/npc-sheet.html"}};m(ue,"ActorSheetNPC");var{mergeObject:Ri}=foundry.utils,We=class extends JournalSheet{static get defaultOptions(){let e=super.defaultOptions;return Ri(e,{classes:e.classes.concat(["dsk","dskjournal"])}),e}};m(We,"DSKJournalSheet");var Li={"":"dsk.Modifier",defenseMalus:"dsk.MODS.defenseMalus",FW:"dsk.MODS.FW",AeP:"dsk.AeP",FP:"dsk.MODS.FP",QL:"dsk.MODS.QS",dmg:"dsk.MODS.damage",damageBonus:"dsk.MODS.damage",armorPen:"dsk.MODS.armorPen",TPM:"dsk.MODS.partChecks"};function Ea(){Handlebars.registerHelper({roman:(o,e)=>e!=null&&Number(e)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][o-1],itemCategory:o=>h.categoryLocalization(o),isWEBM:o=>/.webm$/.test(o),getAttr:(o,e,t)=>o.system.characteristics[e][t],diceThingsUp:(o,e)=>h.replaceDies(o,!1),replaceConditions:h.replaceConditions,attrLoc:(o,e)=>game.i18n.localize(`dsk.characteristics.${o}.${e}`),floor:o=>Math.floor(Number(o)),situationalTooltip:o=>{let e=game.i18n.localize(`${Li[o.type]||"dsk.Modifier"}`),t=`${o.name}<br/>${e}: ${o.value}`;return o.source&&(t+=`<br/>${game.i18n.localize("dsk.source")}: ${o.source}`),t},selfObj:o=>o.reduce((e,t)=>(e[t]=t,e),{})})}m(Ea,"setupHandlebars");function xa(){Hooks.on("getJournalSheetHeaderButtons",(o,e)=>{!o.document.sceneNote||e.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:async()=>o.document.panToNote()})}),Hooks.on("renderJournalSheet",(o,e,t)=>{e.find(".close").attr("data-tooltip",game.i18n.localize("dsk.SHEET.Close")),e.find(".entry-image").attr("data-tooltip",game.i18n.localize("dsk.SHEET.imageView")),e.find(".entry-text").attr("data-tooltip",game.i18n.localize("dsk.SHEET.textView")),e.find(".share-image").attr("data-tooltip",game.i18n.localize("dsk.SHEET.showToPlayers")),e.find(".import").attr("data-tooltip",game.i18n.localize("dsk.SHEET.import")),e.find(".panMapNote").attr("data-tooltip",game.i18n.localize("dsk.SHEET.panMapNote"))}),Hooks.on("renderJournalPageSheet",(o,e,t)=>{q.bindRollCommands(e),x.bindButtons(e),e.find("img").mousedown(s=>{s.button==2&&game.dsk.apps.DSKUtility.showArtwork({name:o.name,uuid:"",img:$(s.currentTarget).attr("src")})}),xe(e)})}m(xa,"setupJournal");async function za(o){let t=game.settings.get("dsk","journalFontSizeIndex")+1;t==w.journalFontSizes.length+1?(t=0,await game.settings.set("dsk","journalFontSizeIndex",t),o.css("fontSize",""),tinyNotification(game.i18n.format("dsk.CHATNOTIFICATION.fontsize",{size:"Default "}))):(await game.settings.set("dsk","journalFontSizeIndex",t),Fi(o))}m(za,"increaseFontSize");function Fi(o){let e=game.settings.get("dsk","journalFontSizeIndex"),t=w.journalFontSizes[e-1]||14;tinyNotification(game.i18n.format("dsk.CHATNOTIFICATION.fontsize",{size:t})),o.css("fontSize",`${t}px`)}m(Fi,"setOuterFontSize");function Na(){Hooks.on("hotbarDrop",(o,e,t)=>{if(e.type=="Item"){let s=fromUuidSync(e.uuid);if(!["ahnengabe","meleeweapon","rangeweapon","skill","combatskill","char","trait"].includes(s.type)||(s.type=="meleeweapon"||s.type=="combatskill")&&!["attack","parry"].includes(e.mod))return;if((s.type=="rangeweapon"||s.type=="trait")&&!["attack"].includes(e.mod))return;let i=`{mod: "${e.mod}"}`,n;game.user.isGM||e.actorId==null?n=`game.dsk.macro.itemMacro("${s.name}", "${s.type}", ${i});`:n=`game.dsk.macro.itemMacroById("${e.actorId}", "${s.name}", "${s.type}", ${i})`;let r=e.mod==null?s.name:`${s.name} - ${game.i18n.localize("dsk.characteristics."+e.mod+".name")}`;return Oa(n,r,s.img,t)}else if(e.type=="Actor"||e.type=="JournalEntry"){let s=fromUuidSync(e.uuid),a=`(await fromUuid('${e.uuid}')).sheet.render(true)`;return Oa(a,s.name,s.img,t)}})}m(Na,"setupMacros");function Oa(o,e,t,s){let a=game.macros.contents.find(i=>i.name===e&&i.command===o);return a?game.user.assignHotbarMacro(a,s):Macro.create({name:e,type:"script",img:t,command:o},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,s)),!1}m(Oa,"createHotBarMacro");var Ke=class{static async stopFade(e){e.stopPropagation(),e.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(e.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click(()=>$(".didYouKnow").remove())):fetch(`systems/dsk/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let s=t.data[Math.floor(Math.random()*t.data.length)],a=await renderTemplate("systems/dsk/templates/system/didyouknow.html",{msg:s,fadeOut:Ke.fadeOut});$("body").find(".didYouKnow").replaceWith(a),Ke.activateListeners()})}static activateListeners(){$(".didYouKnow .stopFade").click(async e=>await this.stopFade(e)),$(".didYouKnow").click(()=>$(".didYouKnow").remove()),$(".didYouKnow").fadeIn()}static async showOneMessage(e=8e3){game.settings.get("dsk","disableDidYouKnow")||fetch(`systems/dsk/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let s=t.data[Math.floor(Math.random()*t.data.length)],a=await renderTemplate("systems/dsk/templates/system/didyouknow.html",{msg:s,fadeOut:Ke.fadeOut});$("body").append(a),this.activateListeners(),setTimeout(function(){Ke.fadeOut&&$(".didYouKnow").fadeOut(1e3,()=>$(".didYouKnow").remove())},e)})}},ze=Ke;m(ze,"DidYouKnow"),O(ze,"fadeOut",!0);var fe=class{static async firstTimeMessage(){if(!await game.settings.get("dsk","firstTimeStart")){await fe.setupDefaultOptions();let e=game.i18n.localize("dsk.WELCOME");ChatMessage.create(h.chatDataSetup(e)),fe.firstTimeLanguage(),await game.settings.set("dsk","firstTimeStart",!0)}}static firstTimeLanguage(){let e=["de"],t={title:game.i18n.localize("dsk.DIALOG.firstTime"),content:game.i18n.localize("dsk.DIALOG.firstTimeWarning"),default:"de",buttons:{}};for(let s of e)t.buttons[s]={label:game.i18n.localize(s),callback:()=>fe.setLanguage(s)};new Dialog(t).render(!0)}static async setLanguage(e){await game.settings.set("dsk","firstTimeStart",!0),await game.settings.set("dsk","forceLanguage",e),await game.settings.set("core","language",e),foundry.utils.debouncedReload()}static async setupDefaultOptions(){let e=game.settings.get("core",Combat.CONFIG_SETTING);e.skipDefeated=!0,await game.settings.set("core",Combat.CONFIG_SETTING,e),await game.settings.set("core","leftClickRelease",!0)}};m(fe,"DSKTutorial");var{getProperty:Hi}=foundry.utils,Js=m(async(o,e,t,s)=>{if(game.user.isGM){let a=await h.getFolderForType("Actor",null,"Dropped Items"),n=game.users.filter(d=>!d.isGM).map(d=>d.id).reduce((d,f)=>(d[f]=1,d),{default:0}),r=e.toObject();r.system.quantity=s,R.obfuscateDropData(r,t.tabsinvisible),Hi(r,"system.worn.value")&&(r.system.worn.value=!1);let l={type:"npc",name:e.name,img:e.img,prototypeToken:{img:e.img,width:.4,height:.4},ownership:n,items:[r],flags:{core:{sheetClass:"dsk.MerchantSheetDSK"}},folder:a,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},stats:{LeP:{value:16}}}},u=await(await game.dsk.documents.ActorDSK.create(l)).getTokenDocument({x:t.x,y:t.y,hidden:!1});if(!canvas.dimensions.rect.contains(u.x,u.y))return!1;if(o){await canvas.scene.createEmbeddedDocuments("Token",[u],{noHook:!0});let d=e.system.quantity-s;d<1?await o.deleteEmbeddedDocuments("Item",[e.id]):await o.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity":d}])}else await canvas.scene.createEmbeddedDocuments("Token",[u])}else{let a={itemId:e.uuid,sourceActorId:o?.id,data:t,amount:s};game.socket.emit("system.dsk",{type:"itemDrop",payload:a})}},"dropToGround"),Bi=m(async(o,e)=>{let t=await Item.implementation.fromDropData(e),s=t.parent;if(!w.equipmentCategories.includes(t.type))return;let a=await renderTemplate("systems/dsk/templates/dialog/dropToGround.html",{name:t.name,count:t.system.quantity});new $s({title:e.name,content:a,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:async i=>Js(s,t,e,Number(i.find('[name="count"]').val()))},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)},"handleItemDrop"),Gi=m(async(o,e)=>{let t=e.x,s=e.y,a=0,i=o.grid.size,n=Math.ceil(Math.sqrt(e.ids.length));for(let r of e.ids){let l=game.actors.get(r);if(!l)continue;let c=await l.getTokenDocument({x:t,y:s,hidden:!1});c.constructor.create(c,{parent:o.scene}),n%a==0&&a>0?(s+=i,t=e.x):t+=i,a++}},"handleGroupDrop"),_a=m(()=>{Hooks.on("dropCanvasData",async(o,e)=>{if(!!(game.settings.get("dsk","enableItemDropToCanvas")||game.user.isGM||e.tokenId)){if(e.type=="Item")return Bi(o,e),!1;if(e.type=="GroupDrop")return Gi(o,e),!1}})},"connectHook"),$s=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};m($s,"DropToGroundDialog");var{mergeObject:Pa}=foundry.utils,Ce=class extends Dialog{static async showDialog(e){let t=this.callbackResult;new Ce({title:game.i18n.localize("dsk.Unopposed"),content:await this.getTemplate(e),default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:s=>{t(s.find('[name="entryselection"]').val(),e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}static getTargetActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.targetSpeaker,s=canvas.tokens.get(t.token).actor;return s?{actor:s,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("dsk.DSKError.noProperActor")),{})}static async getTemplate(e){return""}static callbackResult(e,t,s){}static get defaultOptions(){let e=super.defaultOptions;return Pa(e,{resizable:!0}),e}};m(Ce,"DialogReactDSK");var Oe=class extends Dialog{static async showDialog(e,t){let s=new Oe({title:game.i18n.localize("dsk.attacktest"),content:await this.getTemplate(e),buttons:{}});s.actor=e,s.tokenId=t,s.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.actor,this.tokenId),this.close()})}static async getTemplate(e){let t=e.items.filter(n=>n.type=="combatskill").map(n=>D._calculateCombatSkillValues(n.toObject(),e.system)),s=[],a=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"];for(let n of e.items)if(a.includes(n.type)&&n.system.worn.value==!0){let r=n.type=="meleeweapon"?D._prepareMeleeWeapon(n.toObject(),t,e):D._prepareRangeWeapon(n.toObject(),[],t,e);s.push({name:n.name,id:n.name,img:n.img,value:r.attack})}else n.type=="trait"&&i.includes(n.system.traitType)&&s.push({name:n.name,id:n.name,img:n.img,value:n.system.at});return await renderTemplate("systems/dsk/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:s,title:"dsk.DIALOG.selectAction"})}callbackResult(e,t,s){let a=["meleeweapon","trait","rangeweapon"],i=t.items.find(n=>a.includes(n.type)&&n.name==e);i&&t.setupWeapon(i,"attack",{},s).then(n=>{t.basicTest(n)})}static get defaultOptions(){let e=super.defaultOptions;return Pa(e,{width:550}),e}};m(Oe,"ActAttackDialog");var{getProperty:Zs,mergeObject:ji}=foundry.utils,le=class extends CombatTracker{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"/systems/dsk/templates/system/combattracker.html"})}activateListeners(e){super.activateListeners(e),e.find(".combatant.actor .aggroButton").click(t=>{t.preventDefault(),t.stopPropagation(),le.runActAttackDialog()})}static runActAttackDialog(){if(!game.combat)return;let e=game.combat.combatant;(game.user.isGM||e.isOwner)&&Oe.showDialog(e.actor,e.tokenId)}async getData(e){let t=await super.getData(e);for(let s of t.turns){let a=t.combat.turns.find(r=>r.id==s.id),i=game.user.isGM||a.actor&&a.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsk","hideEffects");s.defenseCount=a.getFlag("dsk","defenseCount")||0;let n=[];if(a.actor){for(let r of a.actor.items)if(r.type=="rangeweapon"&&r.system.worn.value&&r.system.reloadTimeprogress>0){let l={name:r.name,remaining:D.calcLZ(r,a.actor)-r.system.reloadTimeprogress};l.remaining>0&&n.push(l)}else if(["spell","liturgy"].includes(r.type)&&r.system.castingTime.modified>0){let l={name:r.name,remaining:r.system.castingTime.modified-r.system.castingTime.progress};l.remaining>0&&n.push(l)}}n=n.sort((r,l)=>r.remaining-l.remaining),n.length>0&&(s.ongoings=`${game.i18n.localize("dsk.COMBATTRACKER.ongoing")}
${n.map(r=>`${r.name} - ${r.remaining}`).join(`
`)}`,s.ongoing=n[0].remaining),s.effects=new Set,a.actor&&a.actor.temporaryEffects.forEach(r=>{r.statuses.has(CONFIG.Combat.defeatedStatusId)?s.defeated=!0:r.img&&i&&!r.notApplicable&&(game.user.isGM||!r.getFlag("dsk","hidePlayers"))&&!r.getFlag("dsk","hideOnToken")&&s.effects.add(r.img)})}return t}};m(le,"DSKCombatTracker");var pt=class extends Combat{constructor(e,t){super(e,t)}async refreshTokenbars(){game.dsk.apps.tokenHotbar&&game.dsk.apps.tokenHotbar.updateDSKHotbar()}_onCreate(e,t,s){super._onCreate(e,t,s),this.refreshTokenbars()}_onDelete(e,t){super._onDelete(e,t),this.refreshTokenbars()}async nextRound(){if(game.user.isGM)for(let e of this.turns)await e.setFlag("dsk","defenseCount",0);else await game.socket.emit("system.dsk",{type:"clearCombat",payload:{}});return await super.nextRound()}async getDefenseCount(e){let t=this.getCombatantFromActor(e);return t&&t.getFlag("dsk","defenseCount")||0}getCombatantFromActor(e){let t;return e.token?t=Array.from(this.combatants).find(s=>s.tokenId==e.token):t=Array.from(this.combatants).find(s=>s.actorId==e.actor),t?this.combatants.get(t.id):void 0}async updateDefenseCount(e){if(game.user.isGM)for(let t of e){let s=this.getCombatantFromActor({token:t});s&&!Zs(s.actor,"system.config.defense")&&await s.setFlag("dsk","defenseCount",(s.getFlag("dsk","defenseCount")||0)+1)}else await game.socket.emit("system.dsk",{type:"updateDefenseCount",payload:{speaker:e}})}};m(pt,"DSKCombat");var gt=class extends Combatant{constructor(e,t){e.flags==null&&(e.flags={}),ji(e.flags,{dsk:{defenseCount:0}}),super(e,t)}async recalcInitiative(){if(this.initiative){let t={initiative:(await this.getFlag("dsk","baseRoll")||0)+this.actor.system.stats.ini.value};await this.update(t)}}};m(gt,"DSKCombatant");Hooks.on("preCreateCombatant",(o,e,t)=>{let s=h.getSpeaker({actor:o.actorId,scene:o.sceneId,token:o.token_id});if(Zs(s.system,"merchant.merchantType")=="loot")return!1});Hooks.on("updateCombatant",(o,e,t)=>{if(!!game.user.isGM)if(e.initiative){if(!o.getFlag("dsk","baseRoll")){let a=`${e.initiative}`.split("."),i=Number(a[0])-Math.round(o.actor.system.stats.ini.value);o.setFlag("dsk","baseRoll",i)}}else"initiative"in e&&e.initiative==null&&o.update({["flags.dsk.-=baseRoll"]:null})});var Ue=class{static async updateCombatHook(e,t,s,a){!t.round&&!t.turn||e.round!=0&&e.turns&&e.active&&e.previous.round<e.current.round&&await Ue.startOfRound(e)}static async startOfRound(e){let t=game.users.find(s=>s.active&&s.isGM);if(!!(t&&game.user.id==t.id)){for(let s of e.turns)if(!s.defeated){for(let a of s.actor.effects){let i=[...a.statuses][0];i=="bleeding"?await this.applyBleeding(s):i=="burning"&&await this.applyBurning(s,a)}await this.startOfRoundEffects(s)}}}static async startOfRoundEffects(e){let t=["LeP","AeP"];for(let s of t)for(let a of e.actor.system.repeatingEffects.startOfRound[s]){if(Zs(e.actor.system.repeatingEffects,`disabled.${s}`))continue;let i=await new Roll(a.value).evaluate(),n=await i.render(),r=game.i18n.localize(i.total>0?"dsk.CHATNOTIFICATION.regenerates":"dsk.CHATNOTIFICATION.getsHurt"),l=`${e.actor.name} ${r} ${game.i18n.localize(s)} ${n}`;await ChatMessage.create(h.chatDataSetup(l)),s=="LeP"?await e.actor.applyDamage(i.total*-1):await e.actor.applyMana(i.total*-1)}}static async applyBleeding(e){e.actor.system.stats.LeP.value<=0||(await ChatMessage.create(h.chatDataSetup(game.i18n.format("dsk.CHATNOTIFICATION.bleeding",{actor:e.actor.name}))),await e.actor.applyDamage(1))}static async applyBurning(e,t){if(e.actor.system.stats.LeP.value<=0)return;let s=Number(t.getFlag("dsk","value")),a=DSKStatusEffects.resistantToEffect(e.actor,t),i={0:"1",1:"1d3",2:"1d6",3:"2d6"}[s-a]||"1",n=await new Roll(i).evaluate(),r=await n.render();await ChatMessage.create(h.chatDataSetup(game.i18n.format(`dsk.CHATNOTIFICATION.burning.${s}`,{actor:e.actor.name,damage:r}))),await e.actor.applyDamage(n.total)}};m(Ue,"RepeatingEffectsHelper");Hooks.on("updateCombat",Ue.updateCombatHook);var{mergeObject:Xs,duplicate:qi}=foundry.utils,Me=class extends Application{static get defaultOptions(){let e=super.defaultOptions;Xs(e,{classes:e.classes.concat(["dsk","initTracker"]),template:"systems/dsk/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"dsk.DSKIniTracker"});let t=game.settings.get("dsk","iniTrackerPosition");return Xs(e,t),e}setPosition({left:e,top:t,width:s,height:a,scale:i}={}){let n=super.setPosition({left:e,top:t,width:s,height:a,scale:i}),r=this.element[0];if(!r.style.width||s){let l=s||r.offsetWidth,c=r.style.maxWidth||window.innerWidth;n.width=s=Math.clamp(l,0,c),r.style.width=s+"px",s+n.left>window.innerWidth&&(e=n.left)}return game.settings.set("dsk","iniTrackerPosition",{left:n.left,top:n.top}),n}static connectHooks(){Hooks.on("renderDSKCombatTracker",(e,t,s)=>{!game.settings.get("dsk","enableCombatFlow")||(game.combat?(game.dsk.apps.initTracker||(game.dsk.apps.initTracker=new Me),game.dsk.apps.initTracker.updateTracker(s)):game.dsk.apps.initTracker&&(game.dsk.apps.initTracker.close(),game.dsk.apps.initTracker=void 0))})}updateTracker(e){this.combatData=e,this.render(!0)}async getData(e){let t=this.combatData,s=game.settings.get("dsk","iniTrackerSize"),a=t.round,i=t.turns,n=[],r=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,l=t.turns.some(c=>c.owner&&!c.hasRolled&&(!game.user.isGM||t.combat.combatants.get(c.id).isNPC));if(i.length){let c=[],u=5,d=!1,f=-1,p=0,b=0,T;for(;!(u==0||b==5);){let g=qi(i[p]),y=t.combat.combatants.get(g.id);d&&p==f&&(g.css=g.css.replace("active","")),!a||g.active&&!d?(d=!0,f=p):y.getFlag("dsk","waitInit")==t.round+b&&!y.defeated&&(game.user.isGM||!y.hidden)&&n.push(g),d&&!(r&&y.defeated)&&(game.user.isGM||!y.hidden)&&(g.round=t.round+b,g.owner&&y.token?.actor&&(g.maxLP=y.token.actor.system.stats.LeP.max,g.currentLP=y.token.actor.system.stats.LeP.value),T&&T!=g.round&&(g.newRound="newRound"),T=g.round,c.push(g),u--),p++,p>=i.length&&(p=0,b++)}t.turns=c}return t.isLastRound=t.turns[1]?.newRound,this.position.width=s*5+95,this.position.height=s+10,Xs(t,{itemWidth:s,unRolled:l,waitingTurns:n}),this.conditionalPanToCurrentCombatant(t),t}hasChangedTurn(e){let t=e.turn!=this.lastTurnUpdate||e.round!=this.lastRoundUpdate;return this.lastTurnUpdate=e.turn,this.lastRoundUpdate=e.round,t}async conditionalPanToCurrentCombatant(e){if(!game.settings.get("dsk","enableCombatPan"))return;let t=e.turns[0];if(!t)return;let s=e.combat.combatants.get(t.id);!s||!this.hasChangedTurn(e)||setTimeout(()=>{let a=s.token;!a||!a.object||!a.object.isVisible||(canvas.animatePan({x:a.x,y:a.y}),!(!s.actor||!s.actor.isOwner)&&a.object.control({releaseOthers:!0}))},300)}async _onWheelResize(e){let t=game.settings.get("dsk","iniTrackerSize");e.originalEvent.deltaY>0?t=Math.min(140,t+5):t=Math.max(30,t-5),await game.settings.set("dsk","iniTrackerSize",t),await this.render(!0)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async a=>(a.stopPropagation(),a.preventDefault(),await this._onWheelResize(a),!1)),e.find(".combat-control").click(a=>this._onCombatControl(a));let s=e.find(".iniItem");s.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),s.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown(a=>this._onRightClick(a)),e.find(".combatant-control").click(a=>this._onCombatantControl(a)),e.find(".combatant .aggroButton").click(a=>{a.preventDefault(),a.stopPropagation(),le.runActAttackDialog()}),e.find(".rollMine").click(a=>this.rollMyChars()),game.user.isGM&&e.find(".rolledInit").click(a=>this.editCombatant(a))}rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsk","waitInit")}}editCombatant(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}_onCombatantControl(e){this._getCombatApp()._onCombatantControl(e)}_onCombatControl(e){e.currentTarget.dataset.control=="waitInit"?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}async waitInit(e){await game.combat.combatants.get(game.combat.current.combatantId).setFlag("dsk","waitInit",game.combat.current.round),e.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(e)}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onCombatantMouseDown(e){this._getCombatApp()._onCombatantMouseDown(e)}_getCombatApp(){return game.combats.apps[0]}_canDragStart(e){return!1}_canDragDrop(e){return!1}_onDragStart(e){let t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}_onDrop(e){JSON.parse(e.dataTransfer.getData("text/plain")).type=="IniChange"}};m(Me,"DSKIniTracker");var{getProperty:Ra,mergeObject:Es,duplicate:Wi}=foundry.utils,ie=class extends Application{static registerTokenHotbar(){game.dsk.apps.tokenHotbar||(game.dsk.apps.tokenHotbar=new ie)}constructor(e){super(e),this.combatSkills=["selfControl","featOfStrength","bodyControl","perception"].map(s=>game.i18n.localize(`dsk.LocalizedIDs.${s}`)),this.defaultSkills=[game.i18n.localize("dsk.LocalizedIDs.perception")];let t=m(s=>{let a=s.parent?s.parent.id:void 0;a&&ie.hookUpdate(a)},"parentUpdate");Hooks.on("controlToken",(s,a)=>{this.updateDSKHotbar()}),Hooks.on("updateActor",(s,a)=>{ie.hookUpdate(s.id)}),Hooks.on("updateToken",(s,a,i)=>{a._id==Ra(game.dsk.apps.tokenHotbar,"actor.prototypeToken.id")&&this.updateDSKHotbar()}),Hooks.on("updateOwnedItem",(s,a)=>{ie.hookUpdate(s.data.id)}),Hooks.on("createOwnedItem",(s,a)=>{ie.hookUpdate(s.data.id)}),Hooks.on("deleteOwnedItem",(s,a)=>{ie.hookUpdate(s.data.id)}),Hooks.on("updateItem",(s,a)=>{t(s)}),Hooks.on("createItem",(s,a)=>{t(s)}),Hooks.on("deleteItem",(s,a)=>{t(s)})}static hookUpdate(e){e==Ra(game.dsk.apps.tokenHotbar,"actor.id")&&game.dsk.apps.tokenHotbar.updateDSKHotbar()}resetPosition(){let e=$("#hotbar").first().position(),t=game.settings.get("dsk","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}static get defaultOptions(){let e=super.defaultOptions,t=$("#hotbar").first().position(),s=game.settings.get("dsk","tokenhotbarSize"),a=game.settings.get("dsk","tokenhotbarPosition");return Es(e,{classes:e.classes.concat(["dsk","tokenQuickHot"]),itemWidth:s,resizable:!1,height:s+45,zIndex:61,left:t.left+8,top:t.top-s-25,template:"systems/dsk/templates/status/tokenHotbar.html",title:"TokenHotbar"}),Es(e,a),e}async _onWheelResize(e){let t=game.settings.get("dsk","tokenhotbarSize");e.originalEvent.deltaY>0?t=Math.min(100,t+5):t=Math.max(15,t-5),await game.settings.set("dsk","tokenhotbarSize",t),await this.render(!0)}async _cycleLayout(e){if(e.button==2){let t=game.settings.get("dsk","tokenhotbarLayout")+1;t==4&&(t=0),await game.settings.set("dsk","tokenhotbarLayout",t),await this.render(!0)}}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async s=>(s.stopPropagation(),s.preventDefault(),await this._onWheelResize(s),!1)),t.on("mousedown",async s=>{await this._cycleLayout(s)}),e.on("mousedown","li",async s=>(s.stopPropagation(),await this.executeQuickButton(s),!1)),e.on("mouseenter","li.primary",s=>{let a=s.currentTarget.dataset.category;this.category=a,setTimeout(()=>{e.find(".secondary").removeClass("shown"),a==this.category&&e.find(`.secondary[data-category="${a}"]`).addClass("shown")},700)}),e.on("mouseleave","li.primary",s=>{let a=s.currentTarget.dataset.category;this.category=void 0,setTimeout(()=>{a!=this.category&&e.find(`.secondary[data-category="${a}"]`).removeClass("shown")},50)})}async executeQuickButton(e){let t=canvas.tokens.controlled[0].actor,s=canvas.tokens.controlled[0].id,a=e.currentTarget.dataset.id;switch(e.currentTarget.dataset.subfunction){case"addEffect":Ve.showDialog();break;case"effect":let n=t.effects.get(a),r=[...n.statuses][0];e.button==0?r?await t.addCondition(r,1,!1,!1):n.sheet.render(!0):e.button==2&&(r?await t.removeCondition(r,1,!1):await t.sheet._deleteActiveEffect(a)),await this.render(!0);break;case"onUse":let l=t.items.get(a);new ee(l).executeOnUseEffect();break;default:let u=t.items.get(a);if(u){if(e.button==2)return u.sheet.render(!0);switch(u.type){case"meleeweapon":case"rangeweapon":case"trait":t.setupWeapon(u,"attack",{},s).then(d=>{t.basicTest(d)});break;case"ahnengabe":t.setupSpell(u,{},s).then(d=>{t.basicTest(d)});break;case"skill":t.setupSkill(u,{},s).then(d=>{t.basicTest(d)});break}}}}subWidth(e,t,s=7){return`style="width:${Math.ceil(e.length/s)*200}px"`}async getData(){let e=await super.getData(),t=this.actor,s={attacks:[],spells:[],default:[],skills:[]},a,i,n=[],r=[],l=[],c=game.settings.get("dsk","tokenhotbarLayout"),u=c%2,d=ie.defaultOptions.itemWidth,f=["ahnengabe"];if(t){let b=[],T=[];if(l=(await t.actorEffects()).map(g=>({name:g.name,id:g.id,icon:g.img,cssClass:"effect",abbrev:`${g.name[0]} ${g.getFlag("dsk","value")||""}`,subfunction:"effect"})),game.combat){let g=t.items.filter(k=>k.type=="combatskill").map(k=>D._calculateCombatSkillValues(k.toObject(),t.system)),y=["meleeweapon","rangeweapon"],v=["meleeAttack","rangeAttack"];for(let k of t.items){if(k.type=="trait"&&v.includes(k.system.traitType)){let I=D._parseDmg(k.toObject());s.attacks.push({name:k.name,id:k.id,icon:k.img,cssClass:`weapon ${k.id}`,abbrev:k.name[0],attack:k.system.at,damage:I.damagedie,dadd:I.damageAdd})}else if(y.includes(k.type)&&k.system.worn.value==!0){let I=k.type=="meleeweapon"?D._prepareMeleeWeapon(k.toObject(),g,t):D._prepareRangeWeapon(k.toObject(),[],g,t);s.attacks.push({name:k.name,id:k.id,icon:k.img,cssClass:`weapon ${k.id}`,abbrev:k.name[0],attack:I.attack,damage:I.damagedie,dadd:I.damageAdd})}else if(f.includes(k.type))k.system.effectFormula?s.spells.push({name:k.name,id:k.id,icon:k.img,cssClass:"spell",abbrev:k.name[0]}):T.push({name:k.name,id:k.id,icon:k.img,cssClass:"spell",abbrev:k.name[0]});else if(["skill"].includes(k.type)&&this.combatSkills.includes(k.name))s.default.push({name:`${k.name} (${k.system.level})`,id:k.id,icon:k.img,cssClass:"skill",abbrev:k.name[0]});else if(["skill"].includes(k.type)){let I={name:`${k.name} (${k.system.level})`,id:k.id,icon:k.img,cssClass:"skill",addClass:k.system.group,abbrev:k.name[0],tw:k.system.level};b.push(I)}else k.type=="consumable"&&n.push({name:k.name,id:k.id,icon:k.img,cssClass:"consumable",abbrev:k.system.quantity});k.getFlag("dsk","onUseEffect")&&r.push({name:k.name,id:k.id,icon:k.img,cssClass:"onUse",abbrev:k.name[0],subfunction:"onUse"})}a=n.pop()}else{let g=[];for(let y of t.items){if(["skill"].includes(y.type)&&this.defaultSkills.includes(y.name))s.default.push({name:`${y.name} (${y.system.level})`,id:y.id,icon:y.img,cssClass:"skill",abbrev:y.name[0]});else if(["skill"].includes(y.type)){let v={name:`${y.name} (${y.system.level})`,id:y.id,icon:y.img,cssClass:"skill",addClass:y.system.group,abbrev:y.name[0],tw:y.system.level};y.system.level>0&&g.push(v),b.push(v)}else f.includes(y.type)&&(y.system.effectFormula?s.spells.push({name:y.name,id:y.id,icon:y.img,cssClass:"spell",abbrev:y.name[0]}):T.push({name:y.name,id:y.id,icon:y.img,cssClass:"spell",abbrev:y.name[0]}));y.getFlag("dsk","onUseEffect")&&r.push({name:y.name,id:y.id,icon:y.img,cssClass:"onUse",abbrev:y.name[0],subfunction:"onUse"})}s.skills.push(...g.sort((y,v)=>v.tw-y.tw).slice(0,5))}i=r.pop(),s.spells.length==0&&T.length>0&&s.spells.push(T.pop()),s.spells.length>0&&T.length>0&&(s.spells[0].more=T.sort((g,y)=>g.name.localeCompare(y.name)),s.spells[0].subwidth=this.subWidth(T,d)),s.default.length>0&&b.length>0&&(s.default[0].more=b.sort((g,y)=>g.addClass.localeCompare(y.addClass)||g.name.localeCompare(y.name)),s.default[0].subwidth=this.subWidth(b,d,20)),a&&(n.length>0&&(a.more=n,a.subwidth=this.subWidth(n,d)),s.consumables=[a]),i&&(r.length>0&&(i.more=r,i.subwidth=this.subWidth(r,d)),s.onUsages=[i])}if(this.showEffects){let b=game.i18n.localize("dsk.CONDITION.add"),T={name:b,id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:b[0],subfunction:"addEffect"};l.length>0&&(T.more=l,T.subwidth=this.subWidth(l,d)),s.effects=[T]}let p=Object.keys(s).reduce((b,T)=>b+s[T].length,0);return u?(this.position.width=d,this.position.height=d*p+14):(this.position.width=d*p+14,this.position.height=d),Es(e,{items:s,itemWidth:d,direction:c,count:p}),e}async render(e,t={}){let s=await super.render(e,t);return this._element&&this._element.css({zIndex:61}),s}setPosition({left:e,top:t,width:s,height:a,scale:i}={}){let n=super.setPosition({left:e,top:t,width:s,height:a,scale:i}),r=this.element[0];if(!r.style.width||s){let l=s||r.offsetWidth,c=r.style.maxWidth||window.innerWidth;n.width=s=Math.clamp(l,0,c),r.style.width=s+"px",s+n.left>window.innerWidth&&(e=n.left)}return game.settings.set("dsk","tokenhotbarPosition",{left:n.left,top:n.top}),n}async updateDSKHotbar(){let e=canvas.tokens.controlled;if(this.actor=void 0,this.showEffects=!1,e.length===1){let t=e[0].actor;t&&t.isOwner&&(this.actor=t)}e.length>=1&&(this.showEffects=!0),await this.render(!0)}};m(ie,"TokenHotbar2");var Ve=class extends Dialog{static async showDialog(){let e=Wi(CONFIG.statusEffects).map(s=>({label:game.i18n.localize(s.name),icon:s.img,description:game.i18n.localize(s.description),id:s.id})).sort((s,a)=>s.label.localeCompare(a.label)),t=new Ve({title:game.i18n.localize("dsk.CONDITION.add"),content:await renderTemplate("systems/dsk/templates/dialog/addstatusdialog.html",{effects:e}),buttons:{}});t.position.height=Math.ceil(e.length/3)*36+170,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(a=>this.addEffect(a));let t=m(a=>this._filterConditions($(a.currentTarget),e),"filterConditions"),s=e.find(".conditionSearch");s.keyup(a=>this._filterConditions($(a.currentTarget),e)),s[0]&&s[0].addEventListener("search",t,!1)}_filterConditions(e,t){if(e.val()!=null){let s=e.val().toLowerCase().trim(),a=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),a.filter(function(){return $(this).find("span").text().toLowerCase().trim().indexOf(s)==-1}).addClass("filterHide")}}async addEffect(e){for(let t of canvas.tokens.controlled)await t.actor.addCondition(e.currentTarget.dataset.value,1,!1,!1);game.dsk.apps.tokenHotbar.render(!0),this.close()}static get defaultOptions(){let e=super.defaultOptions,t=Math.ceil(CONFIG.statusEffects.length/3)*32;return Es(e,{classes:["dsk","tokenStatusEffects"],width:700,resizable:!0,height:t}),e}};m(Ve,"AddEffectDialog");var _=class{static payMoney(e,t,s=!1){let a=_.canPay(e,t,s);return a.success&&_._updateMoney(e,a.actorsMoney.sum-a.money),!s&&a.msg!=""&&ChatMessage.create(h.chatDataSetup(`<p>${a.msg}</p>`,"roll")),a.success}static canPay(e,t,s){let a=this._getPaymoney(t),i={success:!1,msg:"",money:a};return a&&(i.actorsMoney=this._actorsMoney(e),i.actorsMoney.sum>=a?(i.msg=game.i18n.format("dsk.PAYMENT.pay",{actor:e.name,amount:_._moneyToString(a)}),i.success=!0):(i.msg=game.i18n.format("dsk.PAYMENT.cannotpay",{actor:e.name,amount:_._moneyToString(a)}),s&&ui.notifications.notify(i.msg))),i}static getMoney(e,t,s=!1){let a=this._getPaidmoney(t);if(a){let i=this._actorsMoney(e);_._updateMoney(e,i.sum+a);let n=`<p>${game.i18n.format("dsk.PAYMENT.getPaid",{actor:e.name,amount:_._moneyToString(a)})}</p>`;return s||ChatMessage.create(h.chatDataSetup(n,"roll")),!0}}static _updateMoney(e,t){let s=_._moneyToCoins(t);e.update({"system.money":s})}static createGetPaidChatMessage(e,t=void 0){let s=this._getPaidmoney(e);if(s){let a=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("dsk.PAYMENT.wage")}</b></p><p>${game.i18n.format("dsk.PAYMENT.getPaidSum",{amount:_._moneyToString(s)})}${a}</p><button class="payButton" data-pay="1" data-amount="${s}">${game.i18n.localize("dsk.PAYMENT.getPaidButton")}</button>`;ChatMessage.create(h.chatDataSetup(i,"roll"))}}static createPayChatMessage(e,t=void 0){let s=this._getPaymoney(e);if(s){let a=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("dsk.PAYMENT.bill")}</b></p>${game.i18n.format("dsk.PAYMENT.paySum",{amount:_._moneyToString(s)})}${a}</p><button class="payButton" data-pay="0" data-amount="${s}">${game.i18n.localize("dsk.PAYMENT.payButton")}</button>`;ChatMessage.create(h.chatDataSetup(i,"roll"))}}static _getPaidmoney(e){let t=this._parseMoneyString(e);if(!t){let s=`<p><b>${game.i18n.localize("dsk.PAYMENT.error")}</b></p><p><i>${game.i18n.localize("dsk.PAYMENT.getPaidexample")}</i></p>`;return ChatMessage.create(h.chatDataSetup(s,"roll")),!1}return t}static _getPaymoney(e){let t=this._parseMoneyString(e);if(!t){let s=`<p><b>${game.i18n.localize("dsk.PAYMENT.error")}</b></p><p><i>${game.i18n.localize("dsk.PAYMENT.payexample")}</i></p>`;return ChatMessage.create(h.chatDataSetup(s,"roll")),!1}return t}static _parseMoneyString(e){let t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return t?Number(t[0]):!1}static _actorsMoney(e){return{sum:e.system.money}}static handlePayAction(e,t,s,a=void 0){if(game.user.isGM&&!a){ui.notifications.notify(game.i18n.localize("dsk.PAYMENT.onlyActors"));return}a?J.playMoneySound(!0):a=game.user.character;let i=!1;a&&t?i=_.payMoney(a,s):a&&!t?i=_.getMoney(a,s):ui.notifications.notify(game.i18n.localize("dsk.PAYMENT.onlyActors")),i&&e&&(e.fadeOut(),game.socket.emit("system.dsk",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:{[`flags.dsk.userHidden.${game.user.id}`]:!0}}}))}static _moneyToCoins(e){return e}static _moneyToString(e){return`<span class="nobr">${_._moneyToCoins(e)} <span data-tooltip="dsk.money" class="chatmoney" style="background-size:contain;background-image:url('systems/dsk/icons/categories/money.webp');"></span></span>`}static async chatListeners(e){e.on("click",".payButton",t=>{let s=$(t.currentTarget);_.handlePayAction(s,Number(s.attr("data-pay"))!=1,s.attr("data-amount")),J.playMoneySound()})}};m(_,"DSKPayment");var{mergeObject:xs,getProperty:P,duplicate:Qs}=foundry.utils,Je=m(o=>class extends o{static get defaultOptions(){let e=super.defaultOptions;return xs(e,{classes:e.classes.concat(["merchant-sheet"])}),e}static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/merchant-sheet.html"}get template(){if(this.merchantSheetActivated())switch(P(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsk/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsk/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsk/templates/actors/merchant/merchant-epic.html";default:return super.template}return this.constructor.merchantTemplate}merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(P(this.actor.system,"merchant.merchantType"))}async allowMerchant(e,t){let s=Qs(this.actor.ownership),a=t?1:0;for(let i of e)s[i]=a;await this.actor.update({ownership:s},{diff:!1,recursive:!1,noHook:!0})}activateListeners(e){super.activateListeners(e),e.find(".allowMerchant").click(async t=>{let s=$(t.currentTarget).attr("data-user-id"),a=$(t.currentTarget).find("i");await this.allowMerchant([s],!a.hasClass("fa-check-circle")),a.toggleClass("fa-circle fa-check-circle")}),e.find(".toggleAllAllowMerchant").click(async t=>{let s=game.users.filter(i=>!i.isGM).map(i=>i.id),a=t.currentTarget.dataset.lock=="true";await this.allowMerchant(s,a),this.render()}),e.find(".lockTradeSection").click(t=>this.lockTradeSection(t)),e.find(".item-tradeLock").click(t=>this.toggleTradeLock(t)),e.find(".randomGoods").click(t=>this.randomGoods(t)),e.find(".clearInventory").click(t=>this.clearInventory(t)),e.find(".removeOtherTradeFriend").click(()=>this.removeOtherTradeFriend()),e.find(".choseTradefriend").click(()=>this.choseTradefriend()),e.find(".setCustomPrice").click(t=>$(t.currentTarget).addClass("edit")),e.find(".customPriceTag").change(async t=>this.setCustomPrice(t)).blur(t=>$(t.currentTarget).closest(".setCustomPrice").removeClass("edit")),e.find(".buy-item").click(t=>{this.advanceWrapper(t,"buyItem",t),J.playMoneySound()}),e.find(".sell-item").click(t=>{this.advanceWrapper(t,"sellItem",t),J.playMoneySound()}),e.find(".item-external-edit").click(t=>{t.preventDefault();let s=this._getItemId(t);this.getTradeFriend().items.get(s).sheet.render(!0)}),e.find(".changeAmountAllItems").mousedown(t=>this.changeAmountAllItems(t)),e.find(".gearSearch").prop("disabled",!1)}_canDragStart(e){return!this.merchantSheetActivated()&&this.isEditable}async toggleTradeLock(e){let t=this._getItemId(e),s=this.actor.items.get(t);this.actor.updateEmbeddedDocuments("Item",[{_id:s.id,"system.tradeLocked":!s.system.tradeLocked}])}async setCustomPrice(e){e.stopPropagation(),e.preventDefault();let t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"flags.dsk.customPriceTag":Number(e.target.value)}])}removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}async choseTradefriend(){(await Ye.getDialog(this)).render(!0)}async lockTradeSection(e){let t=[],s=this.filterRule(e),a;for(let i of this.actor.items)if(s(i)){let n=i.toObject();a===void 0&&(a=!n.system.tradeLocked),n.system.tradeLocked=a,t.push(n)}this.actor.updateEmbeddedDocuments("Item",t)}filterRule(e){let t=e.currentTarget.dataset.type;return w.equipmentTypes[t]?s=>s.type=="equipment"&&s.system.category==t:s=>s.type==t&&w.equipmentCategories.includes(s.type)}async changeAmountAllItems(e){let t=[],s=this.filterRule(e);for(let a of this.actor.items)if(s(a)){let i=a.toObject();R.increment(e,i,"system.quantity",0),t.push(i)}this.actor.updateEmbeddedDocuments("Item",t)}playerViewEnabled(){return P(this.actor.system,"merchant.playerView")}async buyItem(e){await this.transferItem(this.actor,this.getTradeFriend(),e,!0)}async sellItem(e){await this.transferItem(this.getTradeFriend(),this.actor,e,!1)}async transferItem(e,t,s,a=!0){let i=this._getItemId(s),n=$(s.currentTarget).attr("data-price"),r=s.ctrlKey?10:1;game.user.isGM?await this.constructor.finishTransaction(e,t,n,i,a,r):(this.constructor.noNeedToPay(t,e,n)||_.canPay(t,n,!0))&&game.socket.emit("system.dsk",{type:"trade",payload:{target:this.constructor.transferTokenData(t),source:this.constructor.transferTokenData(e),price:n,itemId:i,buy:a,amount:r}})}static transferTokenData(e){let t={actor:e.id};return e.token&&(t.token=e.token.id),t}static async finishTransaction(e,t,s,a,i,n){let r=e.items.get(a).toObject();if(Number(r.system.quantity)>0){n=Math.min(Number(r.system.quantity),n),s=`${Number(s)*n}`;let l=this.noNeedToPay(t,e,s);(l||_.payMoney(t,s,!0))&&(P(r,"system.worn.value")&&(r.system.worn.value=!1),i?(await this.updateTargetTransaction(t,r,n,e,s),await this.updateSourceTransaction(e,t,r,s,a,n),await this.transferNotification(r,t,e,i,s,n,l),await this.selfDestruction(e)):(await this.updateSourceTransaction(e,t,r,s,a,n),await this.updateTargetTransaction(t,r,n,e,s),await this.transferNotification(r,e,t,i,s,n,l)))}}static isTemporaryToken(e){return P(e.system,"merchant.merchantType")=="loot"&&P(e.system,"merchant.temporary")}static async selfDestruction(e){if(this.isTemporaryToken(e)&&!e.items.some(s=>w.equipmentCategories.includes(s.type)||s.type=="money"&&s.system.quantity>0)){game.socket.emit("system.dsk",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(e)}});let s=e.getActiveTokens().map(a=>a.id);await canvas.scene.deleteEmbeddedDocuments("Token",s),await game.actors.get(e.id).delete(),this.hideDeletedSheet(e)}}static async hideDeletedSheet(e){e.sheet.close(!0)}static async transferNotification(e,t,s,a,i,n,r){let l=game.settings.get("dsk","merchantNotification");if(l==0||P(e,"system.category")=="service")return;let c="dsk.MERCHANT."+(a?"buy":"sell")+(r?"Loot":"")+"Notification",u=game.i18n.format(c,{item:e.name,source:t.name,target:s.name,amount:n,price:i,buy:a}),d=h.chatDataSetup(u);l==2&&(d.whisper=ChatMessage.getWhisperRecipients("GM").map(f=>f.id)),await ChatMessage.create(d)}static noNeedToPay(e,t,s){return s==0||P(e.system,"merchant.merchantType")=="loot"||P(t.system,"merchant.merchantType")=="loot"}static async updateSourceTransaction(e,t,s,a,i,n){let r=Qs(s);Number(r.system.quantity)>n||r.type=="money"?(r.system.quantity=Number(r.system.quantity)-n,await e.updateEmbeddedDocuments("Item",[r])):await e.deleteEmbeddedDocuments("Item",[i]),this.noNeedToPay(e,t,a)||await _.getMoney(e,a,!0)}static async updateTargetTransaction(e,t,s,a,i){let n=Qs(t);if(P(n,"system.category")=="service"){let l=game.i18n.format("dsk.MERCHANT.buyNotification",{item:n.name,amount:s,source:e.name,target:a.name,price:i});ChatMessage.create(h.chatDataSetup(l))}else{let l=e.items.find(c=>C.areEquals(n,c));n.system.quantity=s,l?await C.stackItems(l,n,e):await e.createEmbeddedDocuments("Item",[n])}}getTradeFriend(){return this.otherTradeFriend||game.user.character}async _manageDragItems(e,t){switch(t){case"creature":case"npc":case"character":this.setTradeFriend(e);break;default:return super._manageDragItems(e,t)}}setTradeFriend(e){let t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}async _render(e=!1,t={}){if(!game.user.isGM&&P(this.actor.system,"merchant.merchantType")=="loot"&&P(this.actor.system,"merchant.locked")){foundry.audio.AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1);return}await super._render(e,t)}_getHeaderButtons(){let e=super._getHeaderButtons();return this.actor.isOwner&&e.unshift({class:"playerview",tooltip:"dsk.SHEET.switchLimited",icon:"fas fa-toggle-on",onclick:async t=>this._togglePlayerview(t)}),e}_togglePlayerview(e){this.actor.update({"system.merchant.playerView":!P(this.actor.system,"merchant.playerView")})}async randomGoods(e){let t=await renderTemplate("systems/dsk/templates/dialog/randomGoods-dialog.html",{categories:w.equipmentCategories});new Dialog({title:game.i18n.localize("dsk.MERCHANT.randomGoods"),content:t,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:s=>this.addRandomGoods(this.actor,s,e)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async clearInventory(e){new Dialog({title:game.i18n.localize("dsk.MERCHANT.clearInventory"),content:game.i18n.localize("dsk.MERCHANT.deleteAllGoods"),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{this.removeAllGoods(this.actor,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async addRandomGoods(e,t,s){let a=$(s.currentTarget).text();$(s.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=[];t.find('input[type="checkbox"]:checked').each(function(){let c=$(this).val();i.push({name:c,count:Number(t.find(`input[name="each_${c}"]`).val()),number:Number(t.find(`input[name="number_${c}"]`).val())})});let n=game.dsk.itemLibrary;n.equipmentBuild||await n.buildEquipmentIndex();let r=[];for(let c of i){let u=(await n.getRandomItems(c.name,c.number)).map(d=>{let f=d.toObject();return f.system.quantity=c.count,f});r.push(...u)}let l={};r=r.filter(function(c){let u=P(c,"system.effect");u=typeof u=="object"&&u!==null&&P(u,"attributes")||"";let d=Number(P(c,"system.price"))||0;if(u!=""||d>1e4)return!1;let f=`${c.type}_${c.name}`;return(l.hasOwnProperty(f)?!1:l[f]=!0)&&e.items.filter(function(p){return p.type==c.type&&p.name==c.name}).length==0}),await e.createEmbeddedDocuments("Item",r),$(s.currentTarget).text(a)}async removeAllGoods(e,t){let s=$(t.currentTarget).text();$(t.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let a=e.items.filter(i=>w.equipmentCategories.includes(i.type)&&!P(i,"worn.value")).map(i=>i.id);await e.deleteEmbeddedDocuments("Item",a),$(t.currentTarget).text(s)}async getData(e){let t=await super.getData(e);return t.merchantType=P(this.actor.system,"merchant.merchantType")||"none",t.merchantTypes={none:game.i18n.localize("dsk.MERCHANT.typeNone"),merchant:game.i18n.localize("dsk.MERCHANT.typeMerchant"),loot:game.i18n.localize("dsk.MERCHANT.typeLoot"),epic:game.i18n.localize("dsk.MERCHANT.typeEpic")},t.invName=t.merchantTypes[t.merchantType],t.players=game.users.filter(s=>!s.isGM).map(s=>(s.allowedMerchant=this.actor.testUserPermission(s,"LIMITED",!1),s.buyingFactor=P(this.actor.system,`merchant.factors.buyingFactor.${s.id}`),s.sellingFactor=P(this.actor.system,`merchant.factors.sellingFactor.${s.id}`),s)),t.merchantType!="epic"?(this.prepareStorage(t),this.merchantSheetActivated()&&(this.filterWornEquipment(t),this.prepareTradeFriend(t),t.prepare.inventory.misc.items.length==0&&(t.prepare.inventory.misc.show=!1))):this.prepareStorage(t),t.hasOtherTradeFriend=!!this.otherTradeFriend,t}filterWornEquipment(e){for(let[t,s]of Object.entries(e.prepare.inventory))s.items=s.items.filter(a=>!P(a,"system.worn.value"))}prepareStorage(e){if(e.merchantType=="merchant")for(let[t,s]of Object.entries(e.prepare.inventory))for(let a of s.items)a.defaultPrice=this.getItemPrice(a),a.calculatedPrice=Number(parseFloat(`${a.defaultPrice*(P(this.actor.system,"merchant.sellingFactor")||1)}`).toFixed(2))*(P(this.actor.system,`merchant.factors.sellingFactor.${game.user.id}`)||1),a.priceTag=` / ${a.calculatedPrice}`;else if(e.merchantType=="loot")for(let[t,s]of Object.entries(e.prepare.inventory))for(let a of s.items)a.calculatedPrice=this.getItemPrice(a)}getItemPrice(e){return Number(P(e,"flags.dsk.customPriceTag"))||(e.type=="consumable"?game.dsk.config.ItemSubClasses.consumable.consumablePrice(e):Number(e.system.price))}prepareTradeFriend(e){let t=this.getTradeFriend();if(t){let s=t.prepareItems({details:[]}),a=P(this.actor.system,"merchant.merchantType")=="loot"?1:(P(this.actor.system,"merchant.buyingFactor")||1)*(P(this.actor.system,`merchant.factors.buyingFactor.${game.user.id}`)||1),i=this.prepareSellPrices(s.inventory,a);i.misc.items.length==0&&(i.misc.show=!1),xs(e,{tradeFriend:{img:t.img,name:t.name,inventory:i,money:t.system.money}})}else xs(e,{tradeFriend:{inventory:[],money:""}})}prepareSellPrices(e,t){for(let[s,a]of Object.entries(e))for(let i of a.items)i.calculatedPrice=Number(parseFloat(`${this.getItemPrice(i)*t}`).toFixed(2));return e}},"MerchantSheetMixin"),Ye=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return xs(e,{}),e}static async getDialog(e){let t=await game.dsk.apps.gameMasterMenu?.getTrackedHeros();if(!t)return ui.notifications.warn("The required functionality is not yet available.");let s=new Ye({title:game.i18n.localize("dsk.DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsk/templates/dialog/selectTradeFriend.html",{users:t}),buttons:{}});return s.actor=e,s}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){this.actor.setTradeFriend({_id:e.currentTarget.dataset.id}),this.close()}};m(Ye,"SelectTradefriendDialog");var he=class extends Je(ue){};m(he,"MerchantSheetDSK");function La(){Hooks.once("ready",async()=>{game.socket.on("system.dsk",o=>{switch(o.type){case"hideDeletedSheet":let e=o.payload.target.token?game.actors.tokens[o.payload.target.token]:game.actors.get(o.payload.target.actor);he.hideDeletedSheet(e);break}}),game.user.isGM&&game.socket.on("system.dsk",o=>{if(!!h.isActiveGM())switch(o.type){case"target":{let e=game.scenes.get(o.payload.scene);new Token(e.getEmbeddedDocument("Token",o.payload.target)).actor.update({"flags.oppose":o.payload.opposeFlag})}break;case"addEffect":Y.applyEffect(o.payload.id,o.payload.mode,o.payload.actors);break;case"hideQueryButton":F.hideReactionButton(o.payload.id);break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(o.payload.speaker);break;case"updateMsg":game.messages.get(o.payload.id).update(o.payload.updateData);break;case"deleteMsg":game.messages.get(o.payload.id).delete();break;case"showDamage":F.showDamage(game.messages.get(o.payload.id),o.payload.hide);break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"trade":{let e=o.payload.source.token?game.actors.tokens[o.payload.source.token]:game.actors.get(o.payload.source.actor),t=o.payload.target.token?game.actors.tokens[o.payload.target.token]:game.actors.get(o.payload.target.actor);he.finishTransaction(e,t,o.payload.price,o.payload.itemId,o.payload.buy,o.payload.amount)}break;case"playWhisperSound":o.payload.whisper.includes(game.user.id)&&foundry.audio.AudioHelper.play({src:o.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(o.payload.id).then(e=>{new ee(e).socketedConditionAddActor(o.payload.actors.map(s=>game.actors.get(s)),o.payload.data)});break;case"socketedConditionAdd":fromUuid(o.payload.id).then(e=>{new ee(e).socketedConditionAdd(o.payload.targets,o.payload.data)});break;case"socketedRemoveCondition":fromUuid(o.payload.id).then(e=>{new ee(e).socketedRemoveCondition(o.payload.targets,o.payload.coreId)});break;case"socketedActorTransformation":fromUuid(o.payload.id).then(e=>{new ee(e).socketedActorTransformation(o.payload.targets,o.payload.update)});break;case"itemDrop":{let e=o.payload.sourceActorId?game.actors.get(o.payload.sourceActorId):void 0;fromUuid(o.payload.itemId).then(t=>{Js(e,t,o.payload.data,o.payload.amount)})}break;default:console.warn(`Unhandled socket data type ${o.type}`)}}),await fe.firstTimeMessage(),ze.showOneMessage(),h.moduleEnabled("vtta-tokenizer")&&!await game.settings.get("dsk","tokenizerSetup")&&game.user.isGM&&(await game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsk/icons/backgrounds/token_green.webp"),await game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsk/icons/backgrounds/token_black.webp"),await game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsk/icons/backgrounds/token_blue.webp"),await game.settings.set("dsk","tokenizerSetup",!0)),h.moduleEnabled("dice-so-nice")&&!await game.settings.get("dsk","diceSetup")&&game.user.isGM&&(await game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0),await game.settings.set("dsk","diceSetup",!0)),C.setupSubClasses(),Me.connectHooks(),_a(),ie.registerTokenHotbar(),ra(),Ma()})}m(La,"initReady");var{mergeObject:Fa,duplicate:Ki}=foundry.utils,Ze=class extends Application{constructor(e){super(e),this.adventures=[],this.books=[],this.rshs=[],this.manuals=[],this.fulltextsearch=!0}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],Fa(e,{classes:e.classes.concat(["dsk","largeDialog","noscrollWizard","bookWizardsheet","dskjournalbrowser"]),width:800,height:880,scrollY:[".pages-list .scrollable"],template:"systems/dsk/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("dsk.Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}static initHook(){Ze.wizard=new Ze,game.dsk.apps.journalBrowser=Ze.wizard,Hooks.on("renderJournalDirectory",(e,t)=>{let s=$('<div class="header-actions action-buttons flexrow"></div>'),a=$(`<button id="openJournalBrowser"><i class="fa fa-book"></i>${game.i18n.localize("dsk.Book.Wizard")}</button>`);a.on("click",()=>{Ze.wizard.render(!0)}),s.append(a),t.find(".header-actions:first-child").after(s)})}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"increaseFontSize",tooltip:"dsk.SHEET.increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>za($(this._element).find(".chapter"))}),e.unshift({label:"Library",class:"library",tooltip:"dsk.Book.home",icon:"fas fa-book",onclick:async()=>this._showBooks()}),e}_showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!0,this.searchString=void 0,this.currentType=void 0,this.pageTocs=void 0,this.selectedSubChapter=void 0,this.loadPage(this._element)}async toggleBookVisibility(e,t,s){let a=game.settings.get("dsk","expansionPermissions");a[e]=s,await game.settings.set("dsk","expansionPermissions",a);let i=this[t].find(l=>l.id==e),n=await(await fetch(i.path)).json(),r=["actors","journal","scenes"];for(let l of r){if(!n[l])continue;let c=game.packs.get(n[l]),u=s?"OBSERVER":"NONE",d={ownership:{PLAYER:u,TRUSTED:u}};await c.configure(d)}this.render()}activateListeners(e){super.activateListeners(e),e.on("click",".toggleVisibility",async t=>{let s=t.currentTarget.dataset.itemid,a=t.currentTarget.dataset.type,i=$(t.currentTarget).find("i").hasClass("fa-toggle-off");this.toggleBookVisibility(s,a,i)}),e.on("click",".showMapNote",t=>{game.journal.get(t.currentTarget.dataset.entryid).panToNote()}),e.on("search keyup",".filterJournals",t=>{this.filterToc(t.currentTarget.value)}),e.on("click",".heading-link",t=>this._onClickPageLink(t)),e.on("click",".show-item",async t=>{let s=t.currentTarget.dataset.uuid;(await fromUuid(s)).sheet.render(!0)}),e.on("click",".movePage",async t=>this.movePage(t)),e.on("click",".loadBook",t=>{this.loadBook($(t.currentTarget).text(),e,t.currentTarget.dataset.type)}),e.on("click",".getChapter",t=>{this.selectedType=$(t.currentTarget).closest(".toc").attr("data-type"),this.selectedChapter=t.currentTarget.dataset.id,this.content=void 0,this.pageTocs=void 0,this.loadPage(e)}),e.on("click",".subChapter",async t=>{let s=$(t.currentTarget).text(),a=t.currentTarget.dataset.jid;a?await this.loadJournalById(a):($(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-id="${s}"]`).addClass("selected"),await this.loadJournal(s)),this._saveScrollPositions(e),e.find(".toc").html(await this.getToc()),this._restoreScrollPositions(e),this.searchString&&this.filterToc(this.searchString)}),q.bindRollCommands(e),e.find(".tocCollapser").click(t=>{$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")}),e.on("mousedown",".openPin",async t=>{let s=t.currentTarget.dataset.uuid;t.button==0?this.showJournal(await fromUuid(s)):t.button==2&&this.unpinJournal(s)}),e.on("click",".showJournal",t=>{this.popJournal($(t.currentTarget).closest("h1").attr("data-uuid"))}),e.on("click",".pinJournal",t=>{let s=$(t.currentTarget).closest("h1"),a=s.attr("data-uuid"),i=s.text();this.pinJournal(a,i)}),e.on("click",".activateScene",t=>{this.showSzene(t.currentTarget.dataset.id,t.currentTarget.dataset.mode)}),e.on("click",".fulltextsearch",t=>{this.fulltextsearch=!this.fulltextsearch,$(t.currentTarget).toggleClass("on"),this.filterToc(e.find(".filterJournals").val())}),e.on("mousedown",".chapter img",t=>{let s=this.book.id;t.button==2&&h.showArtwork({name:s,uuid:"",img:$(t.currentTarget).attr("src")})}),x.bindButtons(e),e.on("click",".importBook",async()=>this.importBook()),xe(e),Ta(e,".breadcrumbs",this.resaveBreadCrumbs)}async getPagy(e,t){let s=this.journals.filter(i=>i.flags.dsk.parent==e).sort((i,n)=>i.flags.dsk.sort>n.flags.dsk.sort?1:-1),a=s.findIndex(i=>i._id==t);return{journals:s,targetindex:a}}async movePage(e){let t=e.currentTarget.dataset.action,{journals:s,targetindex:a}=await this.getPagy(this.selectedChapter,this.selectedSubChapter),i=[];for(let c of this.bookData.chapters)for(let u of c.content)i.push(u.name);let n=i.findIndex(c=>c==this.selectedChapter);if(this.bookData.chapters.findIndex(c=>c.name==this.selectedChapter),t=="next"?a++:a--,a<0){if(this.selectedChapter=i[n-1],!this.selectedChapter)return;s=(await this.getPagy(this.selectedChapter,void 0)).journals,a=0}else if(a>=s.length){if(this.selectedChapter=i[n+1],!this.selectedChapter)return;s=(await this.getPagy(this.selectedChapter,void 0)).journals,a=0}if(["prep","foundryUsage"].includes(this.selectedChapter))return;let r=s[a];r&&await this.loadJournalById(r.id);let l=await this.getToc();this._saveScrollPositions(this._element),this._element.find(".toc").html(l),this._restoreScrollPositions(this._element)}async loadJournal(e){await this.showJournal(this.journals.find(t=>t.name==e&&t.flags.dsk.parent==this.selectedChapter))}async loadJournalById(e){await this.showJournal(this.journals.find(t=>t.id==e))}async resaveBreadCrumbs(e){let t={};for(let s of e.getElementsByTagName("div"))t[s.dataset.uuid]=s.innerText;await game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(t))}markFindings(e){let t=e.closest(".tocCollapsing");t.find(".searchLines").remove();let s=e.find(".searchMatch");if(s.length==0)return;let a=[],i=e.find("> div")[0].getBoundingClientRect();for(let r of s){let l=r.getBoundingClientRect();a.push(`<div class="marker" style="top:${(l.top-i.top)/i.height*100}%"></div>`)}let n=$(`<div class="searchLines">${a.join("")}</div>`);t.append(n)}async filterToc(e){if(this.searchString=e,e!=null)if(e=e.toLowerCase().trim(),e!=""){let a=[];this.fulltextsearch?(this.journalIndex||(this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),await this.journalIndex.add(this.journals.map(i=>new Os(i)))),a=await this.journalIndex.search(e)):a=this.journals.filter(i=>i.name.toLowerCase().trim().indexOf(e)!=-1),a=a.map(i=>`<li class="fas fa-caret-right"><a data-jid="${i.id}" class="subChapter">${i.name}</a></li>`),$(this._element).find(".tocContent").html(`<ul>${a.join(`
`)}</ul>`)}else{let a=await this.getToc();$(this._element).find(".toc").html(a).find(".filterJournals").trigger("focus")}let t=await this.getChapter(),s=$(this._element).find(".chapter");s.html(t),this.markFindings(s)}async showSearchResults(e){this.searchString&&await TextEditor._replaceTextContent(TextEditor._getTextNodes(e),new RegExp(this.searchString,"ig"),(t,s)=>$(`<span class="searchMatch">${t[0]}</span>`)[0])}_onClickPageLink(e){let t=e.currentTarget.closest("[data-anchor]")?.dataset.anchor;if(t){let a=this.element[0].querySelector(`.chapter [data-anchor="${t}"]`);if(a){a.scrollIntoView({behavior:"smooth"});return}}this.element[0].querySelector(".journalHeader")?.scrollIntoView({behavior:"smooth"})}async _renderHeadings(e,t=!1){let s=Object.values(e);t&&s.shift();let a=Math.min(...s.map(i=>i.level));return await renderTemplate("templates/journal/journal-page-toc.html",{headings:s.reduce((i,{text:n,level:r,slug:l,element:c})=>(c&&(c.dataset.anchor=l),r<a+2&&i.push({text:n,slug:l,level:r-a+2}),i),[])})}async renderContent(e){this.content=e.id;let t="",s=[];for(let n of e.pages){let r=e.sheet.getPageSheet(n.id),l=await r.getData(),c=(await r._renderInner(l)).get(),u=n.name.replace(/ Text$/gi,""),d=e.name==u,f=JournalEntryPage.implementation.buildTOC(c);s.push(await this._renderHeadings(f,d));let p=c[c.length-1];await this.showSearchResults(p),p=$(p).html(),n.type=="video"&&(p=`<div class="video-container">${p}</div>`),d||(p=`<h2 data-anchor="${n.name.slugify()}">${u}</h2>${p}`),t+=p}this.pageTocs=s.join("");let a=this.findSceneNote(e.getFlag("dsk","initId")),i=await TextEditor.enrichHTML(t,{secrets:game.user.isGM,async:!0});return`<div><h1 class="journalHeader" data-uuid="${e.uuid}">${e.name}<div class="jrnIcons">${a}<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>${i}`}async showJournal(e){let t=$(this._element).find(".chapter");t.html(await this.renderContent(e)),this.selectedSubChapter=e.id,$(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-jid="${e.id}"]`).addClass("selected"),xe(t),this.markFindings(t),t.find(".documentName-link, .entity-link, .content-link").on("click",s=>{let a=s.currentTarget.dataset;this.bookData&&a.pack==this.bookData.journal&&a.type!="JournalEntryPage"&&(s.stopPropagation(),this.loadJournalById(a.id))})}findSceneNote(e){if(e){let t=game.journal.find(s=>s.getFlag("dsk","initId")==e);if(t&&t.sceneNote)return`<a class="showMapNote" data-entryId="${t.id}"><i class="fas fa-map-pin"></i></a>`}return""}async importBook(){game.user.isGM&&new zs().render(this.bookData.moduleName,this.bookData.options)}async loadBook(e,t,s){this.selectedChapter=void 0,this.selectedType=void 0,this.content=void 0,s||(s=this.currentType),this.currentType=s,this.book=this[s].find(a=>a.id==e),await fetch(this.book.path).then(async a=>a.json()).then(async a=>{this.bookData=a;let i=game.packs.get(a.journal);await i.getIndex();let n=await i.getDocuments();this.journals=n,a.actors&&(i=game.packs.get(a.actors),n=await i.getIndex(),this.actors=n),a.scenes&&(i=game.packs.get(a.scenes),n=await i.getIndex(),this.scenes=n),this.checkChapters(i),this.loadPage(t)})}checkChapters(e){this.bookData.chapters||(this.bookData.isDynamic=!0,this.bookData.chapters=[{name:game.i18n.localize(`${this.bookData.moduleName}.name`),content:e.folders.map(t=>({name:t.name,id:t.id}))}])}async prefillActors(e){if(!e.actors)return[];let t=[],s=await game.folders.contents.find(i=>i.name==game.i18n.localize(`${this.bookData.moduleName}.name`)&&i.type=="Actor"&&i.folder==null),a=s?await game.folders.contents.filter(i=>i.type=="Actor"&&i.folder?.id==s.id).map(i=>i.id):void 0;for(let i of e.actors){let n=a?.length?game.actors.contents.find(u=>u.name==i&&a.includes(u.folder?.id)):void 0,r,l=n?.id,c=n?.uuid;n||(n=this.actors.find(u=>u.name==i),r=this.bookData.actors,l=n?._id,c=n?`Compendium.${r}.${l}`:void 0),t.push({name:i,actor:n,pack:r,id:l,uuid:c})}return t}async popJournal(e){(await fromUuid(e)).sheet.render(!0)}async showSzene(e,t="activate"){let s=game.scenes.contents.find(a=>a.name==e);if(!s)return ui.notifications.error(game.i18n.localize("dsk.DSKError.sceneNotInitialized"));switch(t){case"activate":s.activate();break;case"view":s.view();break;case"toggle":s.update({navigation:!s.navigation});break}}async getChapter(){if(this.book){if(this.content){let e=this.journals.find(t=>t.id==this.content);return await this.renderContent(e)}if(this.selectedChapter){if(this.selectedChapter=="prep"){let s={initDescr:game.i18n.format(`${this.bookData.options?.scope||this.bookData.moduleName}.importContent`,{defaultText:game.i18n.localize("dsk.importDefault")})},a=this.bookData.modules;for(let i of a)i.enabled=this.moduleEnabled(i.id);return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_preparation.html",{modules:a,info:s})}else if(this.selectedChapter=="foundryUsage")return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_foundry.html");let e=this.bookData.chapters.find(s=>s.name==this.selectedType).content.find(s=>s.id==this.selectedChapter),t=this.getSubChapters();return e.scenes||e.actors||t.length==0?await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_chapter.html",{chapter:e,subChapters:this.getSubChapters(),actors:await this.prefillActors(e)}):(this.selectedSubChapter=t[0].id,await this.loadJournalById(t[0].id))}return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData})}else return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),manuals:this.filterBooks(this.manuals),isGM:game.user.isGM})}filterBooks(e){let t=game.settings.get("dsk","expansionPermissions");for(let s of e)t[s.id]!=null&&(s.visible=t[s.id]);return game.user.isGM?e:e.filter(s=>s.visible==null||s.visible).sort((s,a)=>s.id.localeCompare(a.id))}getSubChapters(){let e;return this.bookData.isDynamic?e=this.journals.filter(t=>t.folder.id==this.selectedChapter).sort((t,s)=>t.sort>s.sort?1:-1):e=this.journals.filter(t=>t.flags.dsk.parent==this.selectedChapter).sort((t,s)=>t.flags.dsk.sort>s.flags.dsk.sort?1:-1),e.map(t=>{let s=this.selectedSubChapter==t.id;return{name:t.name,id:t.id,selected:s,cssClass:s?"selected":""}})}async getToc(){let e=[];if(this.book){if(e.push(...Ki(this.bookData.chapters)),this.selectedChapter){let t;for(let s of e)if(t=s.content.find(a=>a.id==this.selectedChapter),t)break;t&&(t.cssClass="selected",t.subChapters=this.getSubChapters())}return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_toc.html",{chapters:e,searchString:this.searchString,book:this.book,pageTocs:this.pageTocs,fulltextsearch:this.fulltextsearch?"on":""})}else return'<div class="libraryImg"></div>'}async loadPage(e){let t=await this.getChapter(),s=await this.getToc();this._saveScrollPositions(e),e.find(".toc").html(s);let a=e.find(".chapter");a.html(t),this.markFindings(a),this._restoreScrollPositions(e)}async getData(e){let t=await super.getData(e),s=await this.getChapter(),a=await this.getToc(),i=game.settings.get("dsk","journalFontSizeIndex"),n=w.journalFontSizes[i-1]||14;return Fa(t,{adventure:this.bookData,currentChapter:s,breadcrumbs:this.renderBreadcrumbs(),toc:a,fontSize:n}),t}async pinJournal(e,t=void 0){let s=this.readBreadCrumbs();t||(t=(await fromUuid(e))?.name||""),s[e]=t,game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(s)),this.render(!0)}unpinJournal(e){let t=this.readBreadCrumbs();delete t[e],game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(t)),this.render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch{return!1}t.type=="JournalEntry"&&this.pinJournal(t.pack?`Compendium.${t.pack}.${t.id}`:`JournalEntry.${t.id}`)}readBreadCrumbs(){let e={};try{e=JSON.parse(game.settings.get("dsk",`breadcrumbs_${game.world.id}`))}catch{console.log("No Journalbrowser notes found")}return e}renderBreadcrumbs(){let e=this.readBreadCrumbs(),t=Object.entries(e).map(s=>`<div data-tooltip="${s[1]}" data-uuid="${s[0]}" class="openPin item">${s[1]}</div>`);return t.length>0?`<div id="breadcrumbs" class="breadcrumbs wrap row-section">${t.join("")}</div>`:""}moduleEnabled(e){return game.modules.get(e)?game.modules.get(e).active?"fa-check":"fa-dash":"fa-times"}},Ne=Ze;m(Ne,"BookWizard"),O(Ne,"wizard");var zs=class extends FormApplication{render(e,t){new game.dsk.apps.DSKInitializer("DSK Module Initialization",game.i18n.format(`${t?.scope||e}.importContent`,{defaultText:game.i18n.localize("dsk.importDefault")}),e,game.i18n.lang,t).render(!0)}};m(zs,"InitializerForm");var Os=class{constructor(e){let t=e.pages.find(s=>!0).text.content;this.document={name:e.name,data:$("<div>").html(t).text(),id:e.id}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}};m(Os,"JournalSearch");function Ha(){game.settings.register("dsk","migrationVersion",{name:"migrationVersion",scope:"world",config:!1,default:26,type:Number}),game.settings.register("dsk","firstTimeStart",{name:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","informationDistribution",{name:"dsk.SETTINGS.informationDistribution",hint:"dsk.SETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.SETTINGS.information0"),1:game.i18n.localize("dsk.SETTINGS.information1"),2:game.i18n.localize("dsk.SETTINGS.information2")}}),game.settings.register("dsk","journalFontSizeIndex",{name:"journalFontSizeIndex",hint:"journalFontSizeIndex",scope:"client",config:!1,default:5,type:Number}),game.settings.register("dsk","defaultConfigFinished",{name:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","limitCombatSpecAbs",{name:"dsk.SETTINGS.limitCombatSpecAbs",hint:"dsk.SETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","merchantNotification",{name:"dsk.SETTINGS.merchantNotification",hint:"dsk.SETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.no"),1:game.i18n.localize("dsk.yes"),2:game.i18n.localize("dsk.MERCHANT.onlyGM")}}),game.settings.register("dsk","expandChatModifierlist",{name:"dsk.SETTINGS.expandChatModifierlist",hint:"dsk.SETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","enableCombatFlow",{name:"dsk.SETTINGS.enableCombatFlow",hint:"dsk.SETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:o=>{game.dsk.apps.initTracker&&(game.dsk.apps.initTracker.close(),game.dsk.apps.initTracker=void 0)}}),game.settings.register("dsk","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","inventorySound",{name:"dsk.SETTINGS.inventorySound",hint:"dsk.SETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","scrollingFontsize",{name:"dsk.SETTINGS.scrollingFontsize",hint:"dsk.SETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsk","statusEffectCounterColor",{name:"dsk.SETTINGS.statusEffectCounterColor",hint:"dsk.SETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsk","playerCanEditSpellMacro",{name:"dsk.SETTINGS.playerCanEditSpellMacro",hint:"dsk.SETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsk",`breadcrumbs_${game.world.id}`,{name:"dsk.SETTINGS.breadcrumbs",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsk","soundConfig",{name:"dsk.SETTINGS.soundConfig",hint:"dsk.SETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:async()=>{J.loadSoundConfig()}}),game.settings.register("dsk","allowPhysicalDice",{name:"dsk.SETTINGS.allowPhysicalDice",hint:"dsk.SETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","enableItemDropToCanvas",{name:"dsk.SETTINGS.enableItemDropToCanvas",hint:"dsk.SETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","hideEffects",{name:"dsk.SETTINGS.hideEffects",hint:"dsk.SETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","hideOpposedDamage",{name:"dsk.SETTINGS.hideOpposedDamage",hint:"dsk.SETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","indexDescription",{name:"dsk.SETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsk","enableDPS",{name:"dsk.SETTINGS.enableDPS",hint:"dsk.SETTINGS.enableDPSHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","indexWorldItems",{name:"dsk.SETTINGS.indexWorldItems",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsk","tokenizerSetup",{name:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","forceLanguage",{name:"dsk.SETTINGS.forceLanguage",hint:"dsk.SETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German"}}),game.settings.register("dsk","enableCombatPan",{name:"dsk.SETTINGS.enableCombatPan",hint:"dsk.SETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","iniTrackerSize",{name:"dsk.SETTINGS.iniTrackerSize",hint:"dsk.SETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:async o=>{game.dsk.apps.tokenHotbar.constructor.defaultOptions.itemWidth=o}}),game.settings.register("dsk","iniTrackerPosition",{name:"iniTrackerPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsk","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.registerMenu("dsk","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("dsk.SETTINGS.changelog"),type:Ns,restricted:!1}),game.settings.register("dsk","disableDidYouKnow",{name:"dsk.SETTINGS.disableDidYouKnow",hint:"dsk.SETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","tokenhotbarSize",{name:"dsk.SETTINGS.tokenhotbarSize",hint:"dsk.SETTINGS.tokenhotbarSizeHint",scope:"client",config:!0,default:35,type:Number,range:{min:15,max:100,step:5},onChange:async o=>{game.dsk.apps.tokenHotbar.constructor.defaultOptions.itemWidth=o}}),game.settings.register("dsk","obfuscateTokenNames",{name:"dsk.SETTINGS.obfuscateTokenNames",hint:"dsk.SETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.no"),1:game.i18n.localize("dsk.SETTINGS.yesNumbered"),2:game.i18n.localize("dsk.SETTINGS.renameNumbered"),3:game.i18n.localize("dsk.yes"),4:game.i18n.localize("dsk.SETTINGS.rename")}}),game.settings.register("dsk","tokenhotbarLayout",{name:"dsk.SETTINGS.tokenhotbarLayout",hint:"dsk.SETTINGS.tokenhotbarLayoutHint",scope:"client",config:!0,default:0,type:Number,choices:{0:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout3")}})}m(Ha,"setupConfiguration");var Ns=class extends FormApplication{render(){lt()}};m(Ns,"ChangelogForm");var ea=class extends FormApplication{async render(){await game.settings.set("dsk","tokenhotbarPosition",{}),await game.settings.set("dsk","tokenhotbarLayout",0),await game.settings.set("dsk","tokenhotbarSize",35),game.dsk.apps.tokenHotbar.resetPosition(),game.dsk.apps.tokenHotbar.render(!0)}};m(ea,"ResetTokenbar");function Ga(){game.keybindings.register("dsk","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:()=>Ba("nextTurn")}),game.keybindings.register("dsk","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:()=>Ba("previousTurn")}),game.keybindings.register("dsk","attacktest",{name:"attacktest",hint:game.i18n.localize("dsk.KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:()=>le.runActAttackDialog()}),game.keybindings.register("dsk","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("dsk.KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:()=>h.renderToggle(game.dsk.apps.journalBrowser)}),game.keybindings.register("dsk","library",{name:"ItemLibrary",hint:game.i18n.localize("dsk.KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:()=>h.renderToggle(game.dsk.itemLibrary)})}m(Ga,"setupKeybindings");var Ba=m(o=>{game.combat?.combatant?.isOwner&&game.combat[o]()},"combatTurn");var{getProperty:Ui}=foundry.utils;function ja(){Hooks.on("preCreateScene",function(o,e,t,s){e.grid?.units||o.updateSource({grid:{units:game.i18n.localize("dsk.gridUnits")}}),!t.dskInit&&e.notes?.some(a=>Ui(a,"flags.dsk.initName"))&&ui.notifications.warn(game.i18n.localize("dsk.DSKError.mapsViaJournalbrowser"))}),Hooks.on("preCreateActiveEffect",function(o,e,t,s){if(o.parent.documentName!="Actor")return;let a={duration:{}};if(o.duration.startTime||(a.duration.startTime=game.time.worldTime),!game.combat){o.updateSource(a);return}a.duration.combat=game.combat.id,a.duration.startRound=game.combat.round,a.duration.startTurn=game.combat.turn,!o.duration.rounds&&o.duration.seconds&&(a.duration.rounds=o.duration.seconds/5),o.updateSource(a)})}m(ja,"setupScene");function qa(){Hooks.once("setup",()=>{if(Ha(),!["de"].includes(game.i18n.lang))console.warn(`DSK - ${game.i18n.lang} is not a supported language. Falling back to default language.`),Yi();else{let o=game.settings.get("dsk","forceLanguage");["de"].includes(o)&&game.i18n.lang!=o&&Vi(o)}Ga(),ja(),Ne.initHook(),CONFIG.Canvas.lightAnimations.daylight={label:"dsk.LIGHT.daylight",illuminationShader:ht},E.setupFunctions(),z.setupFunctions()})}m(qa,"initSetup");var Vi=m(o=>{let e={title:game.i18n.localize("dsk.SETTINGS.forceLanguage"),content:game.i18n.format("dsk.DSKError.wrongLanguage",{lang:o}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async()=>{await game.settings.set("core","language",o),foundry.utils.debouncedReload()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}};new Dialog(e).render(!0)},"showWrongLanguageDialog"),_s=class extends Dialog{async close(e={}){if(!!["de"].includes(game.i18n.lang))return super.close(e)}};m(_s,"ForbiddenLanguageDialog");var Yi=m(()=>{let o={title:game.i18n.localize("language"),content:"Your foundry language is not supported by this system. Due to technical reasons your foundry language setting has to be switched to german.",buttons:{de:{icon:'<i class="fa fa-check"></i>',label:"en",callback:async()=>{await game.settings.set("core","language","de"),foundry.utils.debouncedReload()}},logout:{icon:'<i class="fas fa-door-closed"></i>',label:game.i18n.localize("SETTINGS.Logout"),callback:async()=>{ui.menu.items.logout.onClick()}}}};new _s(o).render(!0)},"showForbiddenLanguageDialog"),Xe=class extends AdaptiveIlluminationShader{},ht=Xe;m(ht,"DaylightIlluminationShader"),O(ht,"fragmentShader",`
    ${Xe.SHADER_HEADER}
    ${Xe.PERCEIVED_BRIGHTNESS}

    void main() {
        ${Xe.FRAGMENT_BEGIN}
        ${Xe.TRANSITION}
       
        // Darkness
        framebufferColor = max(framebufferColor, colorBackground);        
        // Elevation
        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        
        // Final
        gl_FragColor = vec4(finalColor, 1.0);
      }`);var{getProperty:Wa}=foundry.utils;function Ka(){Hooks.on("renderSettings",(o,e,t)=>{let s=$(`<button id="reportADSKBug"><i class="fas fa-bug"></i> ${game.i18n.localize("dsk.DSKError.reportBug")}</button>`);s.click(()=>{window.open("https://github.com/Plushtoast/dsk-foundryVTT/issues","_blank")}),e.find("#settings-documentation").append(s),s=$('<button class="fshopButton"><div></div> F-Shop</button>'),s.click(()=>{window.open(game.i18n.localize("dsk.fshopLink"),"_blank")}),e.find("#settings-documentation").append(s);let a=game.system.title.split("/")[game.i18n.lang=="de"?0:1],i=e.find("#game-details .system .system-info").html();e.find("#game-details .system").html(`<span class="system-title">${a}</span><span class="system-info">${i}</span>`)}),Hooks.on("renderCompendiumDirectory",(o,e,t)=>{let s=$(`<button id="openLibrary"><i class="fas fa-university"></i>${game.i18n.localize("dsk.ItemLibrary")}</button>`);e.find(".header-actions").append(s),s.click(()=>{game.dsk.itemLibrary.render(!0)})}),Hooks.once("renderCompendiumDirectory",(o,e,t)=>{let s=game.i18n.lang=="de"?"en":"de",a=game.packs.filter(i=>Wa(i.metadata,"flags.dsklang")==s);for(let i of a){let n=`${i.metadata.packageName}.${i.metadata.name}`;game.packs.delete(n),game.data.packs=game.data.packs.filter(r=>r.id!=n),e.find(`li[data-pack="${n}"]`).remove()}}),Hooks.on("renderActorDirectory",(o,e,t)=>{if(!game.user.isGM)for(let s of o.documents.filter(a=>a.isMerchant()&&Wa(a,"system.merchant.hidePlayer")))e.find(`[data-document-id="${s.id}"]`).remove()})}m(Ka,"initSidebar");var{hasProperty:Ji,getProperty:Ps,mergeObject:Rs}=foundry.utils;function Ua(){Hooks.on("deleteActiveEffect",(i,n)=>{if(!h.isActiveGM()||n.noHook)return;let r=i.parent;if(r&&r.documentName=="Actor"){let l=[...i.statuses][0];if(l=="bloodrush")return r.addCondition("stunned",4,!1,!1),!1;if(l=="dead"&&game.combat)return r.markDead(!1),!1;if(Y.onEffectRemove(r,i),Hooks.call("deleteActorActiveEffect",r,i)===!1)return!1}}),Hooks.on("updateActor",(i,n)=>{!game.user.isGM&&i.limited&&Ji(n,"system.merchant.hidePlayer")&&ui.sidebar.render(!0)}),Hooks.on("dropActorSheetData",(i,n,r)=>{switch(r.data?.type){case"condition":return i.addCondition(r.data.payload.id,1,!1,!1),!1;case"lookup":return n._handleLookup(r.data),!1;case"fullpack":return n._addFullPack(r.data),!1}}),Hooks.on("createActiveEffect",(i,n,r)=>{!h.isActiveGM()||(o(i),e(i))}),Hooks.on("deleteActiveEffect",(i,n,r)=>{!h.isActiveGM()||o(i)}),Hooks.on("updateActiveEffect",(i,n,r)=>{!h.isActiveGM()||(o(i),t(i))});function o(i){if(!!game.user.isGM&&game.combat&&i.changes.some(n=>/(system\.stats\.ini|system\.characteristics.mu|system\.characteristics\.ge)/.test(n.key))){let n=i.parent.id,r=game.combat.combatants.find(l=>l.actor.id==n);r&&r.recalcInitiative()}}m(o,"checkIniChange");let e=m(async i=>{let n=i.parent;if(!n)return;await t(i,{},n);let r=[...i.statuses][0];r=="dead"&&game.combat?await n.markDead(!0):r=="unconscious"&&await n.addCondition("prone")},"createEffects"),t=m(async(i,n={},r)=>{if(r||(r=i.parent),!r||r.documentName!="Actor")return;let l=/^system\.condition\./;for(let c of i.changes||[])l.test(c.key)&&c.mode==2&&(n[c.key.split(".")[2]]=Number(c.value));for(let c of Object.keys(n))if(r.system.condition[c]>=8&&(c=="inpain"?await r.addCondition("incapacitated"):c=="stunned"?await r.addCondition("unconscious"):c=="feared"?await r.addCondition("panic"):c=="encumbered"&&await r.addCondition("fixated")),(Number(n.inpain)||0)>0&&!r.hasCondition("bloodrush")&&r.system.condition.inpain>0&&E.hasVantage(r,game.i18n.localize("dsk.LocalizedIDs.frenzy"))){await r.addCondition("bloodrush");let u=h.replaceConditions(`${game.i18n.format("dsk.CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+r.name+"</b>"})}`);ChatMessage.create(h.chatDataSetup(u))}},"countableDependentEffects"),s=m(async(i,n)=>{(game.dsk.apps.AskForNameDialog||Ls).getDialog(i,n)},"askForName"),a=m(async(i,n)=>{if(!h.isActiveGM())return;let r=i.actor;if(r.hasPlayerOwner)return;let l=Number(game.settings.get("dsk","obfuscateTokenNames"));if(l==0||Ps(r,"merchant.merchantType")=="loot")return;let c=canvas.scene.tokens.filter(d=>d.actor&&d.actor.id===r.id),u=game.i18n.localize("dsk.unknown");if([2,4].includes(l)){if(!(i.id||i._id))return;s(i,l);return}c.length>0&&l<3&&(u=`${c[0].name.replace(/ \d{1,}$/)} ${c.length+1}`),n.name=u},"obfuscateName");Hooks.on("preCreateToken",(i,n,r,l)=>{let c=i.actor;if(!c)return;let u={};Ps(c,"system.merchant.merchantType")=="loot"?Rs(u,{displayBars:0}):Ps(c,"system.config.autoBar")&&(Rs(u,{bar1:{attribute:"stats.LeP"}}),c.system.isMage?Rs(u,{bar2:{attribute:"stats.AeP"}}):Rs(u,{bar2:{attribute:"tbd"}})),Ps(c,"system.config.autoSize")&&h.calcTokenSize(c,u),a(i,u),i.updateSource(u)}),Hooks.on("createToken",(i,n,r)=>{n.noHook||a(i,{})})}m(Ua,"initActorHooks");var Ls=class extends Dialog{static async getDialog(e,t){new Dialog({title:game.i18n.localize("dsk.SETTINGS.obfuscateTokenNames"),content:`<label for="name">${game.i18n.localize("dsk.SETTINGS.rename")}</label> <input dtype="string" name="name" type="text" value="${e.actor.name}"/>`,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:async s=>{let a=e.id||e._id,i=s.find('[name="name"]').val();if(t==2){let r=canvas.scene.tokens.filter(l=>l.name===i);r.length>0&&(i=`${i.replace(/ \d{1,}$/)} ${r.length+1}`)}await canvas.scene.tokens.get(a).update({name:i})}},unknown:{icon:'<i class="fa fa-question"></i>',label:game.i18n.localize("dsk.unknown"),callback:async s=>{let a=e.id||e._id;await canvas.scene.tokens.get(a).update({name:game.i18n.localize("dsk.unknown")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}};m(Ls,"AskForNameDialog");var{mergeObject:Zi}=foundry.utils;function Va(){Hooks.once("init",()=>{game.dsk.apps.DiceSoNiceCustomization=new ye}),Hooks.once("diceSoNiceReady",(o,e,t,s)=>{o.addColorset({name:"mu",description:"DSK.mu",category:"DSK.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"kl",description:"DSK.kl",category:"DSK.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"in",description:"DSK.in",category:"DSK.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ch",description:"DSK.ch",category:"DSK.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ff",description:"DSK.ff",category:"DSK.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ge",description:"DSK.ge",category:"DSK.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ko",description:"DSK.ko",category:"DSK.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"kk",description:"DSK.kk",category:"DSK.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"attack",description:"DSK.attack",category:"DSK.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),game.dsk.apps.DiceSoNiceCustomization.initConfigs(),ye.onConnect()})}m(Va,"initDSN");var De=class extends Application{initConfigs(){let e={damage:"black"};game.settings.registerMenu("dsk","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("dsk.SETTINGS.dicesonicesettings"),type:Fs,restricted:!1});for(let t of De.attrs)game.settings.register("dsk",`dice3d_${t}`,{name:`CHAR.${t.toUpperCase()}`,scope:"client",config:!1,default:e[t]||t,type:String}),game.settings.register("dsk",`dice3d_system_${t}`,{name:`CHAR.${t.toUpperCase()}`,scope:"client",config:!1,default:"standard",type:String})}getAttributeConfiguration(e){return h.moduleEnabled("dice-so-nice")?{colorset:game.settings.get("dsk",`dice3d_${e}`),appearance:{colorset:game.settings.get("dsk",`dice3d_${e}`),system:game.settings.get("dsk",`dice3d_system_${e}`)}}:{colorset:e}}activateListeners(e){super.activateListeners(),e.find('[name="entryselection"]').change(async t=>{await game.settings.set("dsk",`dice3d_${t.currentTarget.dataset.attr}`,t.currentTarget.value)}),e.find('[name="systemselection"]').change(async t=>{await game.settings.set("dsk",`dice3d_system_${t.currentTarget.dataset.attr}`,t.currentTarget.value),De.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsk",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}})})}static onConnect(){game.socket.on("system.dsk",e=>{switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSK dice assets"),De.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":De.requestDicePreloads();break}}),this.collectPreloads(),game.socket.emit("system.dsk",{type:"getPreloadDice3d"})}static collectPreloads(e=!0){let t=new Set;for(let s of De.attrs)t.add(game.settings.get("dsk",`dice3d_system_${s}`));t=Array.from(t),e&&this.preloadDiceAssets(t),game.socket.emit("system.dsk",{type:"preloadDice3d",payload:t})}static requestDicePreloads(){this.collectPreloads(!1)}static async preloadDiceAssets(e,t=[]){console.warn("loading",e);for(let s of e){let a=game.dice3d.DiceFactory.systems[s];if(!a){this.unloadedModels.push(s);continue}let i=a.dice.filter(n=>t.length==0||t.includes(n.type));for(let n of i)try{n.modelFile?await n.loadModel(game.dice3d.DiceFactory.loaderGLTF):await n.loadTextures()}catch{console.warn("Unable to load dice model",s,n)}}this.unloadedModels.length&&this.retries<6&&!this.retrying&&(this.retrying=!0,setTimeout(()=>{this.retries+=1;let s=new Set(this.unloadedModels);this.unloadedModels=[],this.retrying=!1,this.preloadDiceAssets(s)},1e4))}async getData(e){let t=await super.getData(e);t.choices=game.dice3d.exports.Utils.prepareColorsetList(),delete t.choices.custom,t.systems=game.dice3d.exports.Utils.prepareSystemList(),t.selections={};for(let s of De.attrs)t.selections[s]={color:game.settings.get("dsk",`dice3d_${s}`),system:game.settings.get("dsk",`dice3d_system_${s}`)};return t}static get defaultOptions(){let e=super.defaultOptions;return Zi(e,{template:"systems/dsk/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("dsk.SETTINGS.dicesonicesettings"),width:600}),e}},ye=De;m(ye,"DiceSoNiceCustomization"),O(ye,"unloadedModels",[]),O(ye,"retries",0),O(ye,"retrying",!1),O(ye,"attrs",["mu","kl","in","ch","ff","ge","ko","kk","attack","damage"]);var Fs=class extends FormApplication{render(){game.dsk.apps.DiceSoNiceCustomization.render(!0)}};m(Fs,"DiceSoNiceForm");var{getProperty:Xi}=foundry.utils;function Ya(){Hooks.on("renderChatLog",(o,e,t)=>{_DiceDSK.chatListeners(e),_.chatListeners(e);let s=new q;Hooks.call("startDSKChatAutoCompletion",s),s.chatListeners(e),H.chatListeners(e)}),Hooks.on("renderChatMessage",(o,e,t)=>{if(game.user.isGM)e.find(".chat-button-player").remove();else{e.find(".chat-button-gm").remove();let s,a=e.find(".chat-button-target");a.length&&(s=Ce.getTargetActor(t.message),s&&s.actor&&!s.actor.isOwner&&a.remove());let i=h.getSpeaker(t.message.speaker);i&&!i.isOwner&&(e.find(".selfButton").remove(),e.find(".d20").data("tooltip",""));let n=e.find(".onlyTarget");n.length&&(s=h.getSpeaker({token:n.attr("data-token"),actor:n.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}),s&&!s.isOwner&&n.remove()),e.find(".hideData").remove(),Xi(t.message,`flags.dsk.userHidden.${game.user.id}`)&&e.find(".payButton").remove()}game.settings.get("dsk","expandChatModifierlist")&&(e.find(".expand-mods i").toggleClass("fa-minus fa-plus"),e.find(".expand-mods + ul").css({display:"block"})),x.bindButtons(e)}),Hooks.on("chatMessage",(o,e,t)=>{let s=e.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(s=s?s[0]:"",s){case"/pay":return game.user.isGM?_.createPayChatMessage(e):_.payMoney(h.getSpeaker(t.speaker),e),!1;case"/getPaid":return game.user.isGM?_.createGetPaidChatMessage(e):_.getMoney(h.getSpeaker(t.speaker),e),!1;case"/help":return H.getHelp(),!1;case"/conditions":return H.showConditions(),!1;case"/tables":return H.showTables(),!1}})}m(Ya,"initChatlogHooks");var{getProperty:ta}=foundry.utils;function Ja(){Token.prototype.drawEffects=async function(){this.effects.renderable=!1,this.effects.removeChildren().forEach(i=>i.destroy()),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null;let t=!1,s=this.actor?await this.actor.actorEffects():[],a=[];for(let i of s)!i.img||(i.getFlag("core","overlay")&&!t?(a.push(this._drawOverlay(i.img,i.tint)),t=!0):a.push(this._drawEffect(i.img,i.tint,ta(i,"flags.dsk.value"))));await Promise.allSettled(a),this.effects.renderable=!0,this.renderFlags.set({refreshEffects:!0})},Token.prototype._refreshEffects=function(){let t=0,s=Math.round(canvas.dimensions.size/10)*2,a=Math.floor(this.document.height*5),i=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(let n of this.effects.children)if(n!==i&&!n.isCounter)if(n===this.effects.overlay){let{width:r,height:l}=this.getSize(),c=Math.min(r*.6,l*.6);n.width=n.height=c,n.position=this.getCenterPoint({x:0,y:0}),n.anchor.set(.5,.5)}else{if(n.width=n.height=s,n.x=Math.floor(t/a)*s,n.y=t%a*s,i.drawRoundedRect(n.x+1,n.y+1,s-2,s-2,2),n.counter>1&&!n.counterDrawn){let r=game.dsk.config.effectTextStyle,l=game.settings.get("dsk","statusEffectCounterColor");r._fill=/^#[0-9A-F]+$/.test(l)?l:"#000000";let c=this.effects.addChild(new PreciseText(n.counter,r));c.x=n.x,c.y=n.y,c.isCounter=!0,n.counterDrawn=!0}t++}},Token.prototype._drawEffect=async function(t,s,a){if(!t)return;let i=await loadTexture(t,{fallback:"icons/svg/hazard.svg"}),n=new PIXI.Sprite(i);return n.tint=s??16777215,n.counter=a,this.effects.addChild(n)},TokenHUD.prototype._onToggleEffect=function(t,{overlay:s=!1}={}){t.preventDefault();let a=t.currentTarget,i=a.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find(n=>n.id===a.dataset.statusId):a.getAttribute("src");if(t.button==0)return this.object.incrementCondition(i);if(t.button==2)return this.object.decrementCondition(i)},Token.prototype.incrementCondition=async function(t,{active:s,overlay:a=!1}={}){let i=this.actor.effects.find(n=>n.statuses.has(t.id));return!i||Number.isNumeric(ta(i,"flags.dsk.value"))?await this.actor.addCondition(t.id,1,!1,!1):i&&await this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),s},Token.prototype.decrementCondition=async function(t,{active:s,overlay:a=!1}={}){return this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),s};let o=Token.prototype._onClickLeft2,e=m(t=>t?["merchant","loot"].includes(ta(t.system,"merchant.merchantType")):!1,"isMerchant");Token.prototype._onClickLeft2=function(t){if(!(game.user.isGM||!game.settings.get("dsk","enableDPS")||!e(this.actor)||X.inDistance(this)))return ui.notifications.warn(game.i18n.localize("dsk.DSKError.notInRangeToLoot"));o.call(this,t)}}m(Ja,"initTokenHook");function Za(){Hooks.on("renderTokenHUD",(o,e,t)=>{let s=o.object.actor;s&&game.dsk.apps.LightDialog&&game.dsk.apps.LightDialog.lightHud(e,s,t),e.find('.control-icon[data-action="target"]').mousedown(a=>{a.button==2&&(game.user.updateTokenTargets([]),$(a.currentTarget).click(),a.preventDefault())}),e.find(".attribute input").off("change")})}m(Za,"initTokenHUD");function Xa(){Roll.prototype.editRollAtIndex=function(o){let e=[];for(let t of o){let{index:s,val:a}=t,i=0;for(let n of this.terms){let r=n instanceof foundry.dice.terms.DiceTerm||n.class=="DiceTerm"||n instanceof foundry.dice.terms.Die||n.class=="Die",l=n instanceof foundry.dice.terms.OperatorTerm;if(r||n.faces){if(n.results[s-i]){let c=n.results[s-i].result;n.results[s-i].result=a,e.push(c)}r||(n.total=n.results.reduce((c,u)=>c+u.result,0)),i+=n.results.length}else!l&&(n.class=="OperatorTerm"||n.operator)&&(n.total=n.operator)}e.push(0)}return this._total=this._evaluateTotal(),e}}m(Xa,"initRollsFunction");var Qe=class extends Je(me){static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/creature-merchant-sheet.html"}};m(Qe,"CreatureMerchantSheetDSK");var et=class extends Je(oe){static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/character-merchant-sheet.html"}};m(et,"CharacterMerchantSheetDSK");var{getProperty:yt}=foundry.utils;function Qa(){let o=m((g,y)=>h.fateAvailable(g,y),"fateAvailable"),e=m(function(g){let y=game.messages.get(g.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&g.find(".opposed-card").length||g.find(".dice-roll").length)&&(yt(y,"damage.value")||0)>0},"canHurt"),t=m(function(g){let y=game.messages.get(g.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&g.find(".opposed-card").length||g.find(".dice-roll").length)&&(yt(y,"damage.sp")||0)>0},"canHurtSP"),s=m(function(g){let y=game.messages.get(g.attr("data-message-id"));return y.speaker.actor&&y.flags.data&&(game.actors.get(y.speaker.actor).isOwner||game.user.isGM)?["ahnengabe"].includes(y.flags.data.preData.source.type)||yt(y.flags.data.preData,"calculatedSpellModifiers.costsMana"):!1},"canCostMana"),a=m(function(g){if(game.user.isGM&&game.settings.get("dsk","hideOpposedDamage")){let y=game.messages.get(g.attr("data-message-id"));return"hideData"in y.flags&&y.flags.hideData}return!1},"canUnhideData"),i=m(function(g){if(game.user.isGM&&game.settings.get("dsk","hideOpposedDamage")){let y=game.messages.get(g.attr("data-message-id"));return"hideData"in y.flags&&!y.flags.hideData}return!1},"canHideData"),n=m(function(g){let y=game.messages.get(g.attr("data-message-id"));if(y.speaker.actor&&y.flags.data){let v=game.actors.get(y.speaker.actor);if(v.isOwner)return v.items.find(k=>k.name==`${game.i18n.localize("dsk.LocalizedIDs.aptitude")} (${y.flags.data.preData.source.name})`)!=null&&!y.flags.data.talentedRerollUsed}return!1},"isTalented"),r=m(function(g,y=!1){let v=game.messages.get(g.attr("data-message-id"));if(v.speaker.actor&&v.flags.data){let k=game.actors.get(v.speaker.actor);if(k.isOwner&&o(k,y))return v.flags.data.postData.damageRoll!=null&&!v.flags.data.fatePointDamageRerollUsed}return!1},"canRerollDamage"),l=m(function(g,y=!1){let v=game.messages.get(g.attr("data-message-id"));if(v.speaker.actor&&v.flags.data){let k=game.actors.get(v.speaker.actor);if(k.isOwner&&o(k,y))return!v.flags.data.fatePointRerollUsed&&v.flags.data.postData.rollType!="regenerate"}return!1},"canReroll"),c=m(function(g){let y=game.messages.get(g.attr("data-message-id"));return y.speaker.actor&&y.flags.data&&game.actors.get(y.speaker.actor).isOwner&&["LeP","AeP"].some(k=>yt(y.flags,`data.postData.${k}`)!=null)?!y.flags.data.healApplied:!1},"canHeal"),u=m(function(g){if(game.user.isGM){let y=game.messages.get(g.attr("data-message-id"));if("hideData"in y.flags){let v=!y.flags.hideData,k=$(y.content);k.find(".hideAnchor")[v?"addClass":"removeClass"]("hideData"),k=$("<div></div>").append(k),y.update({content:k.html(),"flags.hideData":v})}}},"showHideData"),d=m(g=>{let y=game.messages.get(g.data("messageId"));return!y||!canvas.tokens?!1:y.isRoll&&y.isContentVisible&&canvas.tokens.controlled.length&&g.find(".dice-roll").length},"canApplyDefaultRolls"),f=m((g,y,v=0)=>{let k=game.messages.get(g.attr("data-message-id"));game.actors.get(k.speaker.actor).useFateOnRoll(k,y,v)},"useFate"),p=m(async(g,y)=>{let v=game.messages.get(g.attr("data-message-id")),k=v.flags.opposeData,I=k.speakerDefend.speaker,B=h.getSpeaker(I);if(!B.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));await B.applyDamage(k.damage[y]),await v.update({"flags.data.damageApplied":!0,content:v.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${game.i18n.localize("damageApplied")}"></i>`)})},"applyDamage"),b=m((g,y)=>{let k=game.messages.get(g.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map(I=>{let B=I.actor,S=y!="sp"?k.total-D.armorValue(B).armor:k.total;return B.applyDamage(Math.max(0,S))}))},"applyChatCardDamage"),T=m(async g=>{let y=game.messages.get(g.attr("data-message-id")),v=y.flags.data,k=h.getSpeaker(y.speaker);if(!k.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));let I=["ritual","spell"].includes(v.preData.source.type)||yt(v.preData.calculatedSpellModifiers,"costsMana")?"AeP":"KaP",B=await k.applyMana(v.preData.calculatedSpellModifiers.finalcost,I);await y.update({"flags.data.manaApplied":!0,content:y.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')})},"payMana");Hooks.on("getChatLogEntryContext",(g,y)=>{y.push({name:game.i18n.localize("dsk.CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:i,callback:v=>{u(v)}},{name:game.i18n.localize("dsk.CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:a,callback:v=>{u(v)}},{name:game.i18n.localize("dsk.regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:c,callback:async v=>{let k=await game.messages.get(v.attr("data-message-id")),I=h.getSpeaker(k.speaker);if(!I.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));await k.update({"flags.data.healApplied":!0,content:k.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')}),await I.applyRegeneration(k.flags.data.postData.LeP,k.flags.data.postData.AeP,k.flags.data.postData.KaP)}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:s,callback:async v=>{T(v)}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:v=>{p(v,"value")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:v=>{p(v,"sp")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:d,callback:v=>{b(v,"value")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:d,callback:v=>{b(v,"sp")}},{name:game.i18n.localize("dsk.CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:l,callback:v=>{f(v,"reroll")}},{name:game.i18n.localize("dsk.CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:n,callback:v=>{f(v,"isTalented")}},{name:game.i18n.localize("dsk.CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:r,callback:v=>{f(v,"rerollDamage")}})})}m(Qa,"initChatContext");var Hs=class extends ControlIcon{async draw(){return this.bg.clear(),await super.draw()}};m(Hs,"TransparentControlIcon");var ei=m(()=>{Note.prototype._drawControlIcon=function(){let o=this.document.getFlag("dsk","noBG"),e=Color.from(this.document.texture.tint||null),t={texture:this.document.texture.src,size:this.document.iconSize,tint:e},s=o?new Hs(t):new ControlIcon(t);return s.x-=this.document.iconSize/2,s.y-=this.document.iconSize/2,s}},"initHook");function ti(){let o=ActorDelta._onUpdateOperation;ActorDelta._onUpdateOperation=async(t,s,a)=>{for(let i of t)await D.postUpdateConditions(i.syntheticActor);return o(t,s,a)};let e=ActorDelta._onCreateOperation;ActorDelta._onCreateOperation=async(t,s,a)=>{for(let i of t)await D.postUpdateConditions(i.syntheticActor);return e(t,s,a)}}m(ti,"setActorDelta");function si(){xa(),Ea(),Na(),Ka(),Ua(),Va(),Ya(),Ja(),Za(),Xa(),js(),Qa(),ti(),Hooks.once("init",()=>{loadTemplates(["systems/dsk/templates/items/item-equipment.html","systems/dsk/templates/items/item-header.html","systems/dsk/templates/items/item-description.html","systems/dsk/templates/items/item-effects.html","systems/dsk/templates/items/item-stat.html","systems/dsk/templates/actors/parts/healthbar.html","systems/dsk/templates/actors/actor-talents.html","systems/dsk/templates/actors/actor-combat.html","systems/dsk/templates/actors/actor-equipment.html","systems/dsk/templates/actors/parts/gearSearch.html","systems/dsk/templates/actors/parts/purse.html","systems/dsk/templates/actors/parts/characteristics-small.html","systems/dsk/templates/actors/parts/status_effects.html","systems/dsk/templates/actors/parts/containerContent.html","systems/dsk/templates/actors/actor-notes.html","systems/dsk/templates/actors/creature/creature-combat.html","systems/dsk/templates/actors/creature/creature-main.html","systems/dsk/templates/actors/creature/creature-magic.html","systems/dsk/templates/status/advanced_functions.html","systems/dsk/templates/actors/creature/creature-loot.html","systems/dsk/templates/dialog/default-dialog.html","systems/dsk/templates/actors/character/actor-magic.html","systems/dsk/templates/actors/parts/characteristics-large.html","systems/dsk/templates/actors/npc/npc-main.html","systems/dsk/templates/actors/parts/rollhead.html","systems/dsk/templates/actors/actor-main.html","systems/dsk/templates/chat/roll/test-card.html","systems/dsk/templates/dialog/parts/targets.html","systems/dsk/templates/dialog/default-combat-dialog.html","systems/dsk/templates/actors/creature/creature-notes.html","systems/dsk/templates/dialog/enhanced-default-dialog.html","systems/dsk/templates/actors/parts/information.html","systems/dsk/templates/actors/merchant/merchant-commerce.html","systems/dsk/templates/actors/parts/normalhead.html"])}),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsk",oe,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsk",me,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsk",ue,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsk",he,{types:["npc"]}),Actors.registerSheet("dsk",Qe,{types:["creature"]}),Actors.registerSheet("dsk",et,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsk",Y,{makeDefault:!0}),Journal.registerSheet("dsk",We,{makeDefault:!0}),L.setupSheets(),La(),qa(),ei(),X.initDoorMinDistance()}m(si,"initHooks");var{mergeObject:Qi}=foundry.utils,ai={};Hooks.once("ready",()=>{Promise.all([h.allSkillsList()]).then(o=>{let e=o[0].skills.reduce((i,n)=>({...i,[n]:n}),{}),t=o[0].rangeSkills.reduce((i,n)=>({...i,[n]:n}),{}),s=o[0].meleeSkills.reduce((i,n)=>({...i,[n]:n}),{}),a=o[0].rangeSkills.concat(o[0].meleeSkills).reduce((i,n)=>({...i,[n]:n}),{});Qi(ai,{ammunition:[{label:"dsk.ammunitionType",attr:"ammunitionType",type:"select",options:w.ammunitiongroups}],equipment:[{label:"dsk.category",attr:"category",type:"select",options:w.equipmentTypes}],rangeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill",type:"select",options:t},{label:"dsk.ammunitionType",attr:"ammunitionType",type:"select",options:w.ammunitiongroups}],meleeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill",type:"select",options:s},{label:"dsk.range",attr:"rw",type:"select",options:w.meleeRanges}],poison:[{label:"dsk.resistanceModifier",attr:"resist",type:"select",options:w.magicResistanceModifiers}],trait:[],profession:[],specialability:[{label:"dsk.category",attr:"category",type:"select",options:w.specialAbilityCategories},{label:"TYPES.Item.combatskill",attr:"subcategory",type:"select",options:a,notStrict:!0}],ahnengabe:[{label:"dsk.resistanceModifier",attr:"resist",type:"select",options:w.magicResistanceModifiers},{label:"dsk.targetCategory",attr:"targetCategory",type:"text"},{label:"dsk.distribution",attr:"distribution",type:"text"}],ahnengeschenk:[],npc:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"TYPES.Item.profession",attr:"details.profession",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture",type:"text"}],character:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"TYPES.Item.profession",attr:"details.profession",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture",type:"text"}],creature:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"dsk.sizeCategory",attr:"details.size",type:"select",options:w.sizeCategories}],armor:[{label:"dsk.protection",attr:"rs",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}}]})})});var Bs=ai;var{getProperty:sa,debounce:en}=foundry.utils,tt=class{constructor(e,t={}){let s=e.documentName||e.type;switch(e.documentName){case"Actor":case"Item":s=e.type;break}let a="";if(game.settings.get("dsk","indexDescription"))switch(s){case"creature":case"npc":case"character":a=sa(e,"system.description.value");break;case"JournalEntry":a=sa(e,"system.content");break;default:a=sa(e,"description.value")}this.document={name:e.name,filterType:s,data:$("<div>").html(a).text(),id:e.id||e._id,visible:e.visible?e.visible:!0,compendium:e.compendium?e.compendium.metadata.packageName:t.packageName||"",pack:e.pack||(t.packageName?t.id:void 0),img:e.img}}get uuid(){if(this.document.compendium)return`Compendium.${this.document.pack}.${this.document.id}`;switch(this.itemType){case"character":case"creature":case"npc":return`Actor.${this.id}`;case"JournalEntry":return`JournalEntry.${this.id}`;default:return`Item.${this.id}`}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}get itemType(){return this.document.filterType}async getItem(){return await fromUuid(this.uuid)}hasPermission(){return this.document.visible}async render(){(await this.getItem()).sheet.render(!0)}get compendium(){return this.document.compendium}get img(){return this.itemType=="JournalEntry"?"systems/dsk/icons/categories/DSK-Auge.webp":this.document.img}};m(tt,"SearchDocument");var kt=class extends tt{constructor(e,t){super(e);let s=Bs[t]||[];for(let a of s)this[a.attr]=a.attr.split(".").reduce((i,n)=>i[n]===void 0?{}:i[n],e.system)}};m(kt,"AdvancedSearchDocument");var st=class extends Application{constructor(e){super(e),this.advancedFiltering=!1,this.journalBuild=!1,this.journalWorldBuild=!1,this.equipmentBuild=!1,this.equipmentWorldBuild,this.zooBuild=!1,this.zooWorldBuild=!1,this.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),this.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.detailFilter={},this.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},this.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1},filterBy:{search:""}},character:{categories:{profession:!1,advantage:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1},filterBy:{search:""}},spell:{categories:{ahnengabe:!1,ahnengeschenk:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}}}async getData(e){let t=await super.getData(e);return t.categories=this.translateFilters(),t.isGM=game.user.isGM,t.items=this.items,t.advancedMode=this.advancedFiltering?"on":"",t.worldIndexed=game.settings.get("dsk","indexWorldItems")?"on":"",t.fullTextEnabled=game.settings.get("dsk","indexDescription")?"on":"",this.advancedFiltering&&(t.advancedFilter=await this.buildDetailFilter("tbd",this.subcategory)),t}translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo),journal:this.buildFilter(this.filters.journal)}}purgeAdvancedFilters(){for(let e in this.filters)for(let t in this.filters[e].categories)this.filters[e].categories[t]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then(e=>{$(this._element).find(".advancedSearch .groupbox").html(e)})}buildFilter(e){let t=[];return Object.keys(e.categories).forEach(function(s){t.push({label:game.i18n.localize(`TYPES.Item.${s}`),selected:e.categories[s],key:s})}),t=t.sort(function(s,a){return s.label.localeCompare(a.label)}),t}static get defaultOptions(){let e=super.defaultOptions;return e.id="DSKItemLibrary",e.classes.push("dsk","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("dsk.ItemLibrary"),e.template="systems/dsk/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}async getRandomItems(e,t){let s=[],a=this.equipmentIndex;return s.push(...await a.search(e,{field:["itemType"]})),(await Promise.all(this.shuffle(s.filter(i=>i.hasPermission)).slice(0,t+5).map(i=>i.getItem()))).filter(i=>{let n=i.getFlag("dsk","enchantments");return!n||!n.find(r=>r.talisman)}).slice(0,t)}shuffle(e){let t=e.length,s,a;for(;t!==0;)a=Math.floor(Math.random()*t),t-=1,s=e[t],e[t]=e[a],e[a]=s;return e}async findCompendiumItem(e,t,s=!0){this.equipmentBuild||await this.buildEquipmentIndex();let a={field:["name"],where:{itemType:t}},i=await this.equipmentIndex.search(e,a);return s&&(i=i.filter(n=>n.compendium!="")),await Promise.all(i.map(n=>n.getItem()))}async getCategoryItems(e,t=!1){return await this.buildEquipmentIndex(),t?(await Promise.all(this.equipmentIndex.search(e,{field:["itemType"]}).map(s=>s.getItem()))).map(s=>s.toObject()):this.equipmentIndex.search(e,{field:["itemType"]})}async executeAdvancedFilter(e,t,s,a,i,n=[]){let r=m(p=>{for(let b of s)if(b[2]?p[b[0]]!=b[1]:p[b[0]].indexOf(b[1])==-1)return!1;return!0},"selFnct"),l=m(p=>{for(let b of a)if(p[b[0]].toLowerCase().indexOf(b[1])==-1)return!1;return!0},"txtFnct"),c=m(p=>{for(let b of i)if(p[b[0]]!=b[1])return!1;return!0},"cbFnct"),u=m(p=>{for(let b of n)if(p[b[0]]<b[1]||p[b[0]]>b[2])return!1;return!0},"rangeFct"),f=t.where(p=>(e==""||p.name.toLowerCase().indexOf(e)!=-1)&&r(p)&&l(p)&&c(p)&&u(p));return f=f.filter(p=>p.hasPermission).sort((p,b)=>p.name.toLowerCase()>b.name.toLowerCase()?1:-1),f}async advancedFilterStuff(e,t){let s=$(this._element).find(".detailFilters"),a=s.attr("data-subc"),i=this.filters[e].filterBy.search.toLowerCase(),n=this.detailFilter[a],r=[],l=[],c=[];for(let d of s.find("select")){let f=$(d).val();f!=""&&r.push([$(d).attr("name"),f,d.dataset.notstrict!="true"])}for(let d of s.find('input[type="text"]:not(.manualFilter)')){let f=$(d).val();f!=""&&l.push([$(d).attr("name"),f.toLowerCase()])}for(let d of s.find('input[type="checkbox"]:checked:not(.manualFilter)')){let f=$(d).val();f!=""&&c.push([$(d).attr("name"),f.toLowerCase()])}let u=await this.executeAdvancedFilter(i,n,r,l,c);return this.setBGImage(u,e),u}async filterStuff(e,t,s){let a=this.filters[e].filterBy.search,i={field:["name","data"]},n=[],r=!1;for(let l in this.filters[e].categories){if(this.filters[e].categories[l]){let c,u=null;a==""?c=t.search(l,{field:["itemType"],sort:"name",where:{itemType:l}}):c=t.search(a,{...i,sort:"name",where:{itemType:l}});let d=Number(s)||0;c=c.slice(d,Math.min(d+60,c.length)),c.length==60&&(u=`${d+60}`),this.pages[e].next=u,n.push(...c)}r=this.filters[e].categories[l]||r}return r||(n=t.search(a,{...i,limit:60,page:s||!0,sort:"name"}),this.pages[e].next=n.next),n=n.result?n.result:n,n=n.filter(l=>l.hasPermission),this.setBGImage(n,e),n}setBGImage(e,t){$(this._element).find(`.${t} .libcontainer`)[`${e.length>0?"remove":"add"}Class`]("libraryImg")}renderResult(e,t,{index:s,itemType:a},i){let n=e.find(".searchResult .item-list");renderTemplate("systems/dsk/templates/system/libraryItem.html",{items:t}).then(r=>{i||n.empty(),r=$(r),r.each(function(){let l=$(this);l.attr("draggable",!0).on("dragstart",c=>{let u=s.find($(l).attr("data-item-id"));c.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:a,uuid:u.uuid}))})}),n.append(r)})}async filterItems(e,t,s){let a=this.selectIndex(t);if(this.advancedFiltering&&t!="journal"){let i=await this.advancedFilterStuff(t,s);return this.renderResult(e,i,a,s),i}else{let i=await this.filterStuff(t,a.index,s);return this.renderResult(e,i,a,s),i}}selectIndex(e){let t="Item",s=this.equipmentIndex;switch(e){case"zoo":t="Actor",s=this.zooIndex;break;case"journal":t="JournalEntry",s=this.journalIndex;break}return{index:s,itemType:t}}async _render(e=!1,t={}){await super._render(e,t),this.buildEquipmentIndex()}async buildEquipmentIndex(){await this._createIndex("equipment","Item",game.items)}async _createIndex(e,t,s){if(this[`${e}Build`])return;SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:""}),pct:0});let a=$(this._element).find(`*[data-tab="${e}"]`);this.showLoading(a,e);let i=game.packs.filter(f=>f.documentName==t&&(game.user.isGM||f.visible)),n=100/(i.length+1),r=n,l=["name","system.type","system.description.value","img"],c;t=="Actor"?c=m(f=>f.getIndex({actorFields:l}),"func"):t=="JournalEntry"?c=m(f=>f.getDocuments(),"func"):c=m(f=>f.getDocuments({type__in:Object.keys(game.system.documentTypes.Item)}),"func");let u=this.indexWorldItems(s,e);SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:"world items"}),pct:Math.round(n)});let d=i.map(async f=>{let p=await c(f);r+=n,SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:`${f.metadata.label} (${f.metadata.id})`}),pct:Math.round(r)}),u.push(...p.map(b=>new tt(b,f.metadata)))});return Promise.all(d).then(f=>{this[`${e}Index`].add(u),this[`${e}Build`]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:""}),pct:100}),this.hideLoading(a,e)})}subcategoryFields(e){let t=["name","itemType"],s=Bs[e]||[];for(let a of s)t.push(a.attr);return t}indexWorldItems(e,t){let s=[];return game.settings.get("dsk","indexWorldItems")&&(s.push(...e.filter(a=>a.visible).map(a=>new tt(a))),this[`${t}WorldBuild`]=!0),s}async createDetailIndex(e,t){if(!this.detailFilter[t]){let s=this.subcategoryFields(t),a=$(this._element).find(`*[data-tab="${e}"]`);a.find(".searchResult ul").html(""),this.showLoading(a,e),this.detailFilter[t]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:s}});let{index:i,itemType:n}=this.selectIndex(e),l=(n=="Item"?game.items:game.actors).filter(p=>p.visible&&p.type==t).map(p=>new kt(p,t)),c=i.search(t,{field:["itemType"]}),u={};for(let p of c)!p.document.pack||(u[p.document.pack]||(u[p.document.pack]=[]),u[p.document.pack].push(p.document.id));let d=[];for(let p of Object.entries(u))d.push(game.packs.get(p[0]).getDocuments({_id__in:p[1],type:t}));let f=await Promise.all(d);for(let p of f)l.push(...p.map(b=>new kt(b,t)));this.detailFilter[t].add(l),this.hideLoading(a,e)}}async buildDetailFilter(e,t){let s=Bs[t]||[];if(s){let a=this.createDetailIndex(e,t),i=await renderTemplate("systems/dsk/templates/system/detailFilter.html",{fields:s,subcategory:t});return await a,i}else return`<p>${game.i18n.localize("dsk.Library.selectAdvanced")}</p>`}checkWorldStuffIndex(){game.settings.get("dsk","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}activateListeners(e){super.activateListeners(e),e.on("click",".toggleAdvancedMode",()=>{this.advancedFiltering=!this.advancedFiltering,this.advancedFiltering?($(this._element).find(".toggleAdvancedMode").addClass("on"),$(this._element).find(".advancedSearch").fadeIn(),this.purgeAdvancedFilters()):($(this._element).find(".toggleAdvancedMode").removeClass("on"),$(this._element).find(".advancedSearch").fadeOut())}),e.on("change",".detailFilters input, .detailFilters select",()=>{let s=$(this._element).find(".tab.active"),a=s.attr("data-tab");this.filterItems(s,a)}),e.on("click",".filter",async s=>{let a=$(s.currentTarget).closest(".tab"),i=a.attr("data-tab"),n=$(s.currentTarget).attr("data-category"),r=$(s.currentTarget).is(":checked");this.advancedFiltering&&r&&(this.purgeAdvancedFilters(),this.subcategory=n,$(s.currentTarget).prop("checked",r),$(this._element).find(".advancedSearch .groupbox").html(await this.buildDetailFilter(i,n))),this.filters[i].categories[n]=r,this.filterItems(a,i)}),e.on("click",".item-name",s=>{this.getItemFromHTML(s).render()}),e.on("mousedown",".item-name",s=>{s.button==2&&h.showArtwork(this.getItemFromHTML(s))}),e.on("keyup",".filterBy-search",s=>{let a=$(s.currentTarget).closest(".tab"),i=a.attr("data-tab");this.filters[i].filterBy.search=$(s.currentTarget).val(),this.filterItems(a,i)}),e.find('*[data-tab="journal"]').click(s=>{this._createIndex("journal","JournalEntry",game.journal)}),e.find('*[data-tab="zoo"]').click(s=>{this._createIndex("zoo","Actor",game.actors)}),e.find(".showDetails").click(s=>{let a=$(s.currentTarget).attr("data-btn");$(s.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),e.find(`.${a} .detailBox`).toggleClass("dskhidden")}),e.find(".toggleWorldIndex").click(s=>{game.settings.set("dsk","indexWorldItems",!game.settings.get("dsk","indexWorldItems")),this.checkWorldStuffIndex(),$(s.currentTarget).toggleClass("on")}),e.find(".fulltextsearch").click(s=>{game.settings.set("dsk","indexDescription",!game.settings.get("dsk","indexDescription")),$(s.currentTarget).toggleClass("on")});let t=this;$(this._element).find(".window-content").on("scroll.infinit",en(function(s){if(t.advancedFiltering)return;let a=$(s.target),i=a.scrollTop()+a.innerHeight()>=a[0].scrollHeight-100,n=e.find(".tabs .item.active").attr("data-tab");if(i&&t.pages[n].next){let r=e.find(".tab.active");t.filterItems.call(t,r,n,t.pages[n].next)}},100))}getItemFromHTML(e){let t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}showLoading(e,t){this.setBGImage([1],t),$(`<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>${game.i18n.localize("dsk.Library.buildingIndex")}</div>`).appendTo(e.find(".searchResult"))}hideLoading(e,t){this.setBGImage([],t),e.find(".loader").remove()}};m(st,"DSKItemLibrary");var{getProperty:ii,setProperty:aa,getType:tn}=foundry.utils,Gs=class extends ActiveEffect{apply(e,t){if(Gs.itemChangeRegex.test(t.key)){let s=this._getModifiedItems(e,t);for(let a of s.items){let i=foundry.utils.flattenObject(a.overrides||{});i[s.key]=Number.isNumeric(a.value)?Number(s.value):s.value;let n={...t,key:s.key,value:s.value};super.apply(a,n),a.overrides=foundry.utils.expandObject(i)}}else return super.apply(e,t)}_getModifiedItems(e,t){let s=t.key.split("."),a=s.shift();a=a.replace("@","").toLowerCase();let i=s.shift(),n=s.join("."),r=t.value;return{items:e?.items?.filter(c=>c.type==a&&(c.name==i||c.id==i))||[],key:n,value:r}}static async _onCreateOperation(e,t,s){for(let a of e)a.parent.documentName=="Actor"&&await D.postUpdateConditions(a.parent);return super._onCreateOperation(e,t,s)}static async _onUpdateOperation(e,t,s){for(let a of e)a.parent.documentName=="Actor"&&await D.postUpdateConditions(a.parent);return super._onUpdateOperation(e,t,s)}static async _onDeleteOperation(e,t,s){for(let a of e)a.parent.documentName=="Actor"&&await D.postUpdateConditions(a.parent);return super._onDeleteOperation(e,t,s)}async _preUpdate(e,t,s){await super._preUpdate(e,t,s),this._clearModifiedItems()}_clearModifiedItems(){if(this.parent instanceof CONFIG.Actor.documentClass){for(let e of this.changes)if(Gs.itemChangeRegex.test(e.key)){let t=this._getModifiedItems(this.parent,e);for(let s of t.items){let a=foundry.utils.flattenObject(s.overrides||{}),i=t.key;delete a[i];let n=ii(s._source,i);aa(s,i,n),s.overrides=foundry.utils.expandObject(a),s.sheet?.rendered&&s.sheet.render(!0)}}}}async _preDelete(e,t){super._preDelete(e,t),this._clearModifiedItems()}},Ie=Gs;m(Ie,"DSKActiveEffect"),O(Ie,"itemChangeRegex",/^@/);var sn=m((o,e)=>{let t=ii(o,e.key)||null;t==null&&/^system\.(vulnerabilities|resistances)/.test(e.key)&&(t=[],aa(o,e.key,t));let s=tn(t),a=null;switch(s){case"Array":let i=[],n=e.effect.name;for(let r of`${e.value}`.split(/[;,]+/)){let l=r.split(" "),c=l.pop(),u=l.join(" ");i.push({source:n,value:c,target:u})}a=t.concat(i)}return a!==null&&aa(o,e.key,a),a},"applyCustomEffect");Hooks.on("applyActiveEffect",(o,e)=>sn(o,e));var at=class extends Hotbar{async collapse(){return this._collapsed?!0:($(this.element).addClass("collapsedHotbar"),super.collapse())}async expand(){return this._collapsed?($(this.element).removeClass("collapsedHotbar"),super.expand()):!0}};m(at,"DSKHotbar");var{getProperty:ia}=foundry.utils,it=class extends Dialog{constructor(e,t,s,a=""){let i={title:e,content:t,buttons:{initialize:{label:game.i18n.localize("dsk.initialize"),callback:async()=>{this.lock||await this.initialize()}},cancel:{label:game.i18n.localize("dsk.cancel"),callback:async()=>{this.lock||await this.dontInitialize()}}}};super(i),this.module=s,this.lang=a,this.folders={},this.journals={},this.scenes={},this.actors={},this.lock=!1}async initialize(){this.lock=!0;let e=$(this._element).find(".initialize");e.prepend('<i class="fas fa-spinner fa-spin"></i>');let t={};try{game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0)}catch{}try{await fetch(`modules/${this.module}/adventure${this.lang}.json`).then(async s=>s.json()).then(async s=>{t=s})}catch{try{await fetch(`modules/${this.module}/adventure.json`).then(async s=>s.json()).then(async s=>{t=s})}catch{console.warn(`Could not find book data for ${this.module} import.`)}}await fetch(`modules/${this.module}/initialization${this.lang}.json`).then(async s=>s.json()).then(async s=>{let a=s.folders;if(a){let i=await this.getFolderForType("JournalEntry"),n=s.folders[0].name;i&&(this.folders[i.data.name]=i,s.folders.shift());let r=await Folder.create(a);Array.isArray(r)||(r=[r]);for(let c of r)this.folders[c.data.name]=c;let l=[];for(let c in this.folders){let u=this.folders[c].getFlag("dsk","parent"),d=u==n?game.i18n.localize(`${this.module}.name`):u;d&&l.push({_id:this.folders[c].id,parent:this.folders[d].id})}await Folder.updateDocuments(l)}if(s.items){let i=await this.getFolderForType("Item"),n=[],r=[];for(let l of s.items){l.folder=i.id;let c=game.items.find(u=>u.name==l.name&&u.folder?.id==i.id);c?(l._id=c.id,r.push(l)):n.push(l)}await C.create(n),await C.updateDocuments(r)}if(s.playlists){let i=await this.getFolderForType("Playlist"),n=[],r=[],c=(await game.packs.get(s.playlists).getDocuments()).map(u=>u.toObject());for(let u of c){u.folder=i.id;let d=game.playlists.find(f=>f.name==u.name&&f.folder?.id==i.id);d?(u._id=d._id,r.push(u)):n.push(u)}await Playlist.create(n,{keepId:!0}),await Playlist.updateDocuments(r)}if(s.scenes){let i=await this.getFolderForType("Scene"),r=(await game.packs.get(s.scenes).getDocuments()).map(g=>g.toObject()),c=(await game.packs.get(s.journal).getDocuments()).map(g=>g.toObject()),u=await this.getFolderForType("JournalEntry"),d=[],f=[],p=new Map,b=!1;for(let g of r){let y=b,v=game.scenes.find(k=>k.name==g.name&&k.folder?.id==i.id);if(!b&&v&&([y,b]=await new Promise((k,I)=>{new Dialog({title:game.i18n.localize("dsk.Book.sceneReset"),content:game.i18n.format("dsk.Book.sceneResetDescription",{name:g.name}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{k([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.LocalizedIDs.all"),callback:()=>{k([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{k([!1,!1])}}},close:()=>{k([!1,!1])}}).render(!0)})),v&&!y){this.scenes[v.name]=v;continue}g.folder=i.id;for(let k of g.notes)try{let I=c.find(B=>B.flags.dsk.initId==k.entryId);if(!p.has(I._id)){let B=ia(I,"flags.dsk.parent"),S=u;this.folders[B]?S=this.folders[B]:B&&(S=await this.getFolderForType("JournalEntry",u.id,B,0,ia(I,"flags.dsk.foldercolor")||"")),I.folder=S.id;let G=game.journal.find(ot=>ot.name==I.name&&ot.folder?.id==S.id&&ot.flags.dsk.initId==k.entryId);if(G)await G.update(I),p.set(I._id,G.id);else{let ot=await JournalEntry.create(I);p.set(I._id,ot.id)}}k.entryId=p.get(I._id)}catch(I){console.warn(`Could not initialize Scene Notes for scene :${g.name}`+I)}v?(g._id=v.id,f.push(g)):d.push(g)}let T=await Scene.create(d,{dskInit:!0});for(let g of T){this.scenes[g.name]=g;let y=await g.createThumbnail();await g.update({thumb:y.thumb},{diff:!1})}for(let g of f)await game.scenes.get(g._id).update(g),this.scenes[g.name]=game.scenes.get(g._id);if(s.initialScene){let g=this.scenes[s.initialScene];await game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0),await g.activate(),await g.update({navigation:!0})}}if(s.actors){let i=await this.getFolderForType("Actor"),r=(await game.packs.get(s.actors).getDocuments()).map(p=>p.toObject()),l=[],c=[],u=new Map,d=0;if(ia(t,"chapters")){for(let p of t.chapters)for(let b of p.content)if(b.actors){let T=!1;for(let g of b.actors)u.has(g)||(u.set(g,b.name),T=!0);T&&(await this.getFolderForType("Actor",i.id,b.name,d),d+=1)}}for(let p of r){let b=u.has(p.name)?await this.getFolderForType("Actor",i.id,u.get(p.name)):i;p.folder=b.id,p._id&&delete p._id;let T=game.actors.find(g=>g.name==p.name&&[i.id,b.id].includes(g.folder?.id));T?(p._id=T.id,await T.deleteEmbeddedDocuments("Item",T.items.map(g=>g.id)),c.push(p)):l.push(p)}let f=await Actor.create(l);await Actor.updateDocuments(c);for(let p of f)this.actors[p.name]=p}}),this.lock=!1,e.find("i").remove(),ui.notifications.notify(game.i18n.localize("dsk.initComplete")),await this.close()}async dontInitialize(){game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0),ui.notifications.notify(game.i18n.localize("dsk.initSkipped")),await this.close()}submit(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(t){throw ui.notifications.error(t),new Error(t)}}async getFolderForType(e,t=null,s=null,a=0,i=""){return s||(s=game.i18n.localize(`${this.module}.name`)),h.getFolderForType(e,t,s,a,i)}};m(it,"DSKInitializer");var{setProperty:an,getProperty:nn}=foundry.utils,ke=class{constructor(){this.tokens={},this.actors={}}static get wantedKeys(){let e=[];return game.settings.get("dsk","enableDPS")||e.push("distance"),e}getPath(e,t,s){let a=s||"",i=t._id||t.type;return e.token?`tokens.${e.token||e.actor}.${i}${a}`:`actors.${e.actor}.${i}${a}`}remember(e,t,s,a){let i=this.formDataSerialize(a);Object.entries(i).length>0&&an(this,this.getPath(e,t,s),i)}recall(e,t,s){return nn(this,this.getPath(e,t,s))}formDataSerialize(e){let t=e.find("form"),s={};return t.find("select").each(function(){let a=$(this).attr("name");ke.wantedKeys.includes(a)&&(s[a]=$(this).val())}),t.find('input[type="checkbox"]').each(function(){let a=$(this).attr("name");ke.wantedKeys.includes(a)&&(s[a]=this.checked)}),t.find(".specAbs.active").each(function(){s.specAbs||(s.specAbs=[]),s.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})}),e.find('[name="situationalModifiers"] option').each(function(){s.situationalModifiers||(s.situationalModifiers=[]),s.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})}),s}};m(ke,"RollMemory");var nt=class{static requestRoll(e,t=0){ae.showRQMessage(e,t)}static rollCh(e,t={}){H.check3D20(void 0,e,t)}static itemMacroById(e,t,s,a){let i=game.actors.get(e),n=i?i.items.find(r=>r.name===t&&r.type==s):null;this.runItem(i,n,t,a)}static itemMacro(e,t,s){let a=ChatMessage.getSpeaker(),i;a.token&&(i=game.actors.tokens[a.token]),i||(i=game.actors.get(a.actor));let n=i?i.items.find(r=>r.name===e&&r.type==t):null;this.runItem(i,n,e,s,a.token)}static runItem(e,t,s,a,i){if(!e)return ui.notifications.error(game.i18n.format("dsk.DSKError.MacroItemMissing",{item:s}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,a.mod,a,i).then(n=>{e.basicTest(n)});case"rangeweapon":return e.setupWeapon(t,"attack",a,i).then(n=>{e.basicTest(n)});case"skill":return e.setupSkill(t,a,i).then(n=>{e.basicTest(n)});case"ahnengabe":return e.setupSpell(t,a,i).then(n=>{e.basicTest(n)})}}};m(nt,"MacroDSK");var rt=class extends Pause{static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsk/templates/system/pause.html",e}};m(rt,"DSKPause");Hooks.once("init",()=>{console.log("Initializing DSK system"),CONFIG.statusEffects=w.statusEffects,game.dsk={apps:{DSKUtility:h,DSKInitializer:it,DSKChatListeners:H,SpecialabilityRulesDSK:z,AdvantageRulesDSK:E,Migrakel:ve,DPS:X,DiceDSK:_DiceDSK,DSKStatusEffects:x},documents:{ActorDSK:D,ItemDSK:C},sheets:{ActorSheetDSK:de,ItemSheetDSK:L,ActorSheetCreature:me,ActorSheetCharacter:oe,ActorSheetNPC:ue},config:w,macro:nt,memory:new ke,itemLibrary:new st},CONFIG.Actor.documentClass=D,CONFIG.Item.documentClass=C,CONFIG.ActiveEffect.documentClass=Ie,CONFIG.ui.combat=le,CONFIG.ui.hotbar=at,CONFIG.ui.pause=rt,CONFIG.Combat.documentClass=pt,CONFIG.Combatant.documentClass=gt,CONFIG.ActiveEffect.documentClass=Ie,CONFIG.ChatMessage.template="systems/dsk/templates/chat/chat-message.html",CONFIG.ActiveEffect.legacyTransferral=!1});si();
